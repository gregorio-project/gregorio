%GregorioTeX main file.
%
% Copyright (C) 2007-2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

\ifluatex%
  \ifnum\luatexversion<76%
    \gre@error{Error: this document must be compiled with LuaTeX (lualatex) 0.76 or later}%
  \fi%
\else%
  \gre@error{Error: this document must be compiled with LuaTeX (lualatex)}%
\fi%

\def\gre@debugmsg#1#2{%
  \IfStrEq{\gre@debug}{}{}%
    %false
    {\IfStrEq{#1}{all}%
      %true
      {\gre@error{Debug error: ‘all’ is not a permitted keyword}}%
      %false
      {\IfStrEq{\gre@debug}{all}%
        %true
        {\gre@typeout{GregorioTeX debug: (#1) #2}}%
        %false
        {\IfSubStr{\gre@debug}{#1}%
          %true
          {\gre@typeout{GregorioTeX debug: (#1) #2}}%
          %false
          {\relax}%
        }%
      }%
    }%
}%

% Macro to handle deprecated macros.
% #1 - the deprecated macro
% #2 - the correct macro to use
\def\gre@deprecated#1#2{%
  \ifgre@allowdeprecated%
    \gre@warning{#1\space is deprecated.\MessageBreak Use #2\space instead}%
  \else%
    \gre@error{#1\space is deprecated.\MessageBreak Use #2\space instead}%
  \fi%
  \relax%
}%

\def\gre@obsolete#1#2{%
  \gre@error{#1\space is obsolete.\MessageBreak Use #2\space instead}%
  \relax%
}%


\def\gre@nothing{}

\AtBeginDocument{\IfStrEq{\gre@debug}{}{}{\typeout{GregorioTeX is in debug mode}\typeout{\gre@debug\space messages will be printed to the log.}}}%

% Depending on version of TeX / LaTeX, some primitives may or may not have a
% luatex prefix, so we need to check and handle either

\ifdefined\localleftbox%
  \let\gre@localleftbox\localleftbox%
\else%
  \let\gre@localleftbox\luatexlocalleftbox%
\fi%
\ifdefined\localrightbox%
  \let\gre@localrightbox\localrightbox%
\else%
  \let\gre@localrightbox\luatexlocalrightbox%
\fi%
% an attribute we put on the text nodes.
% if it is 1, it means that there may be a dash here if this syllable is at the end of a line
% if it is 2, it means that it's never useful to typeset a dash
% if it is 0, it just means that we are in a score...
\newluatexattribute\gre@attr@dash%

% an attribute used for translation centering
\newluatexattribute\gre@attr@center%

\newluatexattribute\GreScoreId %

% attributes for tracking glyph heights
\newluatexattribute\gre@attr@glyph@id %
\newluatexattribute\gre@attr@glyph@top %
\newluatexattribute\gre@attr@glyph@bottom %

\newluatexcatcodetable\gre@atletter %
\setluatexcatcodetable\gre@atletter{%
  \catcode`\@=11 %
}%

% The version of gregorio. All gregoriotex*.tex files must have the same.
% All gtex files must also have the same version.
\xdef\gre@gregorioversion{4.0.1}% GREGORIO_VERSION - VersionManager.py

% first some macros to allow checks for version:
% Tests that all gregoriotex files are of the same version.
% #1 is the name of the file
% #2 is the version

\def\gre@declarefileversion#1#2{%
  \IfStrEq*{#2}{\gre@gregorioversion}{}{%else
    \gre@error{uncoherent file versions: gregoriotex-main.tex is in version \number\gre@gregorioversion \space\space while #1 is in version \number#2}}%
}%

% Macro called by scores.
% Tests the major version of gregorio (X.0.0) against the score. Fails
% if the major version (X) does not match.
% #1 is the version of GregorioTeX the score is made for.

\def\GregorioTeXAPIVersion#1{%
  \StrBefore{\gre@gregorioversion}{.}[\gre@gregoriomajorversion]%
  \IfBeginWith{#1}{\gre@gregoriomajorversion}{\relax}{%else
    \gre@error{GregorioTeX is in version \gre@gregorioversion \space\space while a score you included requires version #1. Please recompile your scores}}%
}%

\RequireLuaModule{gregoriotex}%
\ifcsname greskipheightcomputation\endcsname %
  \directlua{gregoriotex.init(arg, false)}%
\else %
  \directlua{gregoriotex.init(arg, true)}%
\fi %

\xdef\gre@gregoriotexluaversion{\directlua{tex.write(gregoriotex.get_gregorioversion())}}%

% Test to make sure that gregoriotex.lua is of the same version.
\IfStrEq*{\gre@gregoriotexluaversion}{\gre@gregorioversion}{}{%else
    \gre@error{uncoherent file versions: gregoriotex-main.tex is in version \number\gre@gregorioversion \space\space while gregoriotex.lua is in version \gre@gregoriotexluaversion}}%


%%%%%%%%%%%%%%%%%%%%%%%%
%% aux file definitions
%%%%%%%%%%%%%%%%%%%%%%%%

% for now, we only use an aux file with LuaTeX

\ifluatex%
  \newwrite\gre@gaux%
\fi%

\def\gre@write@gaux#1{%
  \write\gre@gaux{#1}%
  \relax %
}%

\def\gre@open@gaux{%
  \openout\gre@gaux \jobname .gaux\relax%
}%

\def\gre@close@gaux{%
  \closeout\gre@gaux %
}%


%%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%%

\def\gre@pitch@a{3}%
\def\gre@pitch@b{4}%
\def\gre@pitch@c{5}%
\def\gre@pitch@d{6}%
\def\gre@pitch@e{7}%
\def\gre@pitch@f{8}%
\def\gre@pitch@g{9}%
\def\gre@pitch@h{10}%
\def\gre@pitch@i{11}%
\def\gre@pitch@j{12}%
\def\gre@pitch@k{13}%
\def\gre@pitch@l{14}%
\def\gre@pitch@m{15}%
\def\gre@pitch@n{16}%
\def\gre@pitch@p{17}%

\let\gre@pitch@adjust@bottom\gre@pitch@c %
\let\gre@pitch@belowstaff\gre@pitch@c %
\let\gre@pitch@ledger@below\gre@pitch@b %
\let\gre@pitch@barvepisema\gre@pitch@c %
\let\gre@pitch@underbrace\gre@pitch@b %
\let\gre@pitch@overbraceglyph\gre@pitch@g %
\let\gre@pitch@bar\gre@pitch@g %
\let\gre@pitch@dummy\gre@pitch@g %

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
% it is set to the default value : 17 (the value that makes it look like a standard graduale)
\newcount\gre@factor%
\gre@factor=17%

%%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%%

\input gregoriotex-spaces.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for additionnal vertical spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% macro called to go to the next line
\def\GreNewLine{%
  \gre@debugmsg{lineheight}{GreNewLine}%
  \gre@newlinecommon{0}%
  \relax%
}%

% basically same as above, but this one does a \hfill, so the lines are not justified
\def\GreNewParLine{%
  \gre@debugmsg{lineheight}{GreNewParLine}%
  \gre@newlinecommon{1}%
  \relax%
}%

% the macro we call each time we force a changing of line, it automatically sets \gre@knownline, and adjusts left spaces
\def\gre@newlinecommon#1{%
  \ifgre@blockeolcustos\ifnum\gre@insidediscretionary=0\relax %
     \gre@localrightbox{}%
  \fi\fi %
  \ifgre@boxing\else%
    \ifnum\gre@biginitial=1\relax %
      \ifcase\gre@knownline %
      % 0: should not happend...
      \or % 1
        \gre@adjustsecondline %
      \or %2
        \gre@adjustthirdline %
      \fi %
    \fi %
    \global\advance\gre@knownline by 1\relax %
    \global\gre@lastoflinecount=2\relax %
    % we have to repeat the end of syllable shifts here because the manual line breaks will occur before we get to the regular shifting code in \GreSyllable
    \ifdim\gre@dimen@enddifference <0pt\relax%
      %% important, else we are not really at the end of the syllable
      \kern -\gre@dimen@enddifference\relax%
    \fi%
    \ifgre@eolshiftsenabled%
      \GreNoBreak% we want to make sure this shift doesn't get separated from the previous one if both occur
      \gre@calculate@eolshift{\gre@dimen@enddifference}%
      \gre@debugmsg{eolshift}{Manual end of line shift: \the\gre@dimen@eolshift}%
      \kern -\gre@dimen@eolshift\relax%
    \fi%
    \ifnum\gre@insidediscretionary=0\relax %
      \gre@updateleftbox %
    \fi %
    \ifnum#1=1\relax %
      \hfill %
    \fi %
    \gre@penalty{-10001}%
  \fi %
  \gre@adjustlineifnecessary\relax %
}%

\def\gre@mark@translation{\directlua{gregoriotex.mark_translation()}}%
\def\gre@mark@abovelinestext{\directlua{gregoriotex.mark_abovelinestext()}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% macro that sets \gre@dimen@temp@three to the width of its argument

\newbox\gre@box@temp@width%

\def\gre@widthof#1{%
  \setbox\gre@box@temp@width=\hbox{#1}%
  \global\gre@dimen@temp@three=\wd\gre@box@temp@width%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\gre@box@initial%


% gre@biginitial means that the inital takes two lines
\newcount\gre@biginitial%

% gre@knownline is the line we think we are in
\newcount\gre@knownline%

% macro to call before the call of \initial
\def\gre@setbiginitial{%
  \gre@debugmsg{general}{setting BIG initial}%
  \global\gre@biginitial=1\relax %
  \relax %
}%

% macro to cancel before the call of \initial
\def\gre@normalinitial{%
  \gre@debugmsg{general}{setting normal initial}%
  \global\gre@biginitial=0\relax %
  \relax %
}%

% macro to call before the first syllable, but after setinitialclef
\def\gre@adjustsecondline{%
  \gre@dimen@additionalleftspace=\gre@dimen@initialwidth\relax%
  \gre@updateleftbox %
  \relax %
}%

% macro to call during the second line
\def\gre@adjustthirdline{%
  \gre@dimen@additionalleftspace= 0 pt\relax%
  \gre@updateleftbox %
  \relax %
}%

\newif\ifgre@thirdlineadjustmentnecessary %
\def\gre@adjustlineifnecessary{%
  \ifgre@thirdlineadjustmentnecessary %
    \gre@adjustthirdline %
    \gre@thirdlineadjustmentnecessaryfalse %
  \fi %
}%

\def\gre@updateleftbox{%
  \gre@updatelinewidth %
  \gre@updatelinesclef %
}%

\def\gre@updatelinewidth{%
  \gre@debugmsg{ifdim}{ additionalleftspace = 0pt}%
  \ifdim\gre@dimen@additionalleftspace=0pt\relax%
  \else %
    \gre@dimen@temp@five=\gre@dimen@stafflinewidth\relax%
    \global\advance\gre@dimen@stafflinewidth by -\gre@dimen@additionalleftspace\relax%
    \gre@generatelines %
    \global\gre@dimen@stafflinewidth=\gre@dimen@temp@five %
  \fi %
}%

\def\greillumination#1{%
  \setbox\gre@box@initial=\hbox{#1}%
}%

\def\gre@setinitial#1{%
  \gre@debugmsg{commentary}{Time to calculate the true raise.}%
  \gre@calculate@commentarytrueraise%
  % we start by printing the commentary
  % when doing this we place it inside a box as which is linewidth wide with an \hfill before to get it to align to the right of the page
  % we then place that box inside one of 0 width so that our cursor doesn't move when we place the commentary
  \raise\gre@dimen@commentarytrueraise\hbox to 0pt{\hbox to \gre@dimen@linewidth{\hfill\box\gre@box@commentary}}%
  % see comments on this function to see what it does
  \gre@debugmsg{annotation}{Time to calculate the true raise.}%
  \gre@calculate@annotationtrueraise %
  % we print the initial always at the same place, and then we print the gre@box@annotation, centered
  % first we print the initial
  \gre@dimen@temp@five = \gre@dimen@textlower\relax%
  \advance\gre@dimen@temp@five by \gre@dimen@initialraise\relax%
  % if it is a big initial we print it on the second line
  \ifnum\gre@biginitial=0\relax %
    \ifvoid\gre@box@initial%
      \gre@debugmsg{initial}{Fill initial box a}%
      \setbox\gre@box@initial=\hbox{\gre@style@initial#1\endgre@style@initial}%
    \fi%
    \ifx\gre@empty@initialformat\greinitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\greinitialformat}{\protect\grechangestyle{initial}}%  OBSOLETE
    \fi%  OBSOLETE
    \gre@debugmsg{ifdim}{ manualinitialwidth = 0pt}%
    \ifdim\gre@dimen@manualinitialwidth=0 pt\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@initial %
    \else%
      \gre@style@initial%
      \global\gre@dimen@initialwidth=\gre@dimen@manualinitialwidth\relax%
      \endgre@style@initial%
      \ifx\gre@empty@initialformat\greinitialformat% OBSOLETE
      \else%  OBSOLETE
        \gre@obsolete{\protect\greinitialformat}{\protect\grechangestyle{initial}}%  OBSOLETE
      \fi%  OBSOLETE
    \fi%
    \gre@debugmsg{ifdim}{ wd(gre@box@annotation) > initialwidth}%
    \ifdim\wd\gre@box@annotation>\gre@dimen@initialwidth\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@annotation%
    \fi%
    \gre@debugmsg{annotation}{Width check completed.}%
    \setbox\gre@box@initial=\hbox to \gre@dimen@initialwidth {\hss\raise \gre@dimen@temp@five\box\gre@box@initial\hss}%
    \gre@debugmsg{annotation}{Initial set.}%
    \gre@style@initial%
    \global\gre@dimen@temp@four = \gre@dimen@beforeinitialshift\relax%
    \endgre@style@initial%
    \ifx\gre@empty@initialformat\greinitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\greinitialformat}{\protect\grechangestyle{initial}}%  OBSOLETE
    \fi%  OBSOLETE
  \else %
    \ifgre@allowdeprecated%%% DEPRECATED for removal in 5.0
      \gre@warning{biginitial style is deprecated, but the old\MessageBreak behavior will be used since deprecated usage is\MessageBreak currently enabled. This behavior will disappear\MessageBreak in 5.0, so consider disabling deprecated usage\MessageBreak and switching to the initial style instead. (See\MessageBreak UPGRADE.md for more information)}%%% DEPRECATED for removal in 5.0
    \fi%%% DEPRECATED for removal in 5.0
    \advance\gre@dimen@temp@five by -\gre@dimen@additionalbottomspace\relax%
    \advance\gre@dimen@temp@five by -\gre@dimen@spacebeneathtext\relax%
    \advance\gre@dimen@temp@five by -\gre@dimen@spacelinestext\relax%
    \advance\gre@dimen@temp@five by -4\gre@dimen@interstafflinespace\relax%
    \advance\gre@dimen@temp@five by -4\gre@dimen@stafflineheight\relax%
    \advance\gre@dimen@temp@five by -\gre@dimen@currenttranslationheight\relax%
    \advance\gre@dimen@temp@five by -\f@size pt%
    \advance\gre@dimen@temp@five by \gre@dimen@initialraise\relax%
    \ifvoid\gre@box@initial%
      \gre@debugmsg{initial}{fill big initial box}%
      \ifgre@allowdeprecated%%% DEPRECATED for removal in 5.0
        \setbox\gre@box@initial=\hbox{\gre@style@biginitial#1\endgre@style@biginitial}% DEPRECATED for removal in 5.0
      \else%%% DEPRECATED for removal in 5.0
        \setbox\gre@box@initial=\hbox{\gre@style@initial#1\endgre@style@initial}% keep this line
      \fi%%% DEPRECATED for removal in 5.0
    \fi%
    \ifx\gre@empty@biginitialformat\grebiginitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\grebiginitialformat}{\protect\grechangestyle{biginitial}}%  OBSOLETE
    \fi%  OBSOLETE
    \gre@debugmsg{ifdim}{ manualinitialwidth = 0pt}%
    \ifdim\gre@dimen@manualinitialwidth=0 pt\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@initial %
    \else%
      \ifgre@allowdeprecated%%% DEPRECATED for removal in 5.0
        \gre@style@biginitial%%% DEPRECATED for removal in 5.0
        \global\gre@dimen@initialwidth=\gre@dimen@manualinitialwidth\relax%%% DEPRECATED for removal in 5.0
        \endgre@style@biginitial%%% DEPRECATED for removal in 5.0
      \else%%% DEPRECATED for removal in 5.0
        \gre@style@initial% keep this line
        \global\gre@dimen@initialwidth=\gre@dimen@manualinitialwidth\relax% keep this line
        \endgre@style@initial% keep this line
      \fi%%% DEPRECATED for removal in 5.0
      \ifx\gre@empty@biginitialformat\grebiginitialformat% OBSOLETE
      \else%  OBSOLETE
        \gre@obsolete{\protect\grebiginitialformat}{\protect\grechangestyle{biginitial}}%  OBSOLETE
      \fi%  OBSOLETE
    \fi%
    \gre@debugmsg{ifdim}{ wd(GreAboveinitialfirstbox) > initialwidth}%
    \ifdim\wd\gre@box@annotation>\gre@dimen@initialwidth\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@annotation%
    \fi%
    \setbox\gre@box@initial=\hbox{\vtop to 0pt{\hbox to \gre@dimen@initialwidth {\hss\raise \gre@dimen@temp@five\box\gre@box@initial\hss}\vss}}%
    \ifgre@allowdeprecated%%% DEPRECATED for removal in 5.0
      \gre@style@biginitial%%% DEPRECATED for removal in 5.0
      \global\gre@dimen@temp@four = \gre@dimen@beforeinitialshift\relax%%% DEPRECATED for removal in 5.0
      \endgre@style@biginitial%%% DEPRECATED for removal in 5.0
    \else%%% DEPRECATED for removal in 5.0
      \gre@style@initial% keep this line
      \global\gre@dimen@temp@four = \gre@dimen@beforeinitialshift\relax% keep this line
      \endgre@style@initial% keep this line
    \fi%%% DEPRECATED for removal in 5.0
    \ifx\gre@empty@biginitialformat\grebiginitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\grebiginitialformat}{\protect\grechangestyle{biginitial}}%  OBSOLETE
    \fi%  OBSOLETE
  \fi %
  \hskip\gre@dimen@temp@four %
  \global\advance\gre@dimen@initialwidth by \gre@dimen@temp@four %
  \gre@debugmsg{annotation}{Ready to place initial.}%
  \box\gre@box@initial%
  \ifnum\gre@biginitial=0\relax%
    \gre@style@initial%
    \global\gre@dimen@temp@four = \gre@dimen@afterinitialshift\relax%
    \endgre@style@initial%
    \ifx\gre@empty@initialformat\greinitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\greinitialformat}{\protect\grechangestyle{initial}}%  OBSOLETE
    \fi%  OBSOLETE
  \else%
    \ifgre@allowdeprecated%%% DEPRECATED for removal in 5.0
      \gre@style@biginitial%%% DEPRECATED for removal in 5.0
      \global\gre@dimen@temp@four = \gre@dimen@afterinitialshift\relax%%% DEPRECATED for removal in 5.0
      \endgre@style@biginitial%%% DEPRECATED for removal in 5.0
    \else%%% DEPRECATED for removal in 5.0
      \gre@style@initial% keep this line
      \global\gre@dimen@temp@four = \gre@dimen@afterinitialshift\relax% keep this line
      \endgre@style@initial% keep this line
    \fi%%% DEPRECATED for removal in 5.0
    \ifx\gre@empty@biginitialformat\grebiginitialformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\grebiginitialformat}{\protect\grechangestyle{biginitial}}%  OBSOLETE
    \fi%  OBSOLETE
  \fi%
  \hskip\gre@dimen@temp@four %
  \global\advance\gre@dimen@initialwidth by \gre@dimen@temp@four%
  % then we center the first box above the initial, if there is one
  \gre@debugmsg{annotation}{Time to set the annotation.}%
  \ifvoid\gre@box@annotation\relax%
    \gre@debugmsg{annotation}{There is no annotation.}%
  \else %
    \gre@debugmsg{annotation}{Calculate horizontal position.}%
    \gre@dimen@temp@five=\gre@dimen@initialwidth\relax%
    \advance\gre@dimen@temp@five by -\wd\gre@box@annotation%
    \divide\gre@dimen@temp@five by 2 %
    \gre@skip@temp@four = -\gre@dimen@initialwidth\relax%
    \hskip\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
    \gre@debugmsg{annotation}{And place the annotation.}%
    \raise\gre@dimen@annotationtrueraise\box\gre@box@annotation%
    \gre@debugmsg{annotation}{Move to beginning of staff.}%
    \kern\gre@dimen@temp@five %
  \fi %
  \relax %
}%

\def\gre@noinitial{%
  \setbox\gre@box@initial=\box\voidb@x%
  \global\gre@dimen@initialwidth=0pt\relax%
  \relax %
}%



\newbox\gre@box@annotation%
\newbox\gre@box@add%
\newbox\gre@box@old%

\def\greannotation{\@ifnextchar[{\gre@annotation}{\gre@annotation[c]}}%

%This flag controls whether the annotation control line is the top line (false) or the bottom line (true)
\newif\ifgre@annotationbottomline%
\gre@annotationbottomlinefalse%

\def\gresetannotationby#1{%
  \IfStrEq{#1}{topline}%
    {\gre@annotationbottomlinefalse}%
    {\IfStrEq{#1}{bottomline}%
      {\gre@annotationbottomlinetrue}%
      {\gre@error{Unrecognized option for \protect\gresetannotationby}}%
    }%
}%

% This flag controls whether the top (0), baseline (1), or bottom (2) of the control line is aligned with the top line of the staff before applying annotationraise.
\newcount\gre@count@annotationvalign%
\gre@count@annotationvalign=1%

\def\gresetannotationvalign#1{%
  \IfStrEq{#1}{top}%
    {\gre@count@annotationvalign=0}%
    {\IfStrEq{#1}{baseline}%
      {\gre@count@annotationvalign=1}%
      {\IfStrEq{#1}{bottom}%
        {\gre@count@annotationvalign=2}%
        {\gre@error{Unrecognized option for \protect\gresetannotationvalign}}%
      }%
    }%
}%

\def\gre@annotation[#1]#2{%
  \ifx l#1\relax%
    \let\gre@rightfill\hfil%
    \let\gre@leftfill\relax%
  \else\ifx r#1\relax%
    \let\gre@rightfill\relax%
    \let\gre@leftfill\hfil%
  \else\ifx c#1\relax%
    \let\gre@rightfill\hfil%
    \let\gre@leftfill\hfil%
  \else%
    \gre@error{Unrecognzied alignment option for \protect\greannotation}%
  \fi\fi\fi%
  % first we determine the widest box
  \gre@widthof{#2}%
  \ifdim\gre@dimen@temp@three < \wd\gre@box@annotation\relax%
    \gre@dimen@temp@three = \wd\gre@box@annotation\relax%
  \fi%
  \ifvoid\gre@box@annotation%
    \gre@debugmsg{annotation}{We're on the first line of the annotation.}%
    \setbox\gre@box@annotation = \hbox to \gre@dimen@temp@three{\gre@leftfill#2\gre@rightfill}%
    % We set the initial value for annotationtrueraise based on the annotationvalign setting.  We always do this because if there is only one line in the annotation, then the topline is the bottomline.
    \gre@debugmsg{annnotation}{Initial set point.}%
    \ifcase\gre@count@annotationvalign\relax%
    %case 0 = top of first line
      \global\gre@dimen@annotationtrueraise=-\ht\gre@box@annotation\relax%
      \gre@debugmsg{annotation}{Aligning to top of first line: \the\gre@dimen@annotationtrueraise}%
    \or %case 1 = baseline of first line
      \global\gre@dimen@annotationtrueraise= 0pt\relax%
      \gre@debugmsg{annotation}{Aligning to baseline of first line: \the\gre@dimen@annotationtrueraise}%
    \or %case 2 = bottom of first line
      \global\gre@dimen@annotationtrueraise=\dp\gre@box@annotation\relax%
      \gre@debugmsg{annotation}{Aligning to bottom of first line: \the\gre@dimen@annotationtrueraise}%
    \else% Bug
      \gre@bug{Invalid value for \protect\gre@count@annotationvalign}%
    \fi%
  \else%
    \gre@debugmsg{annotation}{We're not on the first line of the annotation.}%
    \setbox\gre@box@old = \hbox to \gre@dimen@temp@three{\gre@leftfill\box\gre@box@annotation\gre@rightfill}%
    \setbox\gre@box@add = \hbox to \gre@dimen@temp@three{\gre@leftfill#2\gre@rightfill}%
    % if the user has asked for the bottom line to be the controlling line, then we need to change the value of the annotationtrueraise appropriately
    \ifgre@annotationbottomline%
      \ifcase\gre@count@annotationvalign\relax%
        %case 0 = top of first line
        \global\gre@dimen@annotationtrueraise=\dimexpr\ht\gre@box@old+\dp\gre@box@old+\gre@dimen@annotationseparation-\ht\gre@box@add\relax%
        \gre@debugmsg{annotation}{Aligning to top of last line: \the\gre@dimen@annotationtrueraise}%
      \or %case 1 = baseline of first line
        \global\gre@dimen@annotationtrueraise=\dimexpr\ht\gre@box@old+\dp\gre@box@old+\gre@dimen@annotationseparation\relax%
        \gre@debugmsg{annotation}{Aligning to baseline of last line: \the\gre@dimen@annotationtrueraise}%
      \or %case 2 = bottom of first line
        \global\gre@dimen@annotationtrueraise=\dimexpr\ht\gre@box@old+\dp\gre@box@old+\gre@dimen@annotationseparation+\dp\gre@box@add\relax%
        \gre@debugmsg{annotation}{Aligning to bottom of last line: \the\gre@dimen@annotationtrueraise}%
      \else% Bug
        \gre@bug{Invalid value for \protect\gre@count@annotationvalign}%
      \fi%
    \fi%
    \setbox\gre@box@annotation = \vtop spread \gre@dimen@annotationseparation\relax {\offinterlineskip\box\gre@box@old\vss\box\gre@box@add}%
  \fi%
}%


\def\gresetfirstlineaboveinitial#1#2{%
  \gre@obsolete{\protect\gresetfirstlineaboveinitial}{\protect\greannotation}%
}%

\def\gresetfirstannotation#1{%
  \gre@obsolete{\protect\gresetfirstannotation}{\protect\greannotation}%
}%

\let\setfirstannotation\gresetfirstannotation%

\def\gresetsecondannotation#1{%
  \gre@obsolete{\protect\gresetsecondannotation}{\protect\greannotation}%
}%

\let\setsecondannotation\gresetsecondannotation%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the score reference (unused)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grescorereference#1{%
  \relax %
}%

\def\GreScoreReference#1{%
  \gre@obsolete{\protect\GreScoreReference}{\protect\grescorereference}%
}%

\def\scorereference#1{%
  \gre@obsolete{\protect\scorereference}{\protect\grescorereference}%
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\gre@writemode#1#2{%
  \greannotation{%
    \gre@style@modeline #1\endgre@style@modeline\space\gre@style@modemodifier #2\unskip\endgre@style@modemodifier\relax %
  }%
  \relax %
}%

\def\GreMode#1#2{%
  \ifvoid\gre@box@annotation%
    \ifcase#1%
    \or%
      \gre@writemode{I}{#2}%
    \or%
      \gre@writemode{II}{#2}%
    \or%
      \gre@writemode{III}{#2}%
    \or%
      \gre@writemode{IV}{#2}%
    \or%
      \gre@writemode{V}{#2}%
    \or%
      \gre@writemode{VI}{#2}%
    \or%
      \gre@writemode{VII}{#2}%
    \or%
      \gre@writemode{VIII}{#2}%
    \fi%
  \fi%
  \relax%
}%

\def\GreAnnotationLines#1#2{%
  \ifvoid\gre@box@annotation%
    \greannotation{#1}%
    \greannotation{#2}%
  \fi%
  \relax%
}%

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\gre@beginnotes{%
  \gre@drawfirstlines %
  %%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
  \gre@localleftbox{%
    \copy\gre@box@lines %
  }%
  \relax %
}%

\newbox\gre@box@commentary

\def\grecommentary#1{%
  \ifvoid\gre@box@commentary%
    \setbox\gre@box@commentary = \hbox{#1}%
  \else%
    \gre@widthof{#1}%
    \ifdim\gre@dimen@temp@three < \wd\gre@box@commentary\relax%
      \gre@dimen@temp@three = \wd\gre@box@commentary%
    \fi%
    \setbox\gre@box@old = \hbox to \gre@dimen@temp@three{\hfill\box\gre@box@commentary}%
    \setbox\gre@box@add = \hbox to \gre@dimen@temp@three{\hfill#1}%
    \setbox\gre@box@commentary = \vbox spread \gre@dimen@commentaryseparation{\offinterlineskip\box\gre@box@old\vss\box\gre@box@add}%
  \fi%
}

\def\commentary#1{%
  \gre@obsolete{\protect\commentary}{\protect\grecommentary}%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macro for putting text above lines for annotations and the like
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% format for text above the lines
\def\greabovelinestextstyle#1{% OBSOLETE
  \relax %
}%
\let\gre@empty@abovelinestextstyle\greabovelinestextstyle%

% set space above the text lines - almost the same as for the translation
\def\gre@addspaceabove{%
  \gre@style@abovelinestext%
  \global\gre@dimen@currentabovelinestextheight=\gre@dimen@abovelinestextheight\relax%
  \gre@generatelines %
  \endgre@style@abovelinestext%
  \ifx\gre@empty@abovelinestextstyle\greabovelinestextstyle% OBSOLETE
  \else%  OBSOLETE
    \gre@obsolete{\protect\greabovelinestextstyle}{\protect\grechangestyle{abovelinestext}}%  OBSOLETE
  \fi%  OBSOLETE
  \relax %
}%

% we don't need space above any more
\def\gre@removespaceabove{%
  \global\gre@dimen@currentabovelinestextheight=0 sp%
  \gre@generatelines %
  \relax %
}%

% the code is a bit strange here: we always execute \gre@skip@spaceabovelines at the beginning of a glyph. This will:
% - typeset the text above the lines if relevant, and making sure we execute it only once
% - not do anything else

\xdef\gre@currenttextabovelines{}%

\def\GreSetTextAboveLines#1{%
  \gdef\gre@currenttextabovelines{%
    \gre@typesettextabovelines{#1}%
    \gdef\gre@currenttextabovelines{}%
    \relax %
  }%
}%

% typesets the text above the line
\def\gre@typesettextabovelines#1{%
  \gre@style@abovelinestext%
  \gre@debugmsg{spacing}{Raise alt text: \gre@dimen@abovelinestextraise}%
  \global\gre@dimen@temp@five=\gre@dimen@abovelinestextraise\relax%
  \endgre@style@abovelinestext%
  \ifx\gre@empty@abovelinestextstyle\greabovelinestextstyle% OBSOLETE
  \else%  OBSOLETE
    \gre@obsolete{\protect\greabovelinestextstyle}{\protect\grechangestyle{abovelinestext}}%  OBSOLETE
  \fi%  OBSOLETE
  \gre@debugmsg{spacing}{Raise alt text: \the\gre@dimen@temp@five}%
  \advance\gre@dimen@temp@five by 4\gre@dimen@stafflineheight\relax%
  \advance\gre@dimen@temp@five by 4\gre@dimen@interstafflinespace\relax%
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext\relax%
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight\relax%
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext\relax%
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace\relax%
  \gre@mark@abovelinestext %
  \gre@debugmsg{spacing}{Raise alt text: \the\gre@dimen@temp@five}%
    \leavevmode\raise\gre@dimen@temp@five\hbox to 0pt{\gre@style@abovelinestext#1\endgre@style@abovelinestext\hss}%
  \ifx\gre@empty@abovelinestextstyle\greabovelinestextstyle% OBSOLETE
  \else%  OBSOLETE
    \gre@obsolete{\protect\greabovelinestextstyle}{\protect\grechangestyle{abovelinestext}}%  OBSOLETE
  \fi%  OBSOLETE
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% first a macro to prevent the typesetting of the lines (useful for some people)
\newif\ifgre@showlines%
\gre@showlinestrue

\def\gresetlines#1{%
  \IfStrEq{#1}{visible}%
    {\gre@showlinestrue}%
    {\IfStrEq{#1}{invisible}%
      {\gre@showlinesfalse}%
      {\gre@error{Unrecognized option for \protect\gresetlines}}%
    }%
}

\def\greremovelines{%
  \gre@obsolete{\protect\greremovelines}{\protect\gresetlines{invisible}}%
}%

\def\gredonotremovelines{%
  \gre@obsolete{\protect\gredonotremovelines}{\protect\gresetlines{visible}}%
}%

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\gre@drawfirstlines{%
  \advance\gre@dimen@stafflinewidth by -\gre@dimen@initialwidth\relax%
  %\advance\gre@dimen@stafflinewidth by -\gre@dimen@minimalspaceatlinebeginning
  %\gre@dimen@initialwidth=0pt
  \hbox to 0pt{%
    \vbox{%
      \gre@style@normalstafflines%
      \ifx\gre@empty@normalstafflinesformat\grenormalstafflinesformat% OBSOLETE
      \else%  OBSOLETE
        \gre@obsolete{\protect\grenormalstafflinesformat}{\protect\grechangestyle{normalstafflines}}%  OBSOLETE
      \fi%  OBSOLETE
      \vskip\gre@dimen@currentabovelinestextheight\relax%
      \vskip\gre@dimen@additionaltopspace\relax%
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
      \else %
        \vskip\gre@dimen@stafflineheight\relax%
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
      \else %
        \vskip\gre@dimen@stafflineheight\relax%
      \fi %
      \ifgre@haslinethree %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \ifgre@haslinefour %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \ifgre@haslinefive %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \vskip\gre@dimen@spacelinestext\relax%
      \vskip\gre@dimen@spacebeneathtext\relax%
      \vskip\gre@dimen@currenttranslationheight\relax%
      \vskip\gre@dimen@additionalbottomspace\relax%
      \endgre@style@normalstafflines%
    }%
    \hss%
  }%
  \gre@dimen@stafflinewidth=\gre@dimen@linewidth\relax%
  \relax%
}%

%% box containing the stafflines for other lines than the first
\newbox\gre@box@lines%

% macro that must be called at each change of linewidth and gre@factor
\def\gre@generatelines{%
  \setbox\gre@box@lines=\hbox to 0pt{%
    \vbox{%
      \gre@style@normalstafflines%
      \ifx\gre@empty@normalstafflinesformat\grenormalstafflinesformat% OBSOLETE
      \else%  OBSOLETE
        \gre@obsolete{\protect\grenormalstafflinesformat}{\protect\grechangestyle{normalstafflines}}%  OBSOLETE
      \fi%  OBSOLETE
      \vskip\gre@skip@spaceabovelines\relax%
      \vskip\gre@dimen@currentabovelinestextheight\relax%
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
      \else %
        \vskip\gre@dimen@stafflineheight\relax%
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
      \else %
        \vskip\gre@dimen@stafflineheight\relax%
      \fi %
      \ifgre@haslinethree %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \ifgre@haslinefour %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \ifgre@haslinefive %
        \gre@skip@temp@four = \gre@dimen@interstafflinespace\relax%
        \kern\gre@skip@temp@four %
        \ifgre@showlines %
          \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth\relax%
        \else %
          \vskip\gre@dimen@stafflineheight\relax%
        \fi %
      \fi %
      \vskip\gre@dimen@spacelinestext\relax%
      \vskip\gre@dimen@additionalbottomspace\relax%
      \vskip\gre@dimen@spacebeneathtext\relax%
      \vskip\gre@dimen@currenttranslationheight\relax%
      \endgre@style@normalstafflines %
    }%
    \hss%
  }%
  \relax %
}%

% macro called when we are after the second line of a big initial, to have normal lines back
\def\grenormallines{%
  \global\gre@dimen@stafflinewidth=\gre@dimen@linewidth\relax%
  \gre@generatelines %
  \relax %
}%

% Macro for fusion of larger neumes
\def\GreFuseTwo#1#2{%
  #1\GreNoBreak #2\relax %
}%

\def\GreFuse{\GreNoBreak}%

% Macros for using variant glyphs

% Changes a gregorio code point to a variant glyph
% #1 = the name of the gregorio code point
% #2 = font name
% #3 = glyph name, glyph variant name (preceded by .), or code point
\def\grechangeglyph#1#2#3{%
  \directlua{gregoriotex.init_variant_font([[#2]],true)}%
  \directlua{gregoriotex.change_score_glyph([[#1]],[[#2]],[[#3]])}%
}%

% Resets a gregorio code point to its default setting
% #1 = the name of the gregorio code point
\def\greresetglyph#1{%
  \directlua{gregoriotex.reset_score_glyph([[#1]])}%
}%

{%
  \directlua{gregoriotex.init_variant_font('greciliae', true)}%
  \directlua{gregoriotex.map_font('greciliae', 'CP')}%
}%

\input gregoriotex-chars.tex%

\input gregoriotex-signs.tex%

\input gregoriotex-syllable.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the translations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifgre@translationcentering
\gre@translationcenteringfalse

\def\gresettranslationcentering#1{%
  \IfStrEq{#1}{left}%
    {\gre@translationcenteringfalse}%
    {\IfStrEq{#1}{center}%
      {\gre@translationcenteringtrue}%
      {\gre@error{Unrecognized option for \protect\gresettranslationcentering}}%
    }%
}%

\def\setgretranslationcenteringscheme#1{%
  \gre@obsolete{\protect\setgretranslationcenteringscheme}{\protect\gresettranslationcentering}%
}%


\newif\ifgre@breakintranslation%
\gre@breakintranslationfalse%

\def\gresetbreakintranslation#1{%
  \IfStrEq{#1}{allow}%
    {\gre@breakintranslationtrue}%
    {\IfStrEq{#1}{prohibit}%
      {\gre@breakintranslationfalse}%
      {\gre@error{Unrecognized option in \protect\gresetbreakintranslation}}%
    }%
}%

\def\gresetnlbintranslation#1{%
  \gre@obsolete{\protect\gresetnlbintranslation}{\protect\gresetbreakintranslation}%
}%

\def\GreWriteTranslation#1{%
  \ifgre@translationcentering %
    \gre@dimen@temp@five=\wd\gre@box@syllabletext %
    \setbox\gre@box@temp@width=\hbox{#1}%
    \advance\gre@dimen@temp@five by -\wd\gre@box@temp@width %
    \divide\gre@dimen@temp@five by 2\relax %
    \gre@mark@translation %
    \kern\gre@dimen@temp@five %
    \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation#1\endgre@style@translation\hss}}}%
    \ifx\gre@empty@translationformat\gretranslationformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\gretranslationformat}{\protect\grechangestyle{translation}}%  OBSOLETE
    \fi%  OBSOLETE
    \kern-\gre@dimen@temp@five %
  \else %
    \gre@mark@translation %
    \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation#1\endgre@style@translation\hss}}}%
    \ifx\gre@empty@translationformat\gretranslationformat% OBSOLETE
    \else%  OBSOLETE
      \gre@obsolete{\protect\gretranslationformat}{\protect\grechangestyle{translation}}%  OBSOLETE
    \fi%  OBSOLETE
  \fi %
}%

\def\GreWriteTranslationWithCenterBeginning#1{%
  \ifgre@breakintranslation\else%
    \GreBeginNLBArea{0}{1}%
  \fi %
  \gre@attr@center=1\relax %
  \gre@mark@translation %
  \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\kern 0pt\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation#1\endgre@style@translation\hss}}\kern 0pt}%
  \ifx\gre@empty@translationformat\gretranslationformat% OBSOLETE
  \else%  OBSOLETE
    \gre@obsolete{\protect\gretranslationformat}{\protect\grechangestyle{translation}}%  OBSOLETE
  \fi%  OBSOLETE
  \unsetluatexattribute{\gre@attr@center}%
  \relax %
}%

\newif\ifgre@mustdotranslationcenterend%
\gre@mustdotranslationcenterendfalse%

\def\GreTranslationCenterEnd{%
  \gre@mustdotranslationcenterendtrue%
  \relax %
}%

\def\gre@dotranslationcenterend{%
  \ifgre@breakintranslation\else%
    \GreEndNLBArea{0}{1}%
  \fi %
  \gre@attr@center=2\relax %
  \raise\gre@dimen@spacebeneathtext\hbox to 0pt{}%
  \unsetluatexattribute{\gre@attr@center}%
  \relax %
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifgre@justifylastline%
\gre@justifylastlinefalse%

\def\gresetlastline#1{%
  \IfStrEq{#1}{justified}%
    {\gre@justifylastlinetrue}%
    {\IfStrEq{#1}{ragged}%
      {\gre@justifylastlinefalse}%
      {\gre@error{Unrecognized option for \protect\gresetlastline}}%
    }%
}%

% make this a count so that it can be read more easily in Lua
\newcount\gre@variableheightexpansion\gre@variableheightexpansion=1\relax %
\def\gresetlineheightexpansion#1{%
  \IfStrEq{#1}{uniform}%
    {\gre@variableheightexpansion=0\relax }%
    {\IfStrEq{#1}{variable}%
      {\gre@variableheightexpansion=1\relax }%
      {\gre@error{Unrecognized option for \protect\gresetlineheightexpansion}}%
    }%
}%

% gre@attr@dash (see its definition in gregorio-syllable) is 0 when we are in a score, and unset when we are not

\newif\ifgre@beginningofscore%
\newif\ifgre@haslinethree%
\newif\ifgre@haslinefour%
\newif\ifgre@haslinefive%

\def\gre@setstafflines#1{%
  \def\gre@stafflines{#1}%
  \ifcase#1% 0
    \gre@error{Invalid number of staff lines}%
  \or % 1
    \gre@error{Invalid number of staff lines}%
  \or % 2
    \let\gre@pitch@adjust@top\gre@pitch@f %
    \let\gre@pitch@abovestaff\gre@pitch@g %
    \let\gre@pitch@ledger@above\gre@pitch@h %
    \let\gre@pitch@raresign\gre@pitch@g %
    \let\gre@pitch@overbrace\gre@pitch@i %
    \grechangeglyph{Virgula}{*}{.2}%
    \grechangeglyph{Divisio*}{*}{.2}%
    \gre@haslinethreefalse %
    \gre@haslinefourfalse %
    \gre@haslinefivefalse %
  \or % 3
    \let\gre@pitch@adjust@top\gre@pitch@h %
    \let\gre@pitch@abovestaff\gre@pitch@i %
    \let\gre@pitch@ledger@above\gre@pitch@j %
    \let\gre@pitch@raresign\gre@pitch@i %
    \let\gre@pitch@overbrace\gre@pitch@k %
    \grechangeglyph{Virgula}{*}{.3}%
    \grechangeglyph{Divisio*}{*}{.3}%
    \gre@haslinethreetrue %
    \gre@haslinefourfalse %
    \gre@haslinefivefalse %
  \or % 4
    \let\gre@pitch@adjust@top\gre@pitch@j %
    \let\gre@pitch@abovestaff\gre@pitch@k %
    \let\gre@pitch@ledger@above\gre@pitch@l %
    \let\gre@pitch@raresign\gre@pitch@k %
    \let\gre@pitch@overbrace\gre@pitch@m %
    \greresetglyph{Virgula}%
    \greresetglyph{Divisio*}%
    \gre@haslinethreetrue %
    \gre@haslinefourtrue %
    \gre@haslinefivefalse %
  \or % 5
    \let\gre@pitch@adjust@top\gre@pitch@l %
    \let\gre@pitch@abovestaff\gre@pitch@m %
    \let\gre@pitch@ledger@above\gre@pitch@n %
    \let\gre@pitch@raresign\gre@pitch@m %
    \let\gre@pitch@overbrace\gre@pitch@p %
    \grechangeglyph{Virgula}{*}{.5}%
    \grechangeglyph{Divisio*}{*}{.5}%
    \gre@haslinethreetrue %
    \gre@haslinefourtrue %
    \gre@haslinefivetrue %
  \else %
    \gre@error{Invalid number of staff lines}%
  \fi %
}%

%macro called at the beginning of a score
% #1 is the gabc score id
% #2 is the high height
% #3 is the low height
% #4 is 1 if there is a translation somewhere
% #5 is if 1 if we have space above the staff
% #6 is the point-and-click filename
% #7 is the number of staff lines
\def\GreBeginScore#1#2#3#4#5#6#7{%
  % scores must be new paragraphs!
  \ifhmode\par\fi %
  \gre@beginningofscoretrue%
  \gre@reseteolcustos%
  \gre@resetledgerlineheuristics%
  \global\setluatexattribute\gre@attr@glyph@id{0}%
  \xdef\gre@gabcname{#6}%
  \gre@setstafflines{#7}%
  \global\let\gre@save@englishcentering\gre@lyriccentering\relax % OBSOLETE
  \global\let\gre@opening@initialstyle\gre@initiallines\relax % DEPRECATED by 4.1
  \ifgre@justifylastline%
    \xdef\gre@save@parfillskip{\the\parfillskip}%
    \parfillskip=0pt plus 0pt minus 0pt\relax%
  \fi %
  \ifgre@usestylefont%
    \gre@setstylefont %
  \fi %
  \gre@computespaces%
  \gre@cancelpenalties %
  \gre@attr@dash=0\relax %
  \xdef\gre@exhyphencharsave{\the\exhyphenchar}%
  \exhyphenchar=-1\relax %
  \gre@generatelines %
  \noindent%
  \gre@calculate@additionalspaces{#2}{#3}{#4}{#5}%
  \directlua{
    gregoriotex.atScoreBeginning([[#1]], #2, #3, #4, #5,
        \gre@pitch@adjust@top, \gre@pitch@adjust@bottom)
    gregoriotex.adjust_line_height(1)
  }%
  %TODO do something like LaTeX's AtBeginDocument
  \ifdefined\optgabcAtScoreBeginning %
    \optgabcAtScoreBeginning %
  \fi %
  \global\gre@knownline=1\relax %
  \global\gre@lastoflinecount=2\relax %
  \relax%
}%

%macro called at the end of a score
\def\GreEndScore{%
  \global\gre@lastoflinecount=0\relax %
  \gre@useautoeolcustos%
  \GreEndEUOUAE{}%
  \ifnum\gre@nlbstate=0\else %
    \GreEndNLBArea{2}{0}%
  \fi %
  \gre@localleftbox{}%
  \ifgre@keeprightbox\else %
    \gre@localrightbox{}%
  \fi %
  \hfil %
  \par %
  \ifgre@keeprightbox%
    \global\gre@keeprightboxfalse%
  \fi%
  % with some versions of LuaTeX, the \localrightbox and \localleftbox must be set empty in an environment with the good attributes set
  \gre@localleftbox{}%
  \gre@localrightbox{}%
  \gre@calculate@additionalspaces{\gre@pitch@dummy}{\gre@pitch@dummy}{0}{0}%
  \global\gre@dimen@currentabovelinestextheight=0 sp%
  \gre@removetranslationspace %
  \gre@normalinitial %
  \gre@restorepenalties %
  \exhyphenchar=\gre@exhyphencharsave %
  \gre@dimen@temp@one=0pt\relax%
  \gre@dimen@temp@two=0pt\relax%
  \gre@dimen@temp@three=0pt\relax%
  \gre@dimen@temp@four=0pt\relax%
  \gre@dimen@temp@five=0pt\relax%
  \gre@skip@temp@one=0pt\relax%
  \gre@skip@temp@two=0pt\relax%
  \gre@skip@temp@three=0pt\relax%
  \gre@skip@temp@four=0pt\relax%
  \setbox\gre@box@annotation=\box\voidb@x%
  \directlua{gregoriotex.atScoreEnd()}%
  \unsetluatexattribute{\gre@attr@glyph@id}%
  \unsetluatexattribute{\gre@attr@glyph@top}%
  \unsetluatexattribute{\gre@attr@glyph@bottom}%
  \unsetluatexattribute{\gre@attr@dash}%
  \ifgre@justifylastline%
    \parfillskip=\gre@save@parfillskip\relax%
  \fi %
  \global\let\gre@lyriccentering\gre@save@englishcentering\relax % OBSOLETE
  \global\setluatexattribute\gre@attr@glyph@id{0}%
  \relax%
}%

% macro called at the end of a bar. Almost the same, but not for the penalties
\def\gre@endafterbar#1{%
  \gre@penalty{\greendafterbarpenalty }\relax %
  \ifnum#1=1\relax %
    \gre@debugmsg{ifdim}{ enddifference > 0pt}%
    \ifdim\gre@dimen@enddifference > 0 pt\relax%
      \gre@debugmsg{ifdim}{ nextbegindifference > 0pt}%
      \ifdim\gre@skip@nextbegindifference > 0 pt\relax%
        \gre@skip@temp@four = \gre@skip@notebarspace\relax%
        \gre@hskip\gre@skip@temp@four %
      \else % (next begin difference >0pt)
        \gre@skip@temp@four = \gre@skip@textbartextspace\relax%
        \gre@hskip\gre@skip@temp@four %
      \fi %
    \else%(enddifference < 0pt)
      \gre@debugmsg{ifdim}{ nextbegindifference < 0pt}%
      \ifdim\gre@skip@nextbegindifference < 0 pt\relax%
        \gre@skip@temp@four = \gre@skip@textbartextspace\relax%
        \gre@hskip\gre@skip@temp@four %
      \else %(next begin difference < 0 pt)
        \gre@skip@temp@four = \gre@skip@interwordspacetext\relax%
        \gre@hskip\gre@skip@temp@four %
      \fi %
    \fi %
  \fi %
  %\gre@penalty{\greendafterbarpenalty }\relax
  %\global\gre@dimen@enddifference=0pt
  \relax %
}%

\newcount\gre@lastoflinecount%

% TODO: case where we're at the beginning *and* end of a line... quite rare case though...
% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf if written in plainTeX)
% 0 if nothing
% 1 if the syllable is the last of the line
% 2 after it has finished the syllable, so when it is two it means that the syllable is the first of a line
\def\GreLastOfLine{%
  \global\gre@lastoflinecount=1\relax%
  \gre@debugmsg{eolshift}{set lastoflinecount to 1}%
  \relax%
}%

% same as above, but for the score. For now it is the same behaviour.
\def\GreLastOfScore{%
  %\gre@localleftbox{}% For an unknown reason, if I uncomment this line, the
  %blank line removing algorithm (in lua) will let some blank space after the
  %last line... (see bug #20953)
  \gre@usemanualeolcustos%
  \global\gre@lastoflinecount=1\relax%
  \relax%
}%

% a flag to disable (or reenable) the left shift for first syllables of lines
\newif\ifgre@bolshiftsenabled%
% default state is for them to be enabled
\gre@bolshiftsenabledtrue

\def\gresetbolshifts#1{%
  \IfStrEq{#1}{enable}%
    {\gre@bolshiftsenabledtrue}%
    {\IfStrEq{#1}{disable}%
      {\gre@bolshiftsenabledfalse}%
      {\gre@error{Unrecognized option in \protect\gresetbolshifts}}%
    }%
}%

% a flag to disable (or reenable) the shift for last syllables of lines
% when the shifts are enabled lyrics cannot extend under (or past) the custos at the end of a line
\newif\ifgre@eolshiftsenabled%
% default state is for them to be enabled
\gre@eolshiftsenabledtrue

\def\greseteolshifts#1{%
  \IfStrEq{#1}{enable}%
    {\gre@eolshiftsenabledtrue}%
    {\IfStrEq{#1}{disable}%
      {\gre@eolshiftsenabledfalse}%
      {\gre@error{Unrecognized option in \protect\greseteolshifts}}%
    }%
}%

\def\gredisableeolshifts{%
  \gre@obsolete{\protect\gredisableeolshifts}{\protect\greseteolshifts{disable}}%
}%

\def\greenableeolshifts{%
  \gre@obsolete{\protect\greenableeolshifts}{\protect\greseteolshifts{enable}}%
}%

% Flag indicating if we block the custos. We just block custos at the end of a score, to prevent a bug.
\newif\ifgre@blockeolcustos%
\def\gre@usemanualeolcustos{%
  \gre@blockeolcustostrue%
  \gre@localrightbox{}%
}%
\def\gre@useautoeolcustos{%
  \gre@blockeolcustosfalse%
}%
\def\greseteolcustos#1{%
  \IfStrEq{#1}{manual}%
    {\global\let\gre@reseteolcustos\gre@usemanualeolcustos\relax}%
    {\IfStrEq{#1}{auto}%
      {\global\let\gre@reseteolcustos\gre@useautoeolcustos\relax}%
      {\gre@error{Unrecognized option for \protect\greseteolcustos}}%
    }%
}%
\greseteolcustos{auto}%

\newif\ifgre@blockeolcustosbeforeeuouae%
\def\greseteolcustosbeforeeuouae#1{%
  \IfStrEq{#1}{suppressed}%
    {\gre@blockeolcustosbeforeeuouaetrue\relax}%
    {\IfStrEq{#1}{auto}%
      {\gre@blockeolcustosbeforeeuouaefalse\relax}%
      {\gre@error{Unrecognized option for \protect\greseteolcustosbeforeeuouae}}%
    }%
}%
\greseteolcustosbeforeeuouae{suppressed}%

\newif\ifgre@raggedbreakbeforeeuouae%
\def\gresetbreakbeforeeuouae#1{%
  \IfStrEq{#1}{ragged}%
    {\gre@raggedbreakbeforeeuouaetrue\relax}%
    {\IfStrEq{#1}{justified}%
      {\gre@raggedbreakbeforeeuouaefalse\relax}%
      {\gre@error{Unrecognized option for \protect\greseteolcustosbeforeeuouae}}%
    }%
}%
\gresetbreakbeforeeuouae{justified}%

% macro to suppress the custos
\def\greblockcustos{%
  \gre@obsolete{\protect\greblockcustos}{\protect\greseteolcustos{manual}}%
}%

\def\GreAdHocSpaceEndOfElement#1#2{%
  \gre@skip@temp@four = \gre@skip@interelementspace\relax %
  \directlua{gregoriotex.scale_space(#1)}%
  \GreEndOfElement{4}{#2}%
}%

% macro to end elements, #1 is the type of space, it can be :
%% 0: default space
%% 1: larger space
%% 2: glyph space
%% 3: zero-width space
%% 4: custom space
% #2 is if the space is unbreakable (1) or not (0)
\def\GreEndOfElement#1#2{%
  \ifnum #2=0\relax %
    \gre@penalty{\greendofelementpenalty}%
  \else %
    \GreNoBreak %
  \fi %
  \ifcase#1%
    \gre@skip@temp@four = \gre@skip@interelementspace\relax%
    \gre@hskip\gre@skip@temp@four %
  \or% case 1
    \gre@skip@temp@four = \gre@skip@largerspace\relax%
    \gre@hskip\gre@skip@temp@four %
  \or% case 2
    \gre@skip@temp@four = \gre@skip@glyphspace\relax%
    \gre@hskip\gre@skip@temp@four %
  \or% case 3
    \gre@skip@temp@four = \gre@skip@zerowidthspace\relax%
    \gre@hskip\gre@skip@temp@four %
  \or% case 4
    \gre@hskip\gre@skip@temp@four %
  \fi%
  \ifnum #2=1\relax %
    \GreNoBreak %
  \fi %
\relax%
}%

% puts the correct skip value into \gre@skip@temp@four for the desired type of space
%% 0: default space
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 7: space between a punctum inclinatum and a punctum inclinatum deminutus
%% 8: space between two puncta inclinata deminuti
%% 4: space between bivirga or trivirga
%% 5: space between bistropha or tristropha
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
%% 10: space between puncta inclinata (also debilis for now), larger ambitus (range=3rd).
%% 11: space between puncta inclinata (also debilis for now), larger ambitus (range=4th or 5th)
%% 12: ascending version of 3
%% 13: ascending version of 7
%% 14: ascending version of 10
%% 15: ascending version of 11
%% 16: space between a punctum inclinatum and a "no-bar" glyph one pitch below
%% 17: space between a punctum inclinatum and a "no-bar" glyph two pitches below
%% 18: space between a punctum inclinatum and a "no-bar" glyph three or four pitches below
%% 19: space between a punctum inclinatum and a "no-bar" glyph one pitch above
%% 20: space between a punctum inclinatum and a "no-bar" glyph two pitches above
%% 21: space between a punctum inclinatum and a "no-bar" glyph three or four pitches above
%% 22: half-space
\def\gre@get@spaceskip#1{%
  \ifcase#1%
    \gre@skip@temp@four = \gre@skip@interglyphspace\relax%
  \or% case 1
    \gre@skip@temp@four = \gre@dimen@zerowidthspace\relax%
  \or% case 2
    \gre@skip@temp@four = \gre@dimen@alterationspace\relax%
  \or% case 3
    \gre@skip@temp@four = \gre@skip@punctuminclinatumshift\relax%
  \or% case 4
    \gre@skip@temp@four = \gre@skip@bitrivirspace\relax%
  \or% case 5
    \gre@skip@temp@four = \gre@skip@bitristrospace\relax%
  \or% case 6
    \gre@skip@temp@four = \gre@skip@spaceaftersigns\relax%
  \or% case 7
    \gre@skip@temp@four = \gre@skip@punctuminclinatumanddebilisshift\relax%
  \or% case 8
    \gre@skip@temp@four = \gre@skip@punctuminclinatumdebilisshift\relax%
  \or% case 9
    \gre@skip@temp@four = \gre@skip@beforepunctainclinatashift\relax%
  \or% case 10
    \gre@skip@temp@four = \gre@skip@punctuminclinatumbigshift\relax%
  \or% case 11
    \gre@skip@temp@four = \gre@skip@punctuminclinatummaxshift\relax%
  \or% case 12 (ascending version of 3)
    \gre@skip@temp@four = \gre@skip@ascendingpunctuminclinatumshift\relax%
  \or% case 13 (ascending version of 7)
    \gre@skip@temp@four = \gre@skip@ascendingpunctuminclinatumanddebilisshift\relax%
  \or% case 14 (ascending version of 10)
    \gre@skip@temp@four = \gre@skip@ascendingpunctuminclinatumbigshift\relax%
  \or% case 15 (ascending version of 11)
    \gre@skip@temp@four = \gre@skip@ascendingpunctuminclinatummaxshift\relax%
  \or% case 16
    \gre@skip@temp@four = \gre@skip@descendinginclinatumtonobarshift\relax%
  \or% case 17
    \gre@skip@temp@four = \gre@skip@descendinginclinatumtonobarbigshift\relax%
  \or% case 18
    \gre@skip@temp@four = \gre@skip@descendinginclinatumtonobarmaxshift\relax%
  \or% case 19
    \gre@skip@temp@four = \gre@skip@ascendinginclinatumtonobarshift\relax%
  \or% case 20
    \gre@skip@temp@four = \gre@skip@ascendinginclinatumtonobarbigshift\relax%
  \or% case 21
    \gre@skip@temp@four = \gre@skip@ascendinginclinatumtonobarmaxshift\relax%
  \or% case 22
    \gre@skip@temp@four = \gre@skip@halfspace\relax%
  \fi%
}%

% macro to end a glyph without ending the element
% see \gre@get@glyphskip for the valus of the argument
\def\GreEndOfGlyph#1{%
  \GreNoBreak %
  \gre@get@spaceskip{#1}%
  \gre@hskip\gre@skip@temp@four %
  \GreNoBreak %
  \relax%
}%

% The different states of line break areas:
% 0: not currently in a no line break area
% 1: no line break area due to translation centering
% 2: no line break area due to <nlba> tag
\xdef\gre@nlbstate{0}%

% first argument is if if the nlba is starting in neumes or not
% second argument is if it is called from translation centering or not
\def\GreBeginNLBArea#1#2{%
  \xdef\gre@nlbinitialstate{\gre@nlbstate}%
  \ifnum#2=0\relax %
    \xdef\gre@nlbstate{2}%
  \else %
      \ifcase\gre@nlbstate %
        \xdef\gre@nlbstate{1}%
      \or %
        \xdef\gre@nlbstate{1}%
      \or %
        \xdef\gre@nlbstate{2}%
      \fi %
  \fi %
  \ifnum\gre@nlbinitialstate=0\relax %
      \xdef\gre@nobreakpenaltysave{\grenobreakpenalty }%
      \xdef\grenobreakpenalty{10001}%
      \xdef\gre@endofwordpenaltysave{\greendofwordpenalty }%
      \xdef\greendofwordpenalty{10001}%
      \xdef\gre@endofsyllablepenaltysave{\greendofsyllablepenalty }%
      \xdef\greendofsyllablepenalty{10001}%
      \xdef\gre@endafterbarpenaltysave{\greendafterbarpenalty }%
      \xdef\greendafterbarpenalty{10001}%
      \xdef\gre@endafterbaraltpenaltysave{\greendafterbaraltpenalty }%
      \xdef\greendafterbaraltpenalty{10001}%
      \xdef\gre@endofelementpenaltysave{\greendofelementpenalty }%
      \xdef\greendofelementpenalty{10001}%
      \xdef\gre@hyphenpenaltysave{\grehyphenpenalty }%
      \xdef\grehyphenpenalty{10001}%
  \fi %
}%

\def\GreEndNLBArea#1#2{%
  \xdef\gre@nlbinitialstate{\gre@nlbstate}%
  \ifnum#2=0\relax %
    \xdef\gre@nlbstate{0}%
  \else %
      \ifcase\gre@nlbstate %
        \xdef\gre@nlbstate{0}%
      \or %
        \xdef\gre@nlbstate{0}%
      \or %
        \xdef\gre@nlbstate{2}%
      \fi %
  \fi %
  % if gre@nlbstate is not 0, then nothing should happend
  \ifnum\gre@nlbstate=0\relax %
    \ifnum\gre@nlbinitialstate=0\else %
      \xdef\grenobreakpenalty{\gre@nobreakpenaltysave }%
      \xdef\greendofwordpenalty{\gre@endofwordpenaltysave}%
      \xdef\greendofsyllablepenalty{\gre@endofsyllablepenaltysave}%
      \xdef\greendafterbarpenalty{\gre@endafterbarpenaltysave}%
      \xdef\greendafterbaraltpenalty{\gre@endafterbaraltpenaltysave}%
      \xdef\greendofelementpenalty{\gre@endofelementpenaltysave}%
      \xdef\grehyphenpenalty{\gre@hyphenpenaltysave}%
      \ifcase #1\relax % 0
        \gre@penalty{\greendofelementpenalty}%
      \or % 1
        \gre@penalty{\greendofsyllablepenalty}%
      \or % 2
        % end of score, no penalty needs to be added
      \or % 3
        % before bar, no penalty should to be added
      \fi %
    \fi %
  \fi %
}%

\newif\ifgre@euouae@implies@nlba
\gre@euouae@implies@nlbatrue

\def\gresetbreakineuouae#1{%
  \IfStrEq{#1}{allow}%
    {\gre@euouae@implies@nlbafalse}%
    {\IfStrEq{#1}{prohibit}%
      {\gre@euouae@implies@nlbatrue}%
      {\gre@error{Unrecognized option in \protect\gresetbreakineuouae}}%
    }%
}%


\newif\ifgre@in@euouae
\gre@in@euouaefalse

\def\GreBeginEUOUAE#1{%
  \ifgre@raggedbreakbeforeeuouae %
    \directlua{gregoriotex.save_pos(#1,2)}%
    \ifcase\directlua{gregoriotex.is_ypos_different(#1)}\relax%
      \gre@newlinecommon{1}%
    \fi %
  \fi %
  \ifgre@euouae@implies@nlba %
    \GreBeginNLBArea{0}{0}%
  \fi %
  \gre@in@euouaetrue %
  % as soon as the EUOUAE starts, we stop blocking the EOL custos that might
  % have been blocked on the prior syllable.
  \gre@reseteolcustos %
}

\def\GreEndEUOUAE#1{%
  \ifgre@euouae@implies@nlba %
    \GreEndNLBArea{#1}{0}%
  \fi %
  \gre@in@euouaefalse %
}

\input gregoriotex-symbols.tex%

%%%%%%%%%
%% fonts
%%%%%%%%%

\def\GreTilde{%
  \ensuremath{\sim}%
  \relax %
}%


\def\gresetgregoriofont{\@ifnextchar[{\gre@setgregoriofont}{\gre@setgregoriofont[]}}%

\def\gre@setgregoriofont[#1]#2{%
  \ifx#1\gre@nothing %
    \xdef\gre@gregoriofontname{#2}%
    \gre@loadgregoriofont%
    \gdef\GreCPVirgaReversaAscendensOnDLine##1{##1}%
  \else %
    \xdef\gre@gregoriofontname{#2-#1}%
    \gre@loadgregoriofont%
    \gdef\GreCPVirgaReversaAscendensOnDLine##1{\GreCPVirgaReversaLongqueueAscendens}%
  \fi %
  \relax %
}%

\def\gre@loadgregoriofont{%
  \gre@count@temp@three = \the\gre@factor %
  \multiply\gre@count@temp@three by 100000 %
  \global\font\gre@font@music={name:\gre@gregoriofontname} at \the\gre@count@temp@three sp%
  {\gre@font@music\directlua{gregoriotex.check_font_version() gregoriotex.scale_score_fonts([[\the\gre@count@temp@three]])}}%
  \relax%
}%

% the default gregorio font
\gresetgregoriofont{greciliae}%

\newif\ifgre@usestylefont%
\gre@usestylefontfalse%

% gregoriostylefont is the font used for additional glyphs
\def\gre@setstylefont{%
  \gre@count@temp@three = \the\gre@factor %
  \multiply\gre@count@temp@three by 100000\relax %
  \global\font\gre@font@style={name:greextra} at \the\gre@count@temp@three sp%
  {\gre@font@music\directlua{gregoriotex.check_font_version() gregoriotex.scale_score_fonts([[\the\gre@count@temp@three]])}}%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% The following style functions are defined for backwards compatibility.  They will eventually be removed.
\def\greinitialformat#1{% OBSOLETE
  \relax %
}
\let\gre@empty@initialformat\greinitialformat

\def\grebiginitialformat#1{% OBSOLETE
  \relax %
}
\let\gre@empty@biginitialformat\grebiginitialformat

\def\gretranslationformat#1{% OBSOLETE
  \relax %
}%
\let\gre@empty@translationformat\gretranslationformat

\def\grenormalstafflinesformat{% OBSOLETE
  \relax %
}%
\let\gre@empty@normalstafflinesformat\grenormalstafflinesformat

\def\greadditionalstafflinesformat{% OBSOLETE
  \relax %
}%
\let\gre@empty@additionalstafflinesformat\greadditionalstafflinesformat

%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\GreSetStaffLinesFormat#1{%
  \gre@obsolete{\protect\GreSetStaffLinesFormat}{\protect\grechangestyle{normalstafflines}}%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Master function for changing element formats
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grechangestyle#1#2{%
  \IfStrEq{#1}{biginitial}{\gre@deprecated{biginitial style}{initial style}}{}%%% DEPRECATED for removal in 5.0
  \@ifnextchar[{\gre@changestyle{#1}{#2}}{\gre@changestyle{#1}{#2}[\relax]}%
}%

% because the mechanism for the defining the formats differs under LaTeX and PlainTeX the underlying function which does the work is defined in gregoriotex.sty or gregoriotex.tex respectively.


%%%%%%%%%%%%%%%%%%%
%% changing staff size
%%%%%%%%%%%%%%%%%%%

\def\grechangestaffsize#1{%
  \ifnum#1<0\relax%
    \gre@error{Staff size must be a positive integer.}%
  \else%
    \gre@changedimenfactor{\gre@factor}{#1}%
    \global\gre@factor=#1\relax %
  \fi%
  \gre@loadgregoriofont%
  \relax %
}%

\def\setgrefactor#1{%
  \gre@obsolete{\protect\setgrefactor}{\protect\grechangestaffsize}%
}%

%%%%%%%%%%%%%%%%%%%
%% headers
%%%%%%%%%%%%%%%%%%%
\def\gresetheadercapture#1#2#3{%
  \directlua{gregoriotex.set_header_capture("#1","#2","#3")}%
}%

\def\GreHeader#1#2{%
  \directlua{gregoriotex.capture_header("#1","#2")}%
}%

%%%%%%%%%%%%%%%%%%%
%% score including
%%%%%%%%%%%%%%%%%%%

% Flag to track compilation behavior
% 0 = never compile (default)
% 1 = auto compile (compile outdated scores and those lacking a compiled version)
% 2 = compile all scores
\def\gre@compilegabc{0}

% User macro to change compilation behavior
\def\gresetcompilegabc#1{%
  \IfStrEq{#1}{force}{\gdef\gre@compilegabc{2}}{%
    \IfStrEq{#1}{auto}{\gdef\gre@compilegabc{1}}{%
      \IfStrEq{#1}{never}{\gdef\gre@compilegabc{0}}{%
        \gre@error{Unrecognized argument for \protect\gresetcompilegabc.}%
      }%
    }%
  }%
}%


% User macro to force gregriotex to recompile gabc files. Useful for when there
% are changes to gregoriotex but the GREGORIOTEX API VERSION is not changed.
\def\forcecompilegabc{%
  \gre@obsolete{\protect\forcecompilegabc}{\protect\gresetcompilegabc{force}}%
}%

% User macro to let gregoriotex auto recompile gabc files as necessary.
% Intended to be used in the main tex file to revert the previous macro.
\def\autocompilegabc{%
  \gre@obsolete{\protect\autocompilegabc}{\protect\gresetcompilegabc{auto}}%
}%

% User macro to force score inclusion without compilation.
\def\nevercompilegabc{%
  \gre@obsolete{\protect\nevercompilegabc}{\protect\gresetcompilegabc{never}}%
}


% Internal marco which includes a score when \gregorioscore is called without the optional argument.  Behavior is determined by the value of \gre@compilegabc flag.
%
% If \gre@compilegabc is 0, then we simply try to include the file as it is given to us.  This is the old behavior.
%
% If \gre@compilegabc is 1, tell the lua function to check that:
%	-- The gtex file exists.
%	-- The gtex file is of the correct gregoriotexapi_version.
%	-- The gtex file is 'newer' than it's corresponding gabc file.
% If any test fails, the gabc file is (re)compiled.
%
% If \gre@compilegabc is 2, pass true to the lua function.
% This forces gregoriotex to recompile the gabc file.

\def\gre@gregorioscore#1{%
  \ifcase\gre@compilegabc% case 0, never compile
    \gre@debugmsg{compile}{Refusing to compile #1}%
    \input #1%
  \or% case 1, auto compile
    \gre@debugmsg{compile}{Auto compile #1}%
    \directlua{gregoriotex.include_score([[#1]], nil)}%
  \or% case 2, force compile
    \gre@debugmsg{compile}{Forced to compile #1}%
    \directlua{gregoriotex.include_score([[#1]], true)}%
  \fi%
  \relax%
}%

% The internal macro called when \gregorioscore is called with the optional argument.  Behavior is determined by the value of the argument:
% n - do not attempt to compile the score.  Simply include it as is.
% a - perform the checks to see if the score needs to be recompiled and do so only if necessary
% f - force the compilation of the score before including it
\def\gre@gregorioscore@option[#1]#2{%
  \ifx #1n\relax%
    \gre@debugmsg{compile}{Override not compiling #2}%
    \input #2%
  \else%
    \ifx #1f\relax%
      \gre@debugmsg{compile}{Override force compiling #2}%
      \directlua{gregoriotex.include_score([[#2]], true)}%
    \else%
      \ifx #1a\relax%
        \gre@debugmsg{compile}{Override auto compiling #2}%
        \directlua{gregoriotex.include_score([[#2]], nil)}%
      \else%
        \gre@error{Unrecognized option [#1] for \protect\includescore}%
      \fi%
    \fi%
  \fi%
  \relax%
}%

% The main macro used by the user to input scores into the document.

\def\includescore{%
  \gre@obsolete{\protect\includescore}{\protect\gregorioscore}%
}%

\def\gregorioscore{\@ifnextchar[{\gre@gregorioscore@option}%
    {\gre@gregorioscore}%
}%

% If called without the optional argument: '\gregorioscore{Antiphon}'
% the filename will be passed to the lua function 'include_score'
% which will check: whether the gtex file exists, if the API version
% of the gtex file, or if the gabc file is newer than the gtex
% file. If one of these tests fails, the gabc file will be
% (re)compiled.
% The argument may or may not include a file extension. These are all valid:
% '\gregorioscore{Antiphon}' or '\gregorioscore{Antiphon.gabc}' or
% '\gregorioscore{Antiphon.gtex}'

% If called with the optional argument: '\gregorioscore[f]{Antiphon.gtex}'
% the gtex file will be forced into the document and will not be
% checked by the lua function 'include_score'. This does not bypass
% the API version test done by '\GregorioTeXAPIVersion'.

% Macros for compiling short snippets of GABC directly expressed in TeX

\long\def\gre@gabcsnippet@option[#1]#2{%%% DEPRECATED by 4.1
  \gre@deprecated{\protect\gabcsnippet  with initial-style argument}{\protect\gresetinitiallines}%
  \directlua{gregoriotex.direct_gabc("\luatexluaescapestring{\unexpanded\expandafter{#2}}", "initial-style: #1;")}%
}%

\long\def\gre@gabcsnippet#1{%
  \directlua{gregoriotex.direct_gabc("\luatexluaescapestring{\unexpanded\expandafter{#1}}")}%
}%

%%% \gre@gabcsnipper@option is DEPRECATED by 4.1
\def\gabcsnippet{\@ifnextchar[{\gre@gabcsnippet@option}{\gre@gabcsnippet}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% some hyphen definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a zero-width hyphen, useful for fine tuning line endings. To input in gabc verb for example.
\def\GreZeroHyph{%
  \hbox to 0pt{%
  \char\the\hyphenchar\font %
  \hss %
  }%
}%

% a normal hyphen
\def\gre@char@normalhyphen{%
  %-
  \char\the\hyphenchar\font %
}%

% the definition that will be always used for end of lines hyphens in gregorio, except if one of the two before is explicitely used
\let\GreHyph\gre@char@normalhyphen %

% macro to change the definition of the hyphen:
\def\greseteolhyphen#1{%
  \IfStrEq{#1}{normal}%
    {\global\let\GreHyph\gre@char@normalhyphen}%
    {\IfStrEq{#1}{zero}%
      {\global\let\GreHyph\GreZeroHyph}%
      {\gre@error{Unrecognized option for \protect\greseteolhyphen}}%
    }%
}%

\def\GreUseNormalHyphen{%
  \gre@obsolete{\protect\GreUseNormalHyphen}{\protect\greseteolhyphen{normal}}%
}%

\def\GreUseZeroHyphen{%
  \gre@obsolete{\protect\GreUseZeroHyphen}{\protect\greseteolhyphen{zero}}%
}%

% macro to force hyphenation of all syllables.
\newif\ifgre@forcehyphen\gre@forcehyphenfalse%
\def\gresethyphen#1{%
  \IfStrEq{#1}{force}%
    {\gre@forcehyphentrue}%
    {\IfStrEq{#1}{auto}%
      {\gre@forcehyphenfalse}%
      {\gre@error{Unrecognized option in \protect\gresethyphen}}%
    }%
}%

% macro called before the headers of a given inclusion
\def\GreBeginHeaders{}%
\long\def\grebeforeheaders#1{\def\GreBeginHeaders{#1}}%

% macro called after the headers of a given inclusion
\def\GreEndHeaders{}%
\long\def\greafterheaders#1{\def\GreEndHeaders{#1}}%

% We load the default space configuration.
\greloadspaceconf{default}%

\input gregoriotex-nabc.tex
