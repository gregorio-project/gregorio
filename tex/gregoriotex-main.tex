%GregorioTeX main file.
%
% Copyright (C) 2007-2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

\ifluatex%
  \ifnum\luatexversion<76%
    \greerror{Error: this document must be compiled with LuaTeX (lualatex) 0.76 or later}%
  \fi%
\else%
  \greerror{Error: this document must be compiled with LuaTeX (lualatex)}%
\fi%

\def\gre@debugmsg#1#2{%
  \IfStrEq{\gre@debug}{}{}%
    %false
    {\IfStrEq{#1}{all}%
      %true
      {\greerror{Debug error: ‘all’ is not a permitted keyword}}%
      %false
      {\IfStrEq{\gre@debug}{all}%
        %true
        {\gre@typeout{GregorioTeX debug: (#1) #2}}%
        %false
        {\IfSubStr{\gre@debug}{#1}%
          %true
          {\gre@typeout{GregorioTeX debug: (#1) #2}}%
          %false
          {\relax}%
        }%
      }%
    }%
}%

% Macro to handle deprecated macros.
% #1 - the deprecated macro
% #2 - the correct macro to use
\def\gre@deprecated#1#2{%
  \ifgre@deprecated%
    \gre@warning{#1\space is deprecated.\MessageBreak Use #2\space instead}%
  \else%
    \greerror{#1\space is deprecated.\MessageBreak Use #2\space instead}%
  \fi%
  \relax%
}%

\def\gre@nothing{}

\AtBeginDocument{\IfStrEq{\gre@debug}{}{}{\typeout{GregorioTeX is in debug mode}\typeout{\gre@debug\space messages will be printed to the log.}}}%

% Since TeXLive 2009, the extra primitives of LuaTeX have a luatex prefix, and are not
% available without prefix. We mostly rely on \directlua that is still available
% without prefix, but we also rely on the Omega primitives, that have a luatex
% prefix in TeXLive 2009.

\let\grelocalleftbox\luatexlocalleftbox%
\let\grelocalrightbox\luatexlocalrightbox%
% an attribute we put on the text nodes.
% if it is 1, it means that there may be a dash here if this syllable is at the end of a line
% if it is 2, it means that it's never useful to typeset a dash
% if it is 0, it just means that we are in a score...
\newluatexattribute\gregorioattr%
\def\greunsetattribute{\unsetluatexattribute{\gregorioattr}}%

% an attribute used for translation centering
\newluatexattribute\gregoriocenterattr%

\newluatexattribute\GreScoreId %

% attributes for tracking glyph heights
\newluatexattribute\gre@attr@glyph@id %
\newluatexattribute\gre@attr@glyph@top %
\newluatexattribute\gre@attr@glyph@bottom %

\newluatexcatcodetable\gre@atletter %
\setluatexcatcodetable\gre@atletter{%
  \catcode`\@=11 %
}%

% The version of gregorio. All gregoriotex*.tex files must have the same.
% All gtex files must also have the same version.
\xdef\gre@gregorioversion{4.0.0-beta}% GREGORIO_VERSION - VersionManager.py

% first some macros to allow checks for version:
% Tests that all gregoriotex files are of the same version.
% #1 is the name of the file
% #2 is the version

\def\gre@declarefileversion#1#2{%
  \IfStrEq*{#2}{\gre@gregorioversion}{}{%else
    \greerror{uncoherent file versions: gregoriotex-main.tex is in version \number\gre@gregorioversion \space\space while #1 is in version \number#2}}%
}%

% Macro called by scores.
% Tests the major version of gregorio (X.0.0) against the score. Fails
% if the major version (X) does not match.
% #1 is the version of GregorioTeX the score is made for.

\def\GregorioTeXAPIVersion#1{%
  \StrBefore{\gre@gregorioversion}{.}[\gre@gregoriomajorversion]%
  \IfBeginWith{#1}{\gre@gregoriomajorversion}{\relax}{%else
    \greerror{GregorioTeX is in version \gre@gregorioversion \space\space while a score you included requires version #1. Please recompile your scores}}%
}%

\RequireLuaModule{gregoriotex}%
\ifcsname greskipheightcomputation\endcsname %
  \directlua{gregoriotex.init(arg, false)}%
\else %
  \directlua{gregoriotex.init(arg, true)}%
\fi %

\xdef\gre@gregoriotexluaversion{\directlua{tex.write(gregoriotex.get_gregorioversion())}}%

% Test to make sure that gregoriotex.lua is of the same version.
\IfStrEq*{\gre@gregoriotexluaversion}{\gre@gregorioversion}{}{%else
    \greerror{uncoherent file versions: gregoriotex-main.tex is in version \number\gre@gregorioversion \space\space while gregoriotex.lua is in version \gre@gregoriotexluaversion}}%


%%%%%%%%%%%%%%%%%%%%%%%%
%% aux file definitions
%%%%%%%%%%%%%%%%%%%%%%%%

% for now, we only use an aux file with LuaTeX

\ifluatex%
  \newwrite\greaux%
\fi%

\def\grewriteaux#1{%
  \write\greaux{#1}%
  \relax %
}%

\def\opengreaux{%
  \openout\greaux \jobname .gaux\relax%
}%

\def\closegreaux{%
  \closeout\greaux %
}%


%%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%%

\def\gre@pitch@a{3}%
\def\gre@pitch@b{4}%
\def\gre@pitch@c{5}%
\def\gre@pitch@d{6}%
\def\gre@pitch@e{7}%
\def\gre@pitch@f{8}%
\def\gre@pitch@g{9}%
\def\gre@pitch@h{10}%
\def\gre@pitch@i{11}%
\def\gre@pitch@j{12}%
\def\gre@pitch@k{13}%
\def\gre@pitch@l{14}%
\def\gre@pitch@m{15}%
\def\gre@pitch@n{16}%
\def\gre@pitch@o{17}%
\def\gre@pitch@p{18}%

\let\gre@pitch@adjust@top\gre@pitch@j %
\let\gre@pitch@adjust@bottom\gre@pitch@c %

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
% it is set to the default value : 17 (the value that makes it look like a standard graduale)
\newcount\grefactor%
\grefactor=17%

%%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%%

\input gregoriotex-spaces.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for additionnal vertical spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% macro called to go to the next line
\def\GreNewLine{%
  \gre@debugmsg{lineheight}{GreNewLine}%
  \grenewlinecommon{0}%
  \relax%
}%

% basically same as above, but this one does a \hfill, so the lines are not justified
\def\GreNewParLine{%
  \gre@debugmsg{lineheight}{GreNewParLine}%
  \grenewlinecommon{1}%
}%

% a macro describing a kern to make before ending the line, which we sometimes want (see \syllable)
\xdef\grekernbeforeeol{0pt\relax}%

% the macro we call each time we force a changing of line, it automatically sets \greknownline, and adjusts left spaces
\def\grenewlinecommon#1{%
  \ifgre@blockeolcustos\ifnum\greinsidediscretionary=0\relax %
     \grelocalrightbox{}%
  \fi\fi %
  % sometimes we need to add a space before ending the line:
  \gre@skip@temp@four = \grekernbeforeeol\relax%
  \kern\gre@skip@temp@four %
  \ifnum\greboxing=0\relax %
    \ifnum\grebiginitial=1\relax %
      \ifcase\greknownline %
      % 0: should not happend...
      \or % 1
        \GreAdjustSecondLine %
      \or %2
        \GreAdjustThirdLine %
      \fi %
    \fi %
    \global\advance\greknownline by 1\relax %
    \global\grelastoflinecount=2\relax %
    \ifnum\greinsidediscretionary=0\relax %
      \greupdateleftbox %
    \fi %
    \ifnum#1=1\relax %
      \hfill %
    \fi %
    \grepenalty{-10001}%
  \fi %
  \relax %
}%

\def\gre@mark@translation{\directlua{gregoriotex.mark_translation()}}%
\def\gre@mark@abovelinestext{\directlua{gregoriotex.mark_abovelinestext()}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% macro that sets \gre@dimen@temp@three to the width of its argument

\newbox\gre@box@temp@width%

\def\grewidthof#1{%
  \setbox\gre@box@temp@width=\hbox{#1}%
  \global\gre@dimen@temp@three=\wd\gre@box@temp@width%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\gre@box@initial%


% grebiginitial means that the inital takes two lines
\newcount\grebiginitial%

% greknownline is the line we think we are in
\newcount\greknownline%

% macro to call before the call of \initial
\def\GreSetBigInitial{%
  \global\grebiginitial=1\relax %
  \relax %
}%

% macro to cancel before the call of \initial
\def\grenormalinitial{%
  \global\grebiginitial=0\relax %
  \relax %
}%

% macro to call before the first syllable, but after setinitialclef
\def\GreAdjustSecondLine{%
  \gre@dimen@additionalleftspace=\gre@dimen@initialwidth %
  \greupdateleftbox %
  \relax %
}%

% macro to call during the second line
\def\GreAdjustThirdLine{%
  \gre@dimen@additionalleftspace= 0 pt%
  \greupdateleftbox %
  \relax %
}%

\def\greupdateleftbox{%
  \greupdatelinewidth %
  \greupdatelinesclef %
}%

\def\greupdatelinewidth{%
  \gre@debugmsg{ifdim}{ additionalleftspace = 0pt}%
  \ifdim\gre@dimen@additionalleftspace=0pt%
  \else %
    \gre@dimen@temp@five=\gre@dimen@stafflinewidth %
    \global\advance\gre@dimen@stafflinewidth by -\gre@dimen@additionalleftspace %
    \gregeneratelines %
    \global\gre@dimen@stafflinewidth=\gre@dimen@temp@five %
  \fi %
}%

\def\GreSetInitial#1{%
  % see comments on this function to see what it does
  \gre@debugmsg{annotation}{Time to calculate the true raise.}%
  \gre@calculate@annotationtrueraise %
  % we print the initial always at the same place, and then we print the gre@box@annotation, centered
  % first we print the initial
  \gre@dimen@temp@five=-\gre@dimen@textlower %
  % if it is a big initial we print it on the second line
  \ifnum\grebiginitial=0\relax %
    \setbox\gre@box@initial=\hbox{\gre@style@initial\greinitialformat{#1}\endgre@style@initial}%
    \gre@debugmsg{ifdim}{ manualinitialwidth = 0pt}%
    \ifdim\gre@dimen@manualinitialwidth=0 pt\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@initial %
    \else%
      \gre@style@initial%
      \greinitialformat{\global\gre@dimen@initialwidth=\gre@dimen@manualinitialwidth}%
      \endgre@style@initial%
    \fi%
    \gre@debugmsg{ifdim}{ wd(gre@box@annotation) > initialwidth}%
    \ifdim\wd\gre@box@annotation>\gre@dimen@initialwidth\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@annotation%
    \fi%
    \gre@debugmsg{annotation}{Width check completed.}%
    \setbox\gre@box@initial=\hbox to \gre@dimen@initialwidth {\hss\raise -\gre@dimen@temp@five\hbox{\gre@style@initial\greinitialformat{#1}\endgre@style@initial}\hss}%
    \gre@debugmsg{annotation}{Initial set.}%
    \gre@style@initial%
    \greinitialformat{\global\gre@dimen@temp@four = \gre@dimen@beforeinitialshift}%
    \endgre@style@initial%
  \else %
    \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
    \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
    \advance\gre@dimen@temp@five by 4\gre@dimen@interstafflinespace %
    \advance\gre@dimen@temp@five by 4\gre@dimen@stafflineheight %
    \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
    \setbox\gre@box@initial=\hbox{\gre@style@biginitial\grebiginitialformat{#1}\endgre@style@biginitial}%
    \gre@debugmsg{ifdim}{ manualinitialwidth = 0pt}%
    \ifdim\gre@dimen@manualinitialwidth=0 pt\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@initial %
    \else%
      \gre@style@biginitial%
      \grebiginitialformat{\global\gre@dimen@initialwidth=\gre@dimen@manualinitialwidth}%
      \endgre@style@biginitial%
    \fi%
    \gre@debugmsg{ifdim}{ wd(GreAboveinitialfirstbox) > initialwidth}%
    \ifdim\wd\gre@box@annotation>\gre@dimen@initialwidth\relax%
      \global\gre@dimen@initialwidth=\wd\gre@box@annoation%
    \fi%
    \setbox\gre@box@initial=\hbox{\vbox to 0pt{\hbox to \gre@dimen@initialwidth {\hss\raise -\gre@dimen@temp@five\hbox{\gre@style@biginitial\grebiginitialformat{#1}\endgre@style@biginitial}\hss}\vss}}%
    \gre@style@biginitial%
    \grebiginitialformat{\global\gre@dimen@temp@four = \gre@dimen@beforeinitialshift}%
    \endgre@style@biginitial%
  \fi %
  \hskip\gre@dimen@temp@four %
  \global\advance\gre@dimen@initialwidth by \gre@dimen@temp@four %
  \gre@debugmsg{annotation}{Ready to place initial.}%
  \copy\gre@box@initial%
  \ifnum\grebiginitial=0\relax%
    \gre@style@initial%
    \greinitialformat{\global\gre@dimen@temp@four = \gre@dimen@afterinitialshift}%
    \endgre@style@initial%
  \else%
    \gre@style@biginitial%
    \grebiginitialformat{\global\gre@dimen@temp@four = \gre@dimen@afterinitialshift}%
    \endgre@style@biginitial%
  \fi%
  \hskip\gre@dimen@temp@four %
  \global\advance\gre@dimen@initialwidth by \gre@dimen@temp@four%
  % then we center the first box above the initial, if there is one
  \gre@debugmsg{annotation}{Time to set the annotation.}%
  \ifvoid\gre@box@annotation\relax%
    \gre@debugmsg{annotation}{There is no annotation.}%
  \else %
    \gre@debugmsg{annotation}{Calculate horizontal position.}%
    \gre@dimen@temp@five=\gre@dimen@initialwidth %
    \advance\gre@dimen@temp@five by -\wd\gre@box@annotation%
    \divide\gre@dimen@temp@five by 2 %
    \gre@skip@temp@four = -\gre@dimen@initialwidth%
    \hskip\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
    \gre@debugmsg{annotation}{And place the annotation.}%
    \raise\gre@dimen@annotationtrueraise\box\gre@box@annotation%
    \gre@debugmsg{annotation}{Move to beginning of staff.}%
    \kern\gre@dimen@temp@five %
  \fi %
  \relax %
}%

\def\GreNoInitial{%
  \setbox\gre@box@initial=\hbox{}%
  \global\gre@dimen@initialwidth=0pt %
  \global\grelastoflinecount=2\relax %
  \relax %
}%



\newbox\gre@box@annotation%
\newbox\gre@box@annotation@add%
\newbox\gre@box@annotation@old%

\def\greannotation{\@ifnextchar[{\gre@annotation}{\gre@annotation[c]}}%

\def\gre@annotation[#1]#2{%
  \ifx l#1\relax%
    \let\gre@rightfill\hfil%
    \let\gre@leftfill\relax%
  \else\ifx r#1\relax%
    \let\gre@rightfill\relax%
    \let\gre@leftfill\hfil%
  \else\ifx c#1\relax%
    \let\gre@rightfill\hfil%
    \let\gre@leftfill\hfil%
  \else%
    \greerror{Unrecognzied alignment option for \protect\greannotation}%
  \fi\fi\fi%
  % first we determine the widest box
  \grewidthof{#2}%
  \ifdim\gre@dimen@temp@three < \wd\gre@box@annotation\relax%
    \gre@dimen@temp@three = \wd\gre@box@annotation\relax%
  \fi%
  \setbox\gre@box@annotation@old = \hbox to \gre@dimen@temp@three{\gre@leftfill\copy\gre@box@annotation\gre@rightfill}%
  \setbox\gre@box@annotation@add = \hbox to \gre@dimen@temp@three{\gre@leftfill#2\gre@rightfill}%
  \ifvoid\gre@box@annotation%
    \gre@debugmsg{annotation}{We're on the first line of the annotation.}%
    % This start point has been fudged manually to get the baseline of the first annotation to align with the top line of the staff.
    \gre@debugmsg{annnotation}{Initial set point.}%
    \global\gre@dimen@annotationtrueraise= \ht\gre@box@annotation@add%
    \setbox\gre@box@annotation = \hbox to \gre@dimen@temp@three{\vtop{{\offinterlineskip\vss\noindent\box\gre@box@annotation@add}}}%
  \else%
    \gre@debugmsg{annotation}{We're not on the first line of the annotation.}%
    \setbox\gre@box@annotation = \hbox to \gre@dimen@temp@three{\vtop spread \gre@dimen@annotationseparation{{\offinterlineskip\noindent\box\gre@box@annotation@old\vss\noindent\box\gre@box@annotation@add}}}%
  \fi%
}%


\def\gresetfirstlineaboveinitial#1#2{%
  \gre@deprecated{\protect\gresetfirstlineaboveinitial}{\protect\greannotation}%
  \greannotation{#1}%
}%

\def\gresetfirstannotation#1{%
  \gre@deprecated{\protect\gresetfirstannotation}{\protect\greannotation}%
  \greannotation{#1}%
}%

\let\setfirstannotation\gresetfirstannotation%

\def\gresetsecondannotation#1{%
  \gre@deprecated{\protect\gresetsecondannotation}{\protect\greannotation}%
  \greannotation{#1}%
}%

\let\setsecondannotation\gresetsecondannotation%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the score reference (unused)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grescorereference#1{%
  \relax %
}%

\def\GreScoreReference#1{
  \gre@deprecated{\protect\GreScoreReference}{\protect\grescorereference}%
  \grescorereference{#1}%
}%

\def\scorereference#1{%
  \gre@deprecated{\protect\scorereference}{\protect\grescorereference}%
  \grescorereference{#1}%
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\gre@writemode#1{%
  \greannotation{\gre@style@modeline #1\endgre@style@modeline}%
  \relax %
}%

\def\GreMode#1{%
  \ifhbox \gre@box@annotation%
    \relax%
  \else%
    \ifcase#1%
    \or%
      \gre@writemode{I}%
    \or%
      \gre@writemode{II}%
    \or%
      \gre@writemode{III}%
    \or%
      \gre@writemode{IV}%
    \or%
      \gre@writemode{V}%
    \or%
      \gre@writemode{VI}%
    \or%
      \gre@writemode{VII}%
    \or%
      \gre@writemode{VIII}%
    \fi%
  \fi%
  \relax%
}%

\def\GreAnnotationLines#1#2{%
  \ifhbox \gre@box@annotation%
    \relax%
  \else%
    \greannotation{#1}%
    \greannotation{#2}%
  \fi%
  \relax%
}%

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\GreBeginNotes{%
  \gredrawfirstlines %
  %%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
  \grelocalleftbox{%
    \copy\gre@box@lines %
  }%
  \relax %
}%

\def\grecommentary#1{%
  \vbox{\hfill\hbox{#1}}%
  \relax %
}

\def\commentary#1{%
  \gre@deprecated{\protect\commentary}{\protect\grecommentary}%
  \grecommentary{#1}%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macro for putting text above lines for annotations and the like
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% format for text above the lines
\def\greabovelinestextstyle#1{%
#1\relax %
}%

% set space above the text lines - almost the same as for the translation
\def\greaddspaceabove{%
  \gre@style@abovelinestext%
  \greabovelinestextstyle{%
    \global\gre@dimen@currentabovelinestextheight=\gre@dimen@abovelinestextheight %
    \gregeneratelines %
  }%
  \endgre@style@abovelinestext%
  \relax %
}%

% we don't need space above any more
\def\greremovespaceabove{%
  \global\gre@dimen@currentabovelinestextheight=0 sp%
  \gregeneratelines %
  \relax %
}%

% the code is a bit strange here: we always execute \gre@skip@spaceabovelines at the beginning of a glyph. This will:
% - typeset the text above the lines if relevant, and making sure we execute it only once
% - not do anything else

\xdef\grecurrenttextabovelines{}%

\def\GreSetTextAboveLines#1{%
  \gdef\grecurrenttextabovelines{%
    \gretypesettextabovelines{#1}%
    \gdef\grecurrenttextabovelines{}%
    \relax %
  }%
}%

% typesets the text above the line
\def\gretypesettextabovelines#1{%
  \gre@style@abovelinestext%
  \greabovelinestextstyle{%
    \gre@debugmsg{spacing}{Raise alt text: \gre@dimen@abovelinestextraise}%
    \global\gre@dimen@temp@five=\gre@dimen@abovelinestextraise\relax%
  }%
  \endgre@style@abovelinestext%
  \gre@debugmsg{spacing}{Raise alt text: \the\gre@dimen@temp@five}%
  \advance\gre@dimen@temp@five by 4\gre@dimen@stafflineheight %
  \advance\gre@dimen@temp@five by 4\gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \gre@mark@abovelinestext %
  \gre@debugmsg{spacing}{Raise alt text: \the\gre@dimen@temp@five}%
  \leavevmode\raise\gre@dimen@temp@five\hbox to 0pt{\gre@style@abovelinestext\greabovelinestextstyle{#1}\endgre@style@abovelinestext\hss}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% first a macro to prevent the typesetting of the lines (useful for some people)
\newif\ifgre@showlines%
\gre@showlinestrue

\def\gresetlines#1{%
  \IfStrEq{#1}{visible}%
    {\gre@showlinestrue}%
    {\IfStrEq{#1}{invisible}%
      {\gre@showlinesfalse}%
      {\greerror{Unrecognized option for \protect\gresetlines}}%
    }%
}

\def\greremovelines{%
  \gre@deprecated{\protect\greremovelines}{\protect\gresetlines{invisible}}%
  \gresetlines{invisible}%
}%

\def\gredonotremovelines{%
  \gre@deprecated{\protect\gredonotremovelines}{\protect\gresetlines{visible}}%
  \gresetlines{visible}%
}%

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\gredrawfirstlines{%
  \advance\gre@dimen@stafflinewidth by -\gre@dimen@initialwidth%
  %\advance\gre@dimen@stafflinewidth by -\gre@dimen@minimalspaceatlinebeginning
  %\gre@dimen@initialwidth=0pt
  \hbox to 0pt{%
    \vbox{%
      \gre@style@normalstafflines%
      \grenormalstafflinesformat %
      \vskip\gre@dimen@currentabovelinestextheight %
      \vskip\gre@dimen@additionaltopspace %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \vskip\gre@dimen@spacelinestext %
      \vskip\gre@dimen@spacebeneathtext %
      \vskip\gre@dimen@currenttranslationheight %
      \vskip\gre@dimen@additionalbottomspace %
      \endgre@style@normalstafflines%
    }%
    \hss%
  }%
  \gre@dimen@stafflinewidth=\gre@dimen@linewidth%
  \relax%
}%

%% box containing the stafflines for other lines than the first
\newbox\gre@box@lines%

% macro that must be called at each change of linewidth and grefactor
\def\gregeneratelines{%
  \setbox\gre@box@lines=\hbox to 0pt{%
    \vbox{%
      \gre@style@normalstafflines%
      \grenormalstafflinesformat %
      \vskip\gre@skip@spaceabovelines %
      \vskip\gre@dimen@currentabovelinestextheight %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \gre@skip@temp@four = \gre@dimen@interstafflinespace%
      \kern\gre@skip@temp@four %
      \ifgre@showlines %
        \hrule height \gre@dimen@stafflineheight width \gre@dimen@stafflinewidth %
      \else %
        \vskip\gre@dimen@stafflineheight %
      \fi %
      \vskip\gre@dimen@spacelinestext %
      \vskip\gre@dimen@additionalbottomspace %
      \vskip\gre@dimen@spacebeneathtext %
      \vskip\gre@dimen@currenttranslationheight %
      \endgre@style@normalstafflines %
    }%
    \hss%
  }%
  \relax %
}%

% macro called when the initial is big, and so when the second line is at the same level as the first
\def\gresmallsecondline{%
  \gre@dimen@temp@five=\gre@dimen@stafflinewidth %
  \global\advance\gre@dimen@stafflinewidth by -\gre@dimen@initialwidth %
  \gregeneratelines %
  \global\gre@dimen@stafflinewidth=\gre@dimen@temp@five %
  \relax %
}%

% macro called when we are after the second line of a big initial, to have normal lines back
\def\grenormallines{%
  \global\gre@dimen@stafflinewidth=\gre@dimen@linewidth %
  \gregeneratelines %
  \relax %
}%

% Macro for fustion of larger neumes
\def\GreFuseTwo#1#2{%
  #1\grenobreak #2\relax %
}%

% Macros for using variant glyphs

% Changes a gregorio code point to a variant glyph
% #1 = the name of the gregorio code point
% #2 = font name
% #3 = glyph name, glyph variant name (preceded by .), or code point
\def\grechangeglyph#1#2#3{%
  \directlua{gregoriotex.init_variant_font([[#2]],true)}%
  \directlua{gregoriotex.change_score_glyph([[#1]],[[#2]],[[#3]])}%
}%

% Resets a gregorio code point to its default setting
% #1 = the name of the gregorio code point
\def\greresetglyph#1{%
  \directlua{gregoriotex.reset_score_glyph([[#1]])}%
}%

{%
  \directlua{gregoriotex.init_variant_font('greciliae', true)}%
  \directlua{gregoriotex.map_font('greciliae', 'CP')}%
}%

\input gregoriotex-chars.tex%

\input gregoriotex-signs.tex%

\input gregoriotex-syllable.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the translations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifgre@translationcentering
\gre@translationcenteringfalse

\def\gresettranslationcentering#1{%
  \IfStrEq{#1}{left}%
    {\gre@translationcenteringfalse}%
    {\IfStrEq{#1}{center}%
      {\gre@translationcenteringtrue}%
      {\greerror{Unrecognized option for \protect\gresettranslationcentering}}%
    }%
}%

\def\setgretranslationcenteringscheme#1{%
  \gre@deprecated{\protect\setgretranslationcenteringscheme}{\protect\gresettranslationcentering}%
  \ifnum#1=0\relax%
    \gresettranslationcentering{left}%
  \else%
    \gresettranslationcentering{center}%
  \fi
}%


\newif\ifgre@breakintranslation%
\gre@breakintranslationfalse%

\def\gresetbreakintranslation#1{%
  \IfStrEq{#1}{allow}%
    {\gre@breakintranslationtrue}%
    {\IfStrEq{#1}{prohibit}%
      {\gre@breakintranslationfalse}%
      {\greerror{Unrecognized option in \protect\gresetbreakintranslation}}%
    }%
}%

\def\gresetnlbintranslation#1{%
  \gre@deprecated{\protect\gresetnlbintranslation}{\protect\gresetbreakintranslation}%
  \ifnum#1=0\relax%
    \gresetbreakintranslation{allow}%
  \else%
    \gresetbreakintranslation{prohibit}%
  \fi%
}%

\def\GreWriteTranslation#1{%
  \ifgre@translationcentering %
    \gre@dimen@temp@five=\wd\gre@box@syllabletext %
    \setbox\gre@box@temp@width=\hbox{#1}%
    \advance\gre@dimen@temp@five by -\wd\gre@box@temp@width %
    \divide\gre@dimen@temp@five by 2\relax %
    \gre@mark@translation %
    \kern\gre@dimen@temp@five %
    \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation\gretranslationformat{#1}\endgre@style@translation\hss}}}%
    \kern-\gre@dimen@temp@five %
  \else %
    \gre@mark@translation %
    \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation\gretranslationformat{#1}\endgre@style@translation\hss}}}%
  \fi %
}%

\def\GreWriteTranslationWithCenterBeginning#1{%
  \ifgre@breakintranslation\else%
    \GreBeginNLBArea{0}{1}%
  \fi %
  \gregoriocenterattr=1\relax %
  \gre@mark@translation %
  \raise\gre@dimen@spacebeneathtext\hbox to 0pt{\kern 0pt\vbox to 0pt{\vss\hbox to 0pt{\gre@style@translation\gretranslationformat{#1}\endgre@style@translation\hss}}\kern 0pt}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}%

\xdef\gremustdotranslationcenterend{0}%

\def\GreTranslationCenterEnd{%
  \xdef\gremustdotranslationcenterend{1}%
  \relax %
}%

\def\gredotranslationcenterend{%
  \ifgre@breakintranslation\else%
    \GreEndNLBArea{0}{1}%
  \fi %
  \gregoriocenterattr=2\relax %
  \raise\gre@dimen@spacebeneathtext\hbox to 0pt{}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifgre@justifylastline%
\gre@justifylastlinefalse%

\def\gresetlastline#1{%
  \IfStrEq{#1}{justified}%
    {\gre@justifylastlinetrue}%
    {\IfStrEq{#1}{ragged}%
      {\gre@justifylastlinefalse}%
      {\greerror{Unrecognized option for \protect\gresetlastline}}%
    }%
}%

% make this a count so that it can be read more easily in Lua
\newcount\gre@variableheightexpansion\gre@variableheightexpansion=1\relax %
\def\gresetlineheightexpansion#1{%
  \IfStrEq{#1}{uniform}%
    {\gre@variableheightexpansion=0\relax }%
    {\IfStrEq{#1}{variable}%
      {\gre@variableheightexpansion=1\relax }%
      {\greerror{Unrecognized option for \protect\gresetlineheightexpansion}}%
    }%
}%

% gregorioattr (see its definition in gregorio-syllable) is 0 when we are in a score, and unset when we are not

\newif\ifgre@save@englishcentering% DEPRECATED

%macro called at the beginning of a score
% #1 is the gabc score id
% #2 is the high height
% #3 is the low height
% #4 is 1 if there is a translation somewhere
% #5 is if 1 if we have space above the staff
% #6 is the point-and-click filename
\def\GreBeginScore#1#2#3#4#5#6{%
  \global\setluatexattribute\gre@attr@glyph@id{0}%
  \xdef\gre@gabcname{#6}%
  \global\let\ifgre@save@englishcentering\ifgre@vowelcentering\relax % DEPRECATED
  \ifgre@justifylastline%
    \xdef\gre@save@parfillskip{\the\parfillskip}
    \parfillskip=0pt plus 0pt minus 0pt\relax%
  \fi %
  \ifnum\greusestylefont=1\relax %
    \gresetstylefont %
  \fi %
  \gre@computespaces%
  \grecancelpenalties %
  \gredofinetuning %
  \gregorioattr=0\relax %
  \xdef\greexhyphencharsave{\the\exhyphenchar}%
  \exhyphenchar=-1\relax %
  \gregeneratelines %
  \noindent%
  \gre@calculate@additionalspaces{#2}{#3}{#4}{#5}%
  \directlua{
    gregoriotex.atScoreBeginning([[#1]], #2, #3, #4, #5,
        \gre@pitch@adjust@top, \gre@pitch@adjust@bottom)
    gregoriotex.adjust_line_height(1)
  }%
  %TODO do something like LaTeX's AtBeginDocument
  \ifdefined\optgabcAtScoreBeginning %
    \optgabcAtScoreBeginning %
  \fi %
  \global\greknownline=1\relax %
  \relax%
}%

%macro called at the end of a score
\def\GreEndScore{%
  \global\grelastoflinecount=0\relax %
  \global\greseteolcustos{auto}%
  \GreEndEUOUAE{}%
  \ifnum\grenlbstate=0\else %
    \GreEndNLBArea{2}{0}%
  \fi %
  \grelocalleftbox{}%
  \ifnum\keeprightbox=0\relax %
    \grelocalrightbox{}%
  \fi %
  \hfil %
  \par %
  \ifnum\keeprightbox=1\relax %
    \global\keeprightbox=0\relax %
  \fi%
  \greunsetattribute %
  % with some versions of LuaTeX, the \localrightbox and \localleftbox must be set empty in an environment with the good attributes set
  \grelocalleftbox{}%
  \grelocalrightbox{}%
  \gre@calculate@additionalspaces{\gre@pitch@g}{\gre@pitch@g}{0}{0}%
  \global\gre@dimen@currentabovelinestextheight=0 sp%
  \gre@removetranslationspace %
  \grenormalinitial %
  \grerestorepenalties %
  \greendfinetuning %
  \exhyphenchar=\greexhyphencharsave %
  \gre@dimen@temp@one=0pt%
  \gre@dimen@temp@two=0pt%
  \gre@dimen@temp@three=0pt%
  \gre@dimen@temp@four=0pt%
  \gre@dimen@temp@five=0pt%
  \gre@skip@temp@one=0pt%
  \gre@skip@temp@two=0pt%
  \gre@skip@temp@three=0pt%
  \gre@skip@temp@four=0pt%
  \directlua{gregoriotex.atScoreEnd()}%
  \unsetluatexattribute{\gre@attr@glyph@id}%
  \unsetluatexattribute{\gre@attr@glyph@top}%
  \unsetluatexattribute{\gre@attr@glyph@bottom}%
  \ifgre@justifylastline%
    \parfillskip=\gre@save@parfillskip\relax%
  \fi %
  \global\let\ifgre@vowelcentering\ifgre@save@englishcentering\relax % DEPRECATED
  \relax%
}%

% macro called at the end of a bar. Almost the same, but not for the penalties
\def\greendafterbar#1{%
  \grepenalty{\greendafterbarpenalty }\relax %
  \ifnum#1=1\relax %
    \gre@debugmsg{ifdim}{ enddifference > 0pt}%
    \ifdim\gre@dimen@enddifference > 0 pt %
      \gre@debugmsg{ifdim}{ nextbegindifference > 0pt}%
      \ifdim\gre@skip@nextbegindifference > 0 pt %
        \gre@skip@temp@four = \gre@skip@notebarspace%
        \grehskip\gre@skip@temp@four %
      \else % (next begin difference >0pt)
        \gre@skip@temp@four = \gre@skip@textbartextspace%
        \grehskip\gre@skip@temp@four %
      \fi %
    \else%(enddifference < Opt)
      \gre@debugmsg{ifdim}{ nextbegindifference < 0pt}%
      \ifdim\gre@skip@nextbegindifference < 0 pt %
        \gre@skip@temp@four = \gre@skip@textbartextspace%
        \grehskip\gre@skip@temp@four %
      \else %(next begin difference < 0 pt)
        \gre@skip@temp@four = \gre@skip@interwordspacetext%
        \grehskip\gre@skip@temp@four %
      \fi %
    \fi %
  \fi %
  %\grepenalty{\greendafterbarpenalty }\relax 
  %\global\gre@dimen@enddifference=0pt 
  \relax %
}%

\newcount\grelastoflinecount%

% TODO: case where we're at the beginning *and* end of a line... quite rare case though...
% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf if written in plainTeX)
% 0 if nothing
% 1 if the syllable is the last of the line
% 2 after it has finished the syllable, so when it is two it means that the syllable is the first of a line
\def\GreLastOfLine{%
  \global\grelastoflinecount=1\relax%
  \relax%
}%

% same as above, but for the score. For now it is the same behaviour.
\def\GreLastOfScore{%
  %\grelocalleftbox{}% For an unknown reason, if I uncomment this line, the
  %blank line removing algorithm (in lua) will let some blank space after the
  %last line... (see bug #20953)
  \greseteolcustos{manual}%
  \global\grelastoflinecount=1\relax%
  \relax%
}%

% a flag to disable (or reenable) the left shift for first syllables of scores
\newif\ifgre@eolshiftsenabled%
% default state is for them to be enabled
\gre@eolshiftsenabledtrue

\def\greseteolshifts#1{%
  \IfStrEq{#1}{enable}%
    {\gre@eolshiftsenabledtrue}%
    {\IfStrEq{#1}{disable}%
      {\gre@eolshiftsenabledfalse}%
      {\greerror{Unrecognized option in \protect\greseteolshifts}}%
    }%
}%

\def\gredisableeolshifts{%
  \gre@deprecated{\protect\gredisableeolshifts}{\protect\greseteolshifts{disable}}%
  \gre@eolshiftsenabledfalse%
}%

\def\greenableeolshifts{%
  \gre@deprecated{\protect\greenableeolshifts}{\protect\greseteolshifts{enable}}%
  \gre@eolshiftsenabledtrue%
}%

% a count that is 1 if we block the custos, and 0 if we don't. We just block custos at the end of a score, to prevent a bug.
\newif\ifgre@blockeolcustos%
\gre@blockeolcustosfalse%

\def\greseteolcustos#1{%
  \IfStrEq{#1}{manual}%
    {%
      \gre@blockeolcustostrue%
      \grelocalrightbox{}%
    }%
    {\IfStrEq{#1}{auto}%
      {\gre@blockeolcustosfalse}%
      {\greerror{Unrecognized option for \protect\greseteolcustos}}%
    }%
}%

% macro to suppress the custos
\def\greblockcustos{%
  \gre@deprecated{\protect\greblockcustos}{\protect\greseteolcustos{manual}}%
  \greseteolcustos{manual}%
}%

% macro to end elements, #1 is the type of space, it can be :
%% 0: default space
%% 1: larger space
%% 2: glyph space
%% 3: zero-width space
% #2 is if the space is unbreakable (1) or not (0)
\def\GreEndOfElement#1#2{%
  \ifnum #2=0\relax %
    \grepenalty{\greendofelementpenalty}%
  \else %
    \grenobreak %
  \fi %
  \ifcase#1%
    \gre@skip@temp@four = \gre@skip@interelementspace%
    \grehskip\gre@skip@temp@four %
  \or% case 1
    \gre@skip@temp@four = \gre@skip@largerspace%
    \grehskip\gre@skip@temp@four %
  \or% case 2
    \gre@skip@temp@four = \gre@skip@glyphspace%
    \grehskip\gre@skip@temp@four %
  \fi%
  \ifnum #2=1\relax %
    \grenobreak %
  \fi %
\relax%
}%

% macro to end a glyph without ending the element, argument is the type of space, it can be :
%% 0: default space
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 7: space between a punctum inclinatum and a punctum inclinatum deminutus
%% 8: space between two puncta inclinata deminuti
%% 4: space between bivirga or trivirga
%% 5: space between bistropha or tristropha
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
%% 10: space between puncta inclinata (also debilis for now), larger ambitus (range=3rd).
%% 11: space between puncta inclinata (also debilis for now), larger ambitus (range=4th or more)
\def\GreEndOfGlyph#1{%
  \grenobreak %
  \ifcase#1%
    \gre@skip@temp@four = \gre@skip@interglyphspace%
    \grehskip\gre@skip@temp@four %
  \or% case 1
    \gre@skip@temp@four = \gre@dimen@zerowidthspace%
    \grehskip\gre@skip@temp@four %
  \or% case 2
    \gre@skip@temp@four = \gre@skip@alterationspace%
    \grehskip\gre@skip@temp@four %
  \or% case 3
    \gre@skip@temp@four = \gre@skip@punctuminclinatumshift%
    \grehskip\gre@skip@temp@four %
  \or% case 4
    \gre@skip@temp@four = \gre@skip@bitrivirspace%
    \grehskip\gre@skip@temp@four %
  \or% case 5
    \gre@skip@temp@four = \gre@skip@bitristrospace%
    \grehskip\gre@skip@temp@four %
  \or% case 6
    \gre@skip@temp@four = \gre@skip@spaceaftersigns%
    \grehskip\gre@skip@temp@four %
  \or% case 7
    \gre@skip@temp@four = \gre@skip@punctuminclinatumanddebilisshift%
    \grehskip\gre@skip@temp@four %
  \or% case 8
    \gre@skip@temp@four = \gre@skip@punctuminclinatumdebilisshift%
    \grehskip\gre@skip@temp@four %
  \or% case 9
    \gre@skip@temp@four = \gre@skip@beforepunctainclinatashift%
    \grehskip\gre@skip@temp@four %
  \or% case 10
    \gre@skip@temp@four = \gre@skip@punctuminclinatumbigshift%
    \grehskip\gre@skip@temp@four %
  \or% case 11
    \gre@skip@temp@four = \gre@skip@punctuminclinatummaxshift%
    \grehskip\gre@skip@temp@four %
  \fi%
  \grenobreak %
  \relax%
}%

% The different states of line break areas:
% 0: not currently in a no line break area
% 1: no line break area due to translation centering
% 2: no line break area due to <nlba> tag
\xdef\grenlbstate{0}%

% first argument is if if the nlba is starting in neumes or not
% second argument is if it is called from translation centering or not
\def\GreBeginNLBArea#1#2{%
  \xdef\grenlbinitialstate{\grenlbstate}%
  \ifnum#2=0\relax %
    \xdef\grenlbstate{2}%
  \else %
      \ifcase\grenlbstate %
        \xdef\grenlbstate{1}%
      \or %
        \xdef\grenlbstate{1}%
      \or %
        \xdef\grenlbstate{2}%
      \fi %
  \fi %
  \ifnum\grenlbinitialstate=0\relax %
      \xdef\grenobreakpenaltysave{\grenobreakpenalty }%
      \xdef\grenobreakpenalty{10001}%
      \xdef\grenolastlinepenaltysave{\grenolastlinepenalty }%
      \xdef\grenolastlinepenalty{10001}%
      \xdef\greendofwordpenaltysave{\greendofwordpenalty }%
      \xdef\greendofwordpenalty{10001}%
      \xdef\greendofsyllablepenaltysave{\greendofsyllablepenalty }%
      \xdef\greendofsyllablepenalty{10001}%
      \xdef\greendafterbarpenaltysave{\greendafterbarpenalty }%
      \xdef\greendafterbarpenalty{10001}%
      \xdef\greendafterbaraltpenaltysave{\greendafterbaraltpenalty }%
      \xdef\greendafterbaraltpenalty{10001}%
      \xdef\greendofelementpenaltysave{\greendofelementpenalty }%
      \xdef\greendofelementpenalty{10001}%
      \xdef\grehyphenpenaltysave{\grehyphenpenalty }%
      \xdef\grehyphenpenalty{10001}%
  \fi %
}%

\def\GreEndNLBArea#1#2{%
  \xdef\grenlbinitialstate{\grenlbstate}%
  \ifnum#2=0\relax %
    \xdef\grenlbstate{0}%
  \else %
      \ifcase\grenlbstate %
        \xdef\grenlbstate{0}%
      \or %
        \xdef\grenlbstate{0}%
      \or %
        \xdef\grenlbstate{2}%
      \fi %
  \fi %
  % if grenlbstate is not 0, then nothing should happend
  \ifnum\grenlbstate=0\relax %
    \ifnum\grenlbinitialstate=0\else %
      \xdef\grenobreakpenalty{\grenobreakpenaltysave }%
      \xdef\grenolastlinepenalty{\grenolastlinepenaltysave}%
      \xdef\greendofwordpenalty{\greendofwordpenaltysave}%
      \xdef\greendofsyllablepenalty{\greendofsyllablepenaltysave}%
      \xdef\greendafterbarpenalty{\greendafterbarpenaltysave}%
      \xdef\greendafterbaraltpenalty{\greendafterbaraltpenaltysave}%
      \xdef\greendofelementpenalty{\greendofelementpenaltysave}%
      \xdef\grehyphenpenalty{\grehyphenpenaltysave}%
      \ifcase #1\relax % 0
        \grepenalty{\greendofelementpenalty}%
      \or % 1
        \grepenalty{\greendofsyllablepenalty}%
      \or % 2
        % end of score, no penalty needs to be added
      \or % 3
        % before bar, no penalty should to be added
      \fi %
    \fi %
  \fi %
}%

\newif\ifgre@euouae@implies@nlba
\gre@euouae@implies@nlbatrue

\def\gresetbreakineuouae#1{%
  \IfStrEq{#1}{allow}%
    {\gre@euouae@implies@nlbafalse}%
    {\IfStrEq{#1}{prohibit}%
      {\gre@euouae@implies@nlbatrue}%
      {\greerror{Unrecognized option in \protect\gresetbreakineuouae}}%
    }%
}%


\newif\ifgre@in@euouae
\gre@in@euouaefalse

\def\GreBeginEUOUAE{%
  \ifgre@euouae@implies@nlba %
    \GreBeginNLBArea{0}{0}%
  \fi %
  \gre@in@euouaetrue %
}

\def\GreEndEUOUAE#1{%
  \ifgre@euouae@implies@nlba %
    \GreEndNLBArea{#1}{0}%
  \fi %
  \gre@in@euouaefalse %
}

\input gregoriotex-symbols.tex%

%%%%%%%%%
%% fonts
%%%%%%%%%

\def\GreTilde{%
  \ensuremath{\sim}%
  \relax %
}%


\def\gresetgregoriofont{\@ifnextchar[{\gre@setgregoriofont}{\gre@setgregoriofont[]}}%

\def\gre@setgregoriofont[#1]#2{%
  \ifx#1\gre@nothing %
    \xdef\gregoriofontname{#2}%
    \gre@loadgregoriofont%
    \gdef\GreCPVirgaReversaAscendensOnDLine##1{##1}%
  \else %
    \xdef\gregoriofontname{#2-#1}%
    \gre@loadgregoriofont%
    \gdef\GreCPVirgaReversaAscendensOnDLine##1{\GreCPVirgaReversaLongqueueAscendens}%
  \fi %
  \relax %
}%

\def\gre@loadgregoriofont{%
  \gre@count@temp@three = \the\grefactor %
  \multiply\gre@count@temp@three by 100000 %
  \global\font\gregoriofont={name:\gregoriofontname} at \the\gre@count@temp@three sp%
  {\gregoriofont\directlua{gregoriotex.check_font_version() gregoriotex.scale_score_fonts([[\the\gre@count@temp@three]])}}%
  \relax%
}%

% the default gregorio font
\gresetgregoriofont{greciliae}%

\xdef\greusestylefont{0}%

% gregoriostylefont is the font used for additional glyphs
\def\gresetstylefont{%
  \gre@count@temp@three = \the\grefactor %
  \multiply\gre@count@temp@three by 100000\relax %
  \global\font\gregoriostylefont={name:greextra} at \the\gre@count@temp@three sp%
  {\gregoriofont\directlua{gregoriotex.check_font_version() gregoriotex.scale_score_fonts([[\the\gre@count@temp@three]])}}%
  \relax%
}%

\def\gretranslationformat#1{%
  \GreItalic{#1}%
  \relax %
}%

\def\grenormalstafflinesformat{%
  \relax %
}%

\def\greadditionalstafflinesformat{%
  \relax %
}%

\def\GreSetStaffLinesFormat#1{%
  \gre@deprecated{\protect\GreSetStaffLinesFormat}{\protect\grechangestyle{normalstafflines}}%
  \gre@changestyle{normalstafflines}{#1}[\relax]%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Master function for changing element formats
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grechangestyle#1#2{%
  \@ifnextchar[{\gre@changestyle{#1}{#2}}{\gre@changestyle{#1}{#2}[\relax]}%
}%

% because the mechanism for the defining the formats differs under LaTeX and PlainTeX the underlying function which does the work is defined in gregoriotex.sty or gregoriotex.tex respectively.


%%%%%%%%%%%%%%%%%%%
%% changing staff size
%%%%%%%%%%%%%%%%%%%

\def\grechangestaffsize#1{%
  \ifnum#1<0\relax%
    \greerror{Staff size must be a positive integer.}%
  \else%
    \gre@changedimenfactor{\grefactor}{#1}%
    \global\grefactor=#1\relax %
  \fi%
  \gre@loadgregoriofont%
  \relax %
}%

\def\setgrefactor#1{%
  \gre@deprecated{\protect\setgrefactor}{\protect\grechangestaffsize}%
  \grechangestaffsize{#1}%
}%

%%%%%%%%%%%%%%%%%%%
%% score including
%%%%%%%%%%%%%%%%%%%

% Flag to track compilation behavior
% 0 = never compile (default)
% 1 = auto compile (compile outdated scores and those lacking a compiled version)
% 2 = compile all scores
\def\gre@compilegabc{0}

% User macro to change compilation behavior
\def\gresetcompilegabc#1{%
  \IfStrEq{#1}{force}{\gdef\gre@compilegabc{2}}{%
    \IfStrEq{#1}{auto}{\gdef\gre@compilegabc{1}}{%
      \IfStrEq{#1}{never}{\gdef\gre@compilegabc{0}}{%
        \greerror{Unrecognized argument for \protect\gresetcompilegabc.}%
      }%
    }%
  }%
}%


% User macro to force gregriotex to recompile gabc files. Useful for when there
% are changes to gregoriotex but the GREGORIOTEX API VERSION is not changed.
\def\forcecompilegabc{%
  \gre@deprecated{\protect\forcecompilegabc}{\protect\gresetcompilegabc{force}}%
  \gresetcompilegabc{force}
}%

% User macro to let gregoriotex auto recompile gabc files as necessary.
% Intended to be used in the main tex file to revert the previous macro.
\def\autocompilegabc{%
  \gre@deprecated{\protect\autocompilegabc}{\protect\gresetcompilegabc{auto}}%
  \gresetcompilegabc{auto}
}%

% User macro to force score inclusion without compilation.
\def\nevercompilegabc{%
  \gre@deprecated{\protect\nevercompilegabc}{\protect\gresetcompilegabc{never}}%
  \gresetcompilegabc{never}
}


% Internal marco which includes a score when \gregorioscore is called without the optional argument.  Behavior is determined by the value of \gre@compilegabc flag.
%
% If \gre@compilegabc is 0, then we simply try to include the file as it is given to us.  This is the old behavior.
%
% If \gre@compilegabc is 1, tell the lua function to check that:
%	-- The gtex file exists.
%	-- The gtex file is of the correct gregoriotexapi_version.
%	-- The gtex file is 'newer' than it's corresponding gabc file.
% If any test fails, the gabc file is (re)compiled.
%
% If \gre@compilegabc is 2, pass true to the lua function.
% This forces gregoriotex to recompile the gabc file.

\def\gre@gregorioscore#1{%
  \ifcase\gre@compilegabc% case 0, never compile
    \gre@debugmsg{compile}{Refusing to compile #1}%
    \input #1%
  \or% case 1, auto compile
    \gre@debugmsg{compile}{Auto compile #1}%
    \directlua{gregoriotex.include_score([[#1]], nil)}%
  \or% case 2, force compile
    \gre@debugmsg{compile}{Forced to compile #1}%
    \directlua{gregoriotex.include_score([[#1]], true)}%
  \fi%
  \relax%
}%

\def\includetexscore#1{%
  \gre@warning{\protect\includetexscore\space is obsolete. \MessageBreak Use \protect\gregorioscore[n]\space instead}%
}%

\def\greincludetexscore#1{%
  \gre@warning{\protect\greincludetexscore\space is obsolete.\MessageBreak Use \protect\gregorioscore[n]\space instead}%
}%

\def\includegabcscore#1{%
  \gre@warning{\protect\includegabcscore\space is obsolete.\MessageBreak Use \protect\gregorioscore[c]\space instead}%
}%

\def\greincludegabcscore#1{%
  \gre@warning{\protect\greincludegabcscore\space is obsolete.\MessageBreak Use \protect\gregorioscore[c]\space instead}%
}%

% The internal macro called when \gregorioscore is called with the optional argument.  Behavior is determined by the value of the argument:
% n - do not attempt to compile the score.  Simply include it as is.
% a - perform the checks to see if the score needs to be recompiled and do so only if necessary
% f - force the compilation of the score before including it
\def\gre@gregorioscore@option[#1]#2{%
  \ifx #1n\relax%
    \gre@debugmsg{compile}{Override not compiling #2}%
    \input #2%
  \else%
    \ifx #1f\relax%
      \gre@debugmsg{compile}{Override force compiling #2}%
      \directlua{gregoriotex.include_score([[#2]], true)}%
    \else%
      \ifx #1a\relax%
        \gre@debugmsg{compile}{Override auto compiling #2}%
        \directlua{gregoriotex.include_score([[#2]], nil)}%
      \else%
        \greerror{Unrecognized option [#1] for \protect\includescore}%
      \fi%
    \fi%
  \fi%
  \relax%
}%

% The main macro used by the user to input scores into the document.

\def\includescore{%
  \gre@deprecated{\protect\includescore}{\protect\gregorioscore}%
  \gregorioscore
}%

\def\gregorioscore{\@ifnextchar[{\gre@gregorioscore@option}%
    {\gre@gregorioscore}%
}%

% If called without the optional argument: '\gregorioscore{Antiphon}'
% the filename will be passed to the lua function 'include_score'
% which will check: whether the gtex file exists, if the API version
% of the gtex file, or if the gabc file is newer than the gtex
% file. If one of these tests fails, the gabc file will be
% (re)compiled.
% The argument may or may not include a file extension. These are all valid:
% '\gregorioscore{Antiphon}' or '\gregorioscore{Antiphon.gabc}' or
% '\gregorioscore{Antiphon.gtex}'

% If called with the optional argument: '\gregorioscore[f]{Antiphon.gtex}'
% the gtex file will be forced into the document and will not be
% checked by the lua function 'include_score'. This does not bypass
% the API version test done by '\GregorioTeXAPIVersion'.

% Macros for compiling short snippets of GABC directly expressed in TeX

\long\def\gre@gabcsnippet@option[#1]#2{%
  \directlua{gregoriotex.direct_gabc("\luatexluaescapestring{\unexpanded\expandafter{#2}}", "initial-style: #1;")}%
}%

\long\def\gre@gabcsnippet#1{%
  \directlua{gregoriotex.direct_gabc("\luatexluaescapestring{\unexpanded\expandafter{#1}}")}%
}%

\def\gabcsnippet{\@ifnextchar[{\gre@gabcsnippet@option}{\gre@gabcsnippet}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% some hyphen definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a zero-width hyphen, useful for fine tuning line endings. To input in gabc verb for example.
\def\GreZeroHyph{%
  \hbox to 0pt{%
  \char\the\hyphenchar\font %
  \hss %
  }%
}%

% a normal hyphen
\def\grenormalhyph{%
  %-
  \char\the\hyphenchar\font %
}%

% the definition that will be always used for end of lines hyphens in gregorio, except if one of the two before is explicitely used
\let\GreHyph\grenormalhyph %

% macro to change the definition of the hyphen:
\def\greseteolhyphen#1{%
  \IfStrEq{#1}{normal}%
    {\global\let\GreHyph\grenormalhyph}%
    {\IfStrEq{#1}{zero}%
      {\global\let\GreHyph\GreZeroHyph}%
      {\greerror{Unrecognized option for \protect\greseteolhyphen}}%
    }%
}%

\def\GreUseNormalHyphen{%
  \gre@deprecated{\protect\GreUseNormalHyphen}{\protect\greseteolhyphen{normal}}%
  \greseteolhyphen{normal}%
}%

\def\GreUseZeroHyphen{%
  \gre@deprecated{\protect\GreUseZeroHyphen}{\protect\greseteolhyphen{zero}}%
  \greseteolhyphen{zero}%
}%

% macro to force hyphenation of all syllables.
\def\gresethyphen#1{%
  \IfStrEq{#1}{force}%
    {\global\grechangedim{maximumspacewithoutdash}{-16383.99999pt}{0}}%
    {\IfStrEq{#1}{auto}%
      {\global\grechangedim{maximumspacewithoutdash}{0.02 cm}{1}}%
      {\greerror{Unrecognized option in \protect\gresethyphen}}%
    }%
}%

% We load the default space configuration.
\greloadspaceconf{default}%

\input gregoriotex-nabc.tex
