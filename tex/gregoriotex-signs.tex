%GregorioTeX file.
%
% Copyright (C) 2007-2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.


% this file contains definitions of signs (bar, episemus, punctum, alterations)

\def\grebarbracewidth{.58879}%

\gre@declarefileversion{gregoriotex-signs.tex}{4.0.0-beta}% GREGORIO_VERSION

\def\gre@usestylecommon{%
  \ifgre@usestylefont\else %
    \gre@usestylefonttrue%
    \gre@setstylefont %
  \fi %
  \relax %
}%

\gresetglyphstyle{default}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for discretionaries
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% In order to avoid clef change at beginning or end of line, we use discretionaries
% for clef change, or even with more complex data (z0::c3 for instance). The problem
% with discretionaries is that:
% - you cannot use \hskip (but you can use kern)
% - you cannot use \penalty (which is useless indeed)
%
% To remedy that, we define \grehskip to be \hskip outside a discretionary, and
% \kern inside a discretionary. This is what these macros do:

\def\gre@falsepenalty#1{}%
\def\gre@truepenalty#1{\penalty#1}%

\let\grehskip\hskip%
\let\gre@penalty\gre@truepenalty%
\xdef\gre@insidediscretionary{\number 0}%

\def\GreDiscretionary#1#2{%
  \global\let\grehskip\kern %
  \global\let\gre@penalty\gre@falsepenalty %
  \global\xdef\gre@insidediscretionary{\number 1}%
  \discretionary{%
    \global\gre@lastoflinecount=1\relax % (a good magic trick)
    #1%
    }{%
    \global\gre@lastoflinecount=2\relax % (a good magic trick)
    }{%
    #2%
    }%
  \global\xdef\gre@insidediscretionary{\number 0}%
  \global\let\grehskip\hskip %
  \global\let\gre@penalty\gre@truepenalty %
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the clefs of the beginning of lines and custos
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% flag for showing the clef
\newif\ifgre@showclef%
\gre@showcleftrue

\def\gresetclef#1{%
  \IfStrEq{#1}{visible}%
    {\gre@showcleftrue}%
    {\IfStrEq{#1}{invisible}%
      {\gre@showcleffalse}
      {\gre@error{Unrecognized option for \protect\gresetclef}}%
    }%
}%


\def\greremoveclef{%
  \gre@deprecated{\protect\greremoveclef}{\protect\gresetclef{invisible}}%
  \gresetclef{invisible}%
}%

\def\grenormalclef{%
  \gre@deprecated{\protect\grenormalclef}{\protect\gresetclef{visible}}%
  \gresetclef{visible}%
}%

% a count describing the clef line and pitch : 1 for c on the first (bottom) line, 2 for c on the second line, 5 for f on the first, etc.
\newcount\gre@clefnum%

%% marcro to define the clef that will appear at the beginning of the lines
% the first argument is the type : f or c, and the second is the height
% the third argument is whether we must type a space after or not (0 if not, 1 if yes)
% if the fourth argument is a, it means that we must not put a flat after the key, otherwise it's the height of the flat
\def\GreSetLinesClef#1#2#3#4{%
  \grelocalleftbox{%
    \gre@skip@temp@four = \gre@dimen@additionalleftspace%
    \kern\gre@skip@temp@four %
    \copy\gre@box@lines% draws the lines
    \unkern %
    \ifgre@showclef%
      \gre@skip@temp@four = \gre@skip@afterclefnospace%
      \hbox{\gre@typekey{#1}{#2}{0}{#3}{#4}\hskip\gre@skip@temp@four}%
    \else %
      \gre@skip@temp@four = \gre@dimen@noclefspace%
      \hbox{\kern\gre@skip@temp@four}%
    \fi %
  }%
  \xdef\gre@clefflat{#4}%
  \relax%
}%

%% macro calculating the \gre@clefnum from the letter and number
% #1 is the letter, and #2 the line number, #3 is a if not flated
% and otherwise the height of the flat
\def\gre@calculate@clefnum#1#2#3{%
  \global\gre@clefnum=#2\relax %
  \ifx f#1%
    \global\advance\gre@clefnum by 4\relax %
  \fi %
  \relax %
}%

%% macro redrawing a key from clefnum, useful for vertical space changes
\def\gre@updatelinesclef{%
  \ifnum\gre@clefnum > 5\relax%
    \gre@count@temp@three=\gre@clefnum %
    \advance\gre@count@temp@three by -4\relax %
    \GreSetLinesClef{f}{\gre@count@temp@three}{1}{\gre@clefflat}%
  \else %
    \GreSetLinesClef{c}{\gre@clefnum}{1}{\gre@clefflat}%
  \fi %
  \relax %
}%

% macro that typesets the key
% arguments are : 
%% #1: the type of the key : c or f
%% #2: the line of the key (1 is the lowest)
%% #3: if we must use small key characters (inside a line) or not 0: if not inside, 1 if inside
%% #4: if we must type a space after or not
%% #5: if 3, it means that we must not put a flat after the key, otherwise it's the height of the flat
\def\gre@typekey#1#2#3#4#5{%
  \ifcase#2 %
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@c}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}%
  \or%
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
  \fi%
  \gre@skip@temp@two=\gre@skip@spaceafterlineclef %
  \ifnum#4=0\relax %
    \gre@skip@temp@two=\gre@skip@afterclefnospace %
  \fi %
  \ifx c#1% we check if it is a c key
    \ifcase#3%
      \raise\gre@dimen@glyphraisevalue\hbox{\gre@fontchar@cclef}%\hskip\gre@skip@temp@two}
      \setbox\gre@box@temp@width=\hbox{\gre@fontchar@cclef}%
      \global\gre@dimen@clefwidth=\wd\gre@box@temp@width %
    \or%
      \raise\gre@dimen@glyphraisevalue\hbox{\gre@fontchar@incclef}%\hskip\gre@skip@temp@two}
    \fi%
  \else % we consider that it is a f key
    \ifcase#3%
      \raise\gre@dimen@glyphraisevalue\hbox{\gre@fontchar@fclef}%\hskip\gre@skip@temp@two}
      \setbox\gre@box@temp@width=\hbox{\gre@fontchar@fclef}%
      \global\gre@dimen@clefwidth=\wd\gre@box@temp@width %
    \or%
      \raise\gre@dimen@glyphraisevalue\hbox{\gre@fontchar@infclef}%\hskip\gre@skip@temp@two}
    \fi%
  \fi%
  \ifnum#5=3%
    \grehskip\gre@skip@temp@two %
  \else %
    \gre@skip@temp@four = \gre@skip@clefflatspace%
    \grehskip\gre@skip@temp@four %
    \GreFlat{#5}{1}%
    \grehskip\gre@skip@temp@two %
  \fi %
  \relax %
}%

% macro that writes the initial key, and sets the next keys to the same value
% if #3 is a, it means that we must not put a flat after the key, otherwise it's the height
% of the flat
\def\GreSetInitialClef#1#2#3{%
  \gre@calculate@clefnum{#1}{#2}{#3}%
  \ifgre@showclef%
    \gre@typekey{#1}{#2}{0}{1}{#3}%
  \fi %
  \GreSetLinesClef{#1}{#2}{1}{#3}%
  % if the initial is big, then we adjust the second line
  \ifnum\gre@biginitial=0\relax %
  \else %
    \GreAdjustSecondLine %
  \fi %
  \relax%
}%

% macro called when the key changes
% #1 and #2 are the type and line of the clef
% #3 is 1 or 0 according to the need of a space before the clef. Useful for clefs after bars for example
% if #4 is a, it means that we must not put a flat after the key, otherwise it's the height
% of the flat
\def\GreChangeClef#1#2#3#4{%
  % it makes no sense to change the clef when there is no clef...
  \gresetclef{visible}%
  \gre@calculate@clefnum{#1}{#2}{#4}%
  \ifnum\gre@insidediscretionary=0\relax %
    \GreSetLinesClef{#1}{#2}{1}{#4}%
  \fi %
  \ifnum#3=1\relax %
    \gre@skip@temp@four = \gre@skip@clefchangespace%
    \grehskip\gre@skip@temp@four %
  \else %
    % here it means that there is a bar before the clef, so we skip the difference between the normal space and the space around bars with clef changes
    \gre@skip@temp@four = -\gre@skip@spacearoundclefbars%
    \grehskip\gre@skip@temp@four %
  \fi %
  \gre@typekey{#1}{#2}{1}{0}{#4}%
  \gre@skip@temp@four = \gre@skip@clefchangespace%
  \grehskip\gre@skip@temp@four %
  \relax%
}%


% custo just typesets a custo, useful for before the key changes for example
\def\GreCusto#1{%
  \gre@calculate@glyphraisevalue{#1}{0}%
  %here we need some tricks to draw the line before the custo (for the color)
  \setbox\gre@box@temp@width=\hbox{\gre@pickcusto{#1}}%
  \gre@dimen@temp@three=\wd\gre@box@temp@width %
  \ifgre@showlines %
    \ifnum#1=\gre@pitch@a\relax %
      \gre@additionalbottomcustolinemiddle %
    \else\ifnum#1=\gre@pitch@b\relax %
      \gre@additionalbottomcustolinemiddle %
    \else\ifnum#1=\gre@pitch@l\relax %
      \gre@additionaltopcustolinemiddle %
    \else\ifnum#1=\gre@pitch@m\relax %
      \gre@additionaltopcustolinemiddle %
    \fi\fi\fi\fi %
  \fi %
  \raise \gre@dimen@glyphraisevalue%
  \copy\gre@box@temp@width %
  % for now we consider we always have a bar after the custo
  % we don't want to end the line here
  \GreNoBreak %
  \gre@skip@temp@four = -\gre@skip@spacearoundclefbars%
  \grehskip\gre@skip@temp@four %
  \GreNoBreak %
  \relax %
}%

% the argument is the height
\def\gresetcusto#1{%
  \ifnum\gre@insidediscretionary=0\relax %
    \ifgre@blockeolcustos\else%
      \gre@calculate@glyphraisevalue{#1}{0}%
      %here we need some tricks to draw the line before the custo (for the color)
      \setbox\gre@box@temp@width=\hbox{%
      % we type a hskip and the we type the custo
      \gre@skip@temp@four = \gre@skip@spacebeforecusto%
      \hskip\gre@skip@temp@four %
      \gre@pickcusto{#1}\relax %
      }%
      \gre@dimen@temp@three=\wd\gre@box@temp@width %
      % we make \wd\gre@box@temp@sign contain the width of a custo
      \setbox\gre@box@temp@sign=\hbox{%
      \gre@pickcusto{#1}\relax %
      }%
      \grelocalrightbox{%
      \ifgre@showlines %
        \ifnum#1=\gre@pitch@a\relax %
          \gre@additionalbottomcustolineend %
        \else\ifnum#1=\gre@pitch@b\relax %
          \gre@additionalbottomcustolineend %
        \else\ifnum#1=\gre@pitch@l\relax %
          \gre@additionaltopcustolineend %
        \else\ifnum#1=\gre@pitch@m\relax %
          \gre@additionaltopcustolineend %
        \fi\fi\fi\fi %
      \fi %
      \raise \gre@dimen@glyphraisevalue%
      \copy\gre@box@temp@width %
      }%
    \fi %
  \fi %
  \relax%
}%

\def\GreManualCusto#1{%
  \gre@skip@temp@four = \gre@skip@spacebeforecusto%
  \kern\gre@skip@temp@four\GreCusto{#1}%
}%

% macro that typesets an additional line at the top for custos at end of line

\def\gre@additionaltopcustolineend{%
  \gre@dimen@temp@five=\gre@dimen@staffheight %
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \gre@style@additionalstafflines % keep this line
    \else % DEPRECATED
      \gre@deprecated{\protect\greadditionalstafflines}{\protect\grechangestyle{additionalstafflines}}% DEPRECATED
      \greadditionalstafflines% DEPRECATED
    \fi% DEPRECATED
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@five by \gre@dimen@additionalcustoslineswidth %
    \kern-\gre@dimen@temp@five %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \endgre@style@additionalstafflines% keep this line
    \fi% DEPRECATED
  }%
  \relax %
}%

\def\gre@additionalbottomcustolineend{%
  \gre@dimen@temp@five=\gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \advance\gre@dimen@temp@five by -\gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by -\gre@dimen@stafflineheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \gre@style@additionalstafflines % keep this line
    \else % DEPRECATED
      \gre@deprecated{\protect\greadditionalstafflines}{\protect\grechangestyle{additionalstafflines}}% DEPRECATED
      \greadditionalstafflines% DEPRECATED
    \fi% DEPRECATED
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@five by \gre@dimen@additionalcustoslineswidth %
    \kern-\gre@dimen@temp@five %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \endgre@style@additionalstafflines% keep this line
    \fi% DEPRECATED
  }%
  \relax %
}%

% same macros, but for a custo in the middle

\def\gre@additionaltopcustolinemiddle{%
  \gre@dimen@temp@five=\gre@dimen@staffheight %
  \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \gre@style@additionalstafflines % keep this line
    \else % DEPRECATED
      \gre@deprecated{\protect\greadditionalstafflines}{\protect\grechangestyle{additionalstafflines}}% DEPRECATED
      \greadditionalstafflines% DEPRECATED
    \fi% DEPRECATED
    \hss %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\gre@dimen@additionalcustoslineswidth %
    \multiply\gre@dimen@temp@five by 2%
    \advance\gre@dimen@temp@five by \wd\gre@box@temp@sign %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \endgre@style@additionalstafflines% keep this line
    \fi% DEPRECATED
  }%
  \relax %
}%

\def\gre@additionalbottomcustolinemiddle{%
  \gre@dimen@temp@five=\gre@dimen@spacebeneathtext %
  \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
  \advance\gre@dimen@temp@five by \gre@dimen@additionalbottomspace %
  \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
  \advance\gre@dimen@temp@five by -\gre@dimen@interstafflinespace %
  \advance\gre@dimen@temp@five by -\gre@dimen@stafflineheight %
  \raise\gre@dimen@temp@five %
  \hbox to 0pt{%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \gre@style@additionalstafflines % keep this line
    \else % DEPRECATED
      \gre@deprecated{\protect\greadditionalstafflines}{\protect\grechangestyle{additionalstafflines}}% DEPRECATED
      \greadditionalstafflines% DEPRECATED
    \fi% DEPRECATED
    \hss %
    \kern\gre@dimen@temp@three %
    \gre@dimen@temp@five=\gre@dimen@additionalcustoslineswidth %
    \multiply\gre@dimen@temp@five by 2%
    \advance\gre@dimen@temp@five by \wd\gre@box@temp@sign %
    \vrule width \gre@dimen@temp@five height \gre@dimen@stafflineheight%
    \hss %
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \endgre@style@additionalstafflines% keep this line
    \fi% DEPRECATED
  }%
  \relax %
}%

\def\gre@pickcusto#1{%
  \ifcase#1%
  \or\or%
  \or\gre@fontchar@custotopmiddle %
  \or\gre@fontchar@custotoplong %
  \or\gre@fontchar@custotopshort %
  \or\gre@fontchar@custotoplong %
  \or\gre@fontchar@custotopshort %
  \or\gre@fontchar@custotoplong %
  \or\gre@fontchar@custotopshort %
  \or\gre@fontchar@custotoplong %
  \or\gre@fontchar@custotopshort %
  \or\gre@fontchar@custobottomlong %
  \or\gre@fontchar@custobottomshort %
  \or\gre@fontchar@custobottomlong %
  \or\gre@fontchar@custobottommiddle %
  \fi%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of braces and other things above the score
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifgre@drawbraces\gre@drawbracestrue %
\def\gresetbracerendering#1%
{\IfStrEq{#1}{font}%
  {\gre@drawbracesfalse}%
  {\IfStrEq{#1}{metapost}%
    {\gre@drawbracestrue}%
    {\gre@error{Unrecognized option for \protect\gresetbracerendering}}%
  }%
}%

\gdef\gre@fontchar@curlybrace{\gregoriofont\GreCPCurlyBrace}%
\gdef\gre@fontchar@brace{\gregoriofont\GreCPRoundBrace}%
\gdef\gre@fontchar@underbrace{\gregoriofont\GreCPRoundBraceDown}%

% the command to resize a box, \resizebox is provided by graphicx
\global\let\greresizebox\resizebox %

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
% #5: 1 if we put an accentus above or not
\def\GreOverCurlyBrace#1#2#3#4#5{%
  \gre@brace@common{#1}{#2}{#3}{#4}{#5}{\gre@pitch@g}{\gre@fontchar@curlybrace}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
\def\GreOverBrace#1#2#3#4{%
  \gre@brace@common{#1}{#2}{#3}{#4}{0}{\gre@pitch@g}{\gre@fontchar@brace}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
\def\GreUnderBrace#1#2#3#4{%
  \gre@brace@common{#1}{#2}{#3}{#4}{0}{\gre@pitch@b}{\gre@fontchar@underbrace}%
}%

% #1: the width
% #2: a vertical shift
% #3: a horizontal shift
% #4: 1 if we shift to the beginning of the last glyph, 0 otherwise
% #5: 1 if we put an accentus above, 0 if not
% #6: the pitch at which to compute the height
% #7: the brace character
\def\gre@brace@common#1#2#3#4#5#6#7{%
  \ifnum#4=1\relax %
    \setbox\gre@box@temp@sign=\hbox{\gre@fontchar@punctum}%
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \kern-\gre@dimen@temp@five %
  \fi %
  \gre@calculate@glyphraisevalue{#6}{13}%
  \advance\gre@dimen@glyphraisevalue by #2\relax %
  \hbox to 0pt{%
    \gre@skip@temp@four = #3\relax %
    \kern\gre@skip@temp@four %
    \raise\gre@dimen@glyphraisevalue\hbox{%
      \ifgre@drawbraces%
        \ifx#7\gre@fontchar@curlybrace %
          \gre@draw@curlybrace{#1}%
        \else %
          \ifx#7\gre@fontchar@brace %
            \gre@draw@brace{#1}%
          \else
            \ifx#7\gre@fontchar@underbrace %
              \gre@draw@underbrace{#1}%
            \fi %
          \fi %
        \fi %
      \else %
        \setbox\gre@box@temp@sign=\hbox{#7}%
        \greresizebox{#1}{\ht\gre@box@temp@sign}{#7}%
      \fi %
    }%
    \hss %
    \ifnum#5=1\relax %
      \gre@calculate@glyphraisevalue{\gre@pitch@m}{13}%
      \advance\gre@dimen@glyphraisevalue by \gre@dimen@curlybraceaccentusshift %
      \raise\gre@dimen@glyphraisevalue\hbox{%
        \gregoriofont\GreCPAccentus\relax %
      }%
      \hss %
    \fi %
  }%
  \ifnum#4=1\relax %
    \kern\gre@dimen@temp@five %
  \fi %
  \relax %
}%

% #1: the width, or * for the bar brace width
% this can't have @ in the name because of the metapost catcode settings
\def\grebracemetapostpreamble#1{%
  % multiplier to convert gre@factor to em-size in bp
  % (100000 sp) * (72 bp/in) / (65536 sp/pt) / 72.27 (pt/in)
  factor = 1.5201782378;
  scale = \the\gre@factor * factor;
  % assuming #1 is in bp, we convert it back into the internal unit of the
  % calculation, ems
  width = \directlua{gregoriotex.width_to_bp([[#1]], "\grebarbracewidth * scale")} / scale;
}%

% #1: the width
\def\gre@draw@curlybrace#1{%
  \gre@debugmsg{general}{curly brace width = #1}%
  \gre@metapost{
    \grebracemetapostpreamble{#1}
    p = 0;
    transform t;
    t = identity scaled scale;
    if width < 1.006:
      t := t xscaled (width/1.006);
    else:
      p := (width - 1.006) / 2;
    fi;
    beginfig(0);
    fill
      (  (.00040,.68680) % start the top
      .. controls (.00040,.68680) and (.05920,.74280)
      .. ((0.2*p)+.17120,.74280)
      .. controls ((0.2*p)+.25660,.74280) and (p+.30980,.72180)
      .. (p+.38400,.72180)
      .. controls (p+.47360,.72180) and (p+.50300,.75820)
      .. (p+.50300,.75820) % top of the beak
      -- (p+.50300,.75820)
      .. controls (p+.50300,.75820) and (p+.53380,.72180)
      .. (p+.62200,.72180)
      .. controls (p+.69620,.72180) and ((1.8*p)+.74940,.74280)
      .. ((1.8*p)+.83400,.74280)
      .. controls ((2*p)+.94820,.74280) and ((2*p)+1.00560,.68680)
      .. ((2*p)+1.00560,.68680) -- ((2*p)+1.00560,.68680) % end the top
      -- ((2*p)+.99860,.67980) -- ((2*p)+.99860,.67980) % start the bottom
      .. controls ((2*p)+.99860,.67980) and ((2*p)+.96920,.71760)
      .. ((1.8*p)+.87680,.71760)
      .. controls ((1.8*p)+.80540,.71760) and (p+.75360,.69800)
      .. (p+.67240,.69800)
      .. controls (p+.61080,.69800) and (p+.55060,.71060)
      .. (p+.50300,.74840) % bottom of the beak
      -- (p+.50300,.74840)
      .. controls (p+.45540,.71060) and (p+.39520,.69800)
      .. (p+.33360,.69800)
      .. controls (p+.25240,.69800) and ((0.2*p)+.20060,.71760)
      .. ((0.2*p)+.12920,.71760)
      .. controls (.03680,.71760) and (.00740,.67980)
      .. (.00740,.67980) -- (.00740,.67980) % end the bottom
      -- (.00040,.68680) -- cycle
      ) transformed t;
    setbounds currentpicture to
      ( (0,0) -- ((2*p)+1.006,0) -- ((2*p)+1.006,.75820) -- (0,.75820) -- cycle )
      transformed t;
    endfig;
  }%
}%

% #1: the width
\def\gre@draw@brace#1{%
  \gre@draw@roundbrace{#1}{.89500}{
       (-.00192,.70347) % start the top
    .. controls (-.00192,.70525) and (-.00134,.70740)
    .. (.00000,.71000) -- (.00000,.71000){curl c}
    .. (p/2,.89500) % top of the center
    .. {curl c}(p,.71000) -- (p,.71000)
    .. controls (p+.00134,.70740) and (p+.00192,.70525)
    .. (p+.00192,.70347) % end the top
    .. controls (p+.00192,.69508) and (p-.01103,.69500)
    .. (p-.01856,.69500) % start the bottom
    .. controls (p-.01856,.69500) and (p-.01900,.69500)
    .. (p-.01900,.69500) -- (p-.01900,.69500){curl c}
    .. (p/2,.86400) % bottom of the center
    .. {curl c}(.01900,.69500) -- (.01900,.69500)
    .. controls (.01900,.69500) and (.01856,.69500)
    .. (.01856,.69500) % end the bottom
    .. controls (.01103,.69500) and (-.00192,.69508)
    .. (-.00192,.70347) -- cycle
  }%
}%

% #1: the width
\def\gre@draw@underbrace#1{%
  \gre@draw@roundbrace{#1}{.25500}{
       (-.00192,.24653) % start the bottom
    .. controls (-.00192,.24475) and (-.00134,.24260)
    .. (.00000,.24000) -- (.00000,.24000){curl c}
    .. (p/2,.05500) % bottom of the center
    .. {curl c}(p,.24000) -- (p,.24000)
    .. controls (p+.00134,.24260) and (p+.00192,.24475)
    .. (p+.00192,.24653) % end the bottom
    .. controls (p+.00192,.25492) and (p-.01103,.25500)
    .. (p-.01856,.25500) % start the top
    .. controls (p-.01856,.25500) and (p-.01900,.25500)
    .. (p-.01900,.25500) -- (p-.01900,.25500){curl c}
    .. (p/2,.08600) % top to the center
    .. {curl c}(.01900,.25500) -- (.01900,.25500)
    .. controls (.01900,.25500) and (.01856,.25500)
    .. (.01856,.25500) % end the top
    .. controls (.01103,.25500) and (-.00192,.25492)
    .. (-.00192,.24653) -- cycle
  }%
}%

% #1: the width
% #2: height of the bounding box
% #3: metapost commands to draw the outline
\def\gre@draw@roundbrace#1#2#3{%
  \gre@debugmsg{general}{round brace width = #1}%
  \gre@metapost{
    \grebracemetapostpreamble{#1}
    p = width;
    transform t;
    t = identity scaled scale;
    c = 1;
    if p < 0.200:
      c := 0;
      t := t xscaled (p/0.200);
      p := 0.200;
    elseif p < 0.350:
      c := (p - 0.200) / 0.350;
    fi;
    beginfig(0);
    fill ( #3 ) transformed t;
    setbounds currentpicture to
      ( (0,0) -- (p,0) -- (p,#2) -- (0,#2) -- cycle )
      transformed t;
    endfig;
  }%
}%

% #1: id of the variable length brace within the score
\def\GreVarBraceLength#1{%
  \directlua{gregoriotex.var_brace_len(#1)}%
}%

% #1: id of the variable length brace within the score
% #2: 1 if we shift to the beginning of the last glyph, 0 otherwise
% #3: 1 if the start, 2 if the end
\def\GreVarBraceSavePos#1#2#3{%
  \ifnum#2=1\relax %
    \setbox\gre@box@temp@sign=\hbox{\gre@fontchar@punctum}%
    \gre@dimen@temp@five=\wd\gre@box@temp@sign %
    \kern-\gre@dimen@temp@five %
    \pdfsavepos %
    \kern\gre@dimen@temp@five %
  \else %
    \pdfsavepos %
  \fi %
  \directlua{gregoriotex.var_brace_note_pos(#1, #3)}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of punctum mora, auctum duplex and choral signs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a function to typeset a punctum mora, the first argument is the letter of the height of the punctum mora
% if the second argument is one, we the go back to the end of the punctum
% if the second argument is two, it means that we must shift the width of one punctum to the left
% if it is three, it means the same as when it is two, but with ambitus of one
% #3 is 1 in case of a punctommora in the note before the last note of a podatus, porrectus or torculus resupinus, 0 otherwise.
% #4 is 1 if we are at a punctum inclinatum, 0 otherwise
\def\GrePunctumMora#1#2#3#4{%
  \GreNoBreak %
  \ifcase#2\relax %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \hskip\gre@skip@temp@four%
  \or %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    % to get the widht of a punctum minus a line, we calculate the width of a flexus (with ambitus of two) minus the width of a punctum
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPPesQuadratumLongqueueThreeNothing}%
    \gre@dimen@temp@five=\wd\gre@box@temp@width %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPPunctum}%
    \advance\gre@dimen@temp@five by -\wd\gre@box@temp@width %
    \kern-\gre@dimen@temp@five %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPPunctum}%
    \gre@dimen@temp@five=\wd\gre@box@temp@width %
    \kern-\gre@dimen@temp@five %
    \gre@skip@temp@four = \gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \fi %
  \ifnum#2=1\else %
    \gre@lastispunctumtrue%
  \fi %
  \ifcase#3\relax % 0
    \gre@calculate@glyphraisevalue{#1}{4}%
  \or% 1
    \gre@calculate@glyphraisevalue{#1}{8}%
  \or% 2
    \gre@calculate@glyphraisevalue{#1}{14}%
  \fi %
  % here we shift a bit left in the case where we have a punctum inclinatum on a line
  \ifnum#4=1\relax %
    \ifgre@isonaline %
      \gre@dimen@temp@three=3700sp%
      \multiply\gre@dimen@temp@three by \the\gre@factor %
      \kern-\gre@dimen@temp@three %
      \gre@dimen@temp@three =4500sp%
      \multiply\gre@dimen@temp@three by \the\gre@factor %
      \advance\gre@dimen@glyphraisevalue by -\gre@dimen@temp@three %
    \else %
      \gre@dimen@temp@three =2500sp%
      \multiply\gre@dimen@temp@three by \the\gre@factor %
      \advance\gre@dimen@glyphraisevalue by -\gre@dimen@temp@three %
    \fi %
  \fi %
  \GreNoBreak %
  \raise \gre@dimen@glyphraisevalue \hbox{\gre@fontchar@punctummora}%
  \GreNoBreak %
  \ifcase#2\relax\or %
    \setbox\gre@box@temp@width=\hbox{\gre@fontchar@punctummora}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
  \or %
    \setbox\gre@box@temp@width=\hbox{\gre@fontchar@punctummora}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
  \or %
    \setbox\gre@box@temp@width=\hbox{\gre@fontchar@punctummora}%
    \gre@skip@temp@four = -\wd\gre@box@temp@width %
    \kern\gre@skip@temp@four%
    \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
    \kern\gre@skip@temp@four %
    \kern\gre@dimen@temp@five %
  \fi %
  \GreNoBreak %
  \relax%
}%

% a function to typeset an augmentum duplex, easy enough to be understood...
\def\GreAugmentumDuplex#1#2#3{%
  \GrePunctumMora{#1}{1}{#3}{0}%
  \GrePunctumMora{#2}{0}{0}{0}%
  \relax %
}%

\gdef\grelowchoralsignstyle#1{\relax}% DEPRECATED
\let\gre@deprecated@lowchoralsignstyle\grelowchoralsignstyle%
\gdef\grehighchoralsignstyle#1{\relax}% DEPRECATED
\let\gre@deprecated@highchoralsignstyle\grehighchoralsignstyle%

% quite simple function: #1 is the height, #2 is the string, #3 is #2 of punctum mora, #4 is #3 of punctum mora
% #3 is 1 if it must be a bit higher
\def\GreLowChoralSign#1#2#3{%
  \GreNoBreak %
  \gre@skip@temp@four = \gre@skip@beforelowchoralsignspace%
  \hskip\gre@skip@temp@four %
  \GreNoBreak %
  \ifnum#3=1\relax %
    \gre@calculate@glyphraisevalue{#1}{12}%
  \else %
    \gre@calculate@glyphraisevalue{#1}{10}%
  \fi %
  \ifx\gre@deprecated@lowchoralsignstyle\grelowchoralsignstyle% DEPRECATED
    \raise\gre@dimen@glyphraisevalue\hbox{\gre@style@lowchoralsign#2\endgre@style@lowchoralsign}% keep this line
  \else%  DEPRECATED
    \gre@deprecated{\protect\grelowchoralsignstyle}{\protect\grechangestyle{lowchoralsign}}%  DEPRECATED
    \raise\gre@dimen@glyphraisevalue\hbox{\grelowchoralsignstyle{#2}}%  DEPRECATED
  \fi%  DEPRECATED
  \relax %
}%

\def\GreHighChoralSign#1#2#3{%
  \GreNoBreak %
  \ifx\gre@deprecated@highchoralsignstyle\grehighchoralsignstyle%  DEPRECATED
    \gre@vepisemusorrare{#1}{#3}{}{3}{\gre@style@highchoralsign#2\endgre@style@highchoralsign}% keep this line
  \else%  DEPRECATED
    \gre@deprecated{\protect\grehighchoralsignstyle}{\protect\grechangestyle{highchoralsign}}%  DEPRECATED
    \gre@vepisemusorrare{#1}{#3}{}{3}{\grehighchoralsignstyle{#2}}% DEPRECATED
  \fi% DEPRECATED
  %\gre@hepisorline{#1}{#3}{0}{4}{\gre@style@highchoralsign#2\endgre@style@highchoralsign}
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of linea
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\GreLinea#1#2#3#4#5#6{%
  \GreGlyph{\GreCPLinea}{#1}{#2}{#3}{#4}{#5}{#6}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of vertical episemus
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newbox\gre@box@temp@sign%

% a macro to help typesetting vertical episemus.
% #1 is an offset glyph (see #3 below)
% #2 represents the glyph upon which the sign is to be centered
% #3 is a case number
%    0 : go back to the beginning of the previous glyph and then forward half
%        the width of #2; this puts the sign at the beginning of the previous
%        glyph, whose first note is the size of #2
%    1 : go back half the width of #2; this puts the sign at the end of the
%        previous glyph, whose last note is the size of #2
%    2 : go back the width of #1 and then foward half the width of #2; this
%        puts the sign at the glyph from the end that starts at #1's width from
%        the end
%    3 : go back to the beginning of the previous glyph and then forward the
%        width of #1 and then back half the width of #2; this puts the sign at
%        the glyph from the start that ends at #1's width from the start
% #4 is a shift that we want to get applied, useful for punctum inclinatum for example
% #5 is the glyph number.
% #6 is the type of sign (1: vertical episemus, 2: rare sign, 3: choral sign)
% #7 is the choral sign if relevant
\def\gre@vepisemusorrareaux#1#2#3#4#5#6#7{%
  % first we set \gre@dimen@temp@three to the width of the last glyph
  \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
  \setbox\gre@box@temp@sign=\hbox{\gregoriofont #2}%
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \divide\gre@dimen@temp@two by 2\relax %
  \ifcase#3%
  % tempwidth is the width of the last glyph
    \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \or%
    \gre@dimen@temp@three=\gre@dimen@temp@two %
  \or%
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \gre@dimen@temp@three=\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \or %
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \advance\gre@dimen@temp@three by -\wd\gre@box@temp@sign %
    \advance\gre@dimen@temp@three by \gre@dimen@temp@two %
  \fi%
  \kern-\gre@dimen@temp@three % we do it here because of the now-removed ictus (chironomy)
  % then we draw the sign
  \ifcase#6\or %
    % vertical episemus
    \setbox\gre@box@temp@sign=\hbox{\gre@fontchar@verticalepisemus}%
  \or % rare sign
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont#5}%
  \or % choral sign
    \setbox\gre@box@temp@sign=\hbox{#7}%
  \or % brace above bar
    \setbox\gre@box@temp@sign=\hbox{%
      \ifgre@drawbraces %
        \gre@draw@brace{*}%
      \else %
        \gre@fontchar@abovebarbrace %
      \fi %
    }%
  \fi %
  % we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \divide\gre@dimen@temp@two by 2 %
  \advance\gre@dimen@temp@three by \gre@dimen@temp@two %
  \kern-\gre@dimen@temp@two%
  \gre@skip@temp@four = #4sp%
  \kern \gre@skip@temp@four%
  \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \kern -\gre@skip@temp@four%
  % and finally we go back to the end of the glyph, where we were first
  \advance\gre@dimen@temp@three by -2\gre@dimen@temp@two %
  \kern\gre@dimen@temp@three%
  \relax%
}%

\directlua{gregoriotex.emit_offset_macros()}%

% a function to typeset a vertical episemus or a rare accent (like accentus,
% circulus, etc.).  This function must be called after a call to \GreGlyph.
% #1 is the letter of the height of the episemus (not the height of the note
%    it corresponds to.
% #2 is note position case as in the table above
% #3 is the sign glyph
% #4 is type (1: vertical episemus, 2: rare sign, 3: choral sign, 4: brace above the bar)
% #5 is the choral sign if relevant
\def\gre@vepisemusorrare#1#2#3#4#5{%
  \ifcase#4\or %
    % if it is a vertical episemus, we call the normal calculateglyphvalue
    \gre@calculate@glyphraisevalue{#1}{3}%
  \or %
    % if it is not, we call it with 6 as second argument, it will give us the height of the rare signs (accentus, etc.) the first argument is m if the pitch is < k, otherwise it's n.
    \ifnum#1<\gre@pitch@k\relax %
      \gre@calculate@glyphraisevalue{\gre@pitch@k}{6}%
    \else %
      {%
        \gre@count@temp@three=#1%
        \advance\gre@count@temp@three by 1\relax %
        \gre@calculate@glyphraisevalue{\gre@count@temp@three}{6}%
      }%
    \fi %
  \or % if it's a choral sign
    \gre@calculate@glyphraisevalue{#1}{11}%
  \or % if it's the brace above the bar
    \gre@calculate@glyphraisevalue{#1}{13}%
  \fi %
  \gre@v@case{#2}{#3}{#4}{#5}%
  \relax%
}%

\def\GreVEpisemus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPVEpisemus}{1}{}%
  \relax %
}%

\def\GreBarBrace#1{%
  \gre@vepisemusorrare{\gre@pitch@g}{#1}{%
    \ifgre@drawbraces %
      \hbox{\gre@draw@brace{*}}%
    \else %
      \GreCPBarBrace %
    \fi %
  }{4}{}%
  \relax %
}%

\def\GreBarVEpisemus#1{%
  \gre@vepisemusorrare{\gre@pitch@c}{#1}{\GreCPVEpisemus}{1}{}%
  \relax %
}%

\def\GreAccentus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPAccentus}{2}{}%
  \relax %
}%

\def\GreSemicirculus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPSemicirculus}{2}{}%
  \relax %
}%

\def\GreCirculus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPCirculus}{2}{}%
  \relax %
}%

\def\GreReversedAccentus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPAccentusReversus}{2}{}%
  \relax %
}%

\def\GreReversedSemicirculus#1#2{%
  \gre@vepisemusorrare{#1}{#2}{\GreCPSemicirculusReversus}{2}{}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting horizontal episemus
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% a macro that will help in the typesetting of a horizontal episemus and additional lines,
% #1 is an offset glyph (see #3, below)
% #2 is the episemus glyph
% #3 is a case number, similar in nature to #3 in gre@vepisemusorrareaux
%    0 : go back to the beginning of the previous glyph; this starts the
%        episemus at the beginning of the previous glyph
%    1 : stay at the end of the glyph; doesn't make much sense to use this
%    2 : go back the width of #1; this starts the episemus at the glyph from
%        the end that starts at #1's width from the end
%    3 : go back to the beginning of the previous glyph and then forward the
%        width of #1; this starts the episemus at the glyph from the start that
%        starts just after #1's width from the start
% #4 argument is the same as in hepisorline
\def\gre@hepisorlineaux#1#2#3#4{%
  \ifcase#3%
    % case 0
  % first we set \gre@dimen@temp@three to the width of the last glyph
    \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
  \or
    % case 1
    \gre@dimen@temp@three=0 pt\relax %
  \or
    % case 2
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \gre@dimen@temp@three=\wd\gre@box@temp@sign%
  \or
    % case 3
    \gre@dimen@temp@three=\gre@dimen@lastglyphwidth %
    \setbox\gre@box@temp@sign=\hbox{\gregoriofont #1}%
    \advance\gre@dimen@temp@three by -\wd\gre@box@temp@sign %
  \fi%
  \kern-\gre@dimen@temp@three %
  % then we draw the sign, and go back to the beginning of the sign
  \setbox\gre@box@temp@sign=\hbox{\gregoriofont#2}%
  % we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
  \gre@dimen@temp@two=\wd\gre@box@temp@sign %
  \ifnum#4<2\relax % case of the lines
  \else %
    \gre@dimen@temp@five=\gre@dimen@additionallineswidth %
    \kern-\gre@dimen@temp@five %
    \advance\gre@dimen@temp@two by 2\gre@dimen@temp@five %
  \fi %
  \ifcase#4%
    %case of hepisemus
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or %
    %case of hepisemus at the bottom
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or % case of a line at the top
    \gre@dimen@glyphraisevalue=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacelinestext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@currenttranslationheight %
    \advance\gre@dimen@glyphraisevalue by 4\gre@dimen@interstafflinespace %
    \advance\gre@dimen@glyphraisevalue by 4\gre@dimen@stafflineheight %
    \raise\gre@dimen@glyphraisevalue\hbox{\vrule height \gre@dimen@stafflineheight width \gre@dimen@temp@two}%
    \kern\gre@dimen@temp@five %
  \or % case of a line at the bottom
    \gre@dimen@glyphraisevalue=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@currenttranslationheight %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@spacelinestext %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@interstafflinespace %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflineheight %
    \raise\gre@dimen@glyphraisevalue\hbox{\vrule height \gre@dimen@stafflineheight width \gre@dimen@temp@two}%
    \kern\gre@dimen@temp@five %
  \or %
    %case of choral sign
    \raise \gre@dimen@glyphraisevalue \copy\gre@box@temp@sign %
  \or %
  \fi %
  % and finally we go back to the end of the glyph, where we were first
  \advance\gre@dimen@temp@three by -\gre@dimen@temp@two %
  \kern\gre@dimen@temp@three %
  \relax%
}%

% a function to typeset a horizontal line (additional line or episemus).
% This function must be called after a call to \GreGlyph.
% #1 is the letter of the height of the episemus (not the height of the note
% it corresponds to.
% #2 is note position case as in the table above
% #3 is the ambitus for a two note episemus at the diagonal stroke of a
%    porrectus, porrectus flexus, orculus resupinus, or torculus resupinus
%    flexus
% #4 is 0 for an horizontal episemus, 1 for an horizontal episemus under a
%    note, 3 for a line at the bottom, 2 for a line at the top
% #5 is f for a normal episemus, l for a small episemus aligned left,
%    c for a small episemus aligned center, or r for a small episemus
%    aligned right
\def\gre@hepisorline#1#2#3#4#5{{%
  \ifcase#4 %
    \gre@calculate@glyphraisevalue{#1}{9}%
  \or %
    \gre@calculate@glyphraisevalue{#1}{5}%
  \or %
    % the glyphraisevalue is ignored anyway... but it's just in case...
    \gre@calculate@glyphraisevalue{\gre@pitch@l}{0}%
  \or %
    \gre@calculate@glyphraisevalue{\gre@pitch@b}{0}%
  \or %
    \gre@calculate@glyphraisevalue{#1}{11}%
  \fi %
  \gre@h@case{#2}{#3}{#4}{#5}%
  \relax%
}}%

% dumb top function
% #6 is a trick for bridges: if we must use a different height because of a
%    bridge, use #6, otherwise use #1
\def\GreHEpisemus#1#2#3#4#5#6{%
  \ifgre@hepisemusbridge%
    \gre@hepisorline{#6}{#2}{#3}{#4}{#5}%
  \else %
    \gre@hepisorline{#1}{#2}{#3}{#4}{#5}%
  \fi %
  \relax %
}%

\newif\ifgre@hepisemusbridge
\gre@hepisemusbridgetrue

\def\AddHEpisemusBridges{%
  \gre@deprecated{\protect\AddHEpisemusBridges}{\protect\gresethepisemus{bridge}}%
  \gre@hepisemusbridgetrue%
}%

\def\RemoveHEpisemusBridges{%
  \gre@deprecated{\protect\RemoveHEpisemusBridges}{\protect\gresethepisemus{break}}%
  \gre@hepisemusbridgefalse%
}%

\def\gresethepisemus#1{%
  \IfStrEq{#1}{bridge}%
    {\gre@hepisemusbridgetrue}%
    {\IfStrEq{#1}{break}%
      {\gre@hepisemusbridgefalse}%
      {\gre@error{Unrecognized option for \protect\gresethepisemus}}%
    }%
}%

% same but for a "bridge episemus" after the last note of a glyph (element, syllable) if the next episemus is at the same height
% #1 is the height
% #2 is 0 for episemus above, 1 for episemus below
% #3 is the "space case" for the following note, if a punctum inclinatum
\def\GreHEpisemusBridge#1#2#3{%
  \ifgre@hepisemusbridge%
    \ifcase#2 %
      \gre@calculate@glyphraisevalue{#1}{9}%
    \or %
      \gre@calculate@glyphraisevalue{#1}{5}%
    \fi %
    \IfStrEq{-1}{#3}{%
      \raise\gre@dimen@glyphraisevalue\hbox to 0pt{\gregoriofont\gre@char@he@punctum{f}\hss}%
    }{%
      % special handling for punctum inclinatum
      \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPHEpisemusPunctumReduced}%
      \gre@dimen@temp@four = \wd\gre@box@temp@width\relax %
      \gre@get@spaceskip{#3}%
      % convert rubber length to dimension... not perfect but works in the usual case
      \gre@dimen@temp@three = 1\gre@skip@temp@four\relax %
      \raise\gre@dimen@glyphraisevalue\hbox to 0pt{%
        \loop\ifdim\gre@dimen@temp@three > 0pt%
          \advance\gre@dimen@temp@three by -\gre@dimen@temp@four\relax %
          {\gregoriofont\GreCPHEpisemusPunctumReduced}%
        \repeat %
        \kern\gre@dimen@temp@three{\gregoriofont\GreCPHEpisemusPunctumReduced}%
        \hss %
      }%
    }%
  \fi %
  \relax %
}%

% another dumb top function
\def\GreAdditionalLine#1#2#3{%
  \ifgre@showlines %
    \xdef\gre@dimen@savedglyphraise{\the\gre@dimen@glyphraisevalue}%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \gre@style@additionalstafflines % keep this line
    \else % DEPRECATED
      \gre@deprecated{\protect\greadditionalstafflines}{\protect\grechangestyle{additionalstafflines}}% DEPRECATED
      \greadditionalstafflines% DEPRECATED
    \fi% DEPRECATED
    \gre@hepisorline{\gre@pitch@a}{#1}{#2}{#3}{f}%
    \ifx\gre@deprecated@additionalstafflines\greadditionalstafflines% DEPRECATED
      \endgre@style@additionalstafflines% keep this line
    \fi% DEPRECATED
    \gre@dimen@glyphraisevalue=\gre@dimen@savedglyphraise %
  \fi %
  \relax %
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of bars
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% we define two types of macro for each four bar : when it is inside a syllable, and when it is not

\def\GreInVirgula#1{%
  \gre@writebar{0}{1}{#1}%
  \relax%
}%

\def\GreVirgula#1{%
  \gre@writebar{0}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMinima#1{%
  \gre@writebar{1}{1}{#1}%
  \relax%
}%

\def\GreDivisioMinima#1{%
  \gre@writebar{1}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMinor#1{%
  \gre@writebar{2}{1}{#1}%
  \relax%
}%

\def\GreDivisioMinor#1{%
  \gre@writebar{2}{0}{#1}%
  \relax%
}%

\def\GreInDivisioMaior#1{%
  \gre@writebar{3}{1}{#1}%
  \relax%
}%

\def\GreDivisioMaior#1{%
  \gre@writebar{3}{0}{#1}%
  \relax%
}%

\def\GreDominica#1#2{%
  \ifcase#1\or %
    \gre@writebar{6}{0}{#2}%
  \or %
    \gre@writebar{7}{0}{#2}%
  \or %
    \gre@writebar{8}{0}{#2}%
  \or %
    \gre@writebar{9}{0}{#2}%
  \or %
    \gre@writebar{10}{0}{#2}%
  \or %
    \gre@writebar{11}{0}{#2}%
  \fi %
  \relax%
}%

\def\GreInDominica#1#2{%
  \ifcase#1\or %
    \gre@writebar{6}{1}{#2}%
  \or %
    \gre@writebar{7}{1}{#2}%
  \or %
    \gre@writebar{8}{1}{#2}%
  \or %
    \gre@writebar{9}{1}{#2}%
  \or %
    \gre@writebar{10}{1}{#2}%
  \or %
    \gre@writebar{11}{1}{#2}%
  \fi %
  \relax%
}%


\def\GreInDivisioFinalis#1{%
  \ifgre@endofscore %
    \gre@writebar{5}{1}{#1}%
  \else %
    \gre@writebar{4}{1}{#1}%
  \fi %
  \relax%
}%

\def\GreDivisioFinalis#1{%
  \ifgre@endofscore %
    \gre@writebar{5}{0}{#1}%
  \else %
    \gre@writebar{4}{0}{#1}%
  \fi %
  \relax%
}%

%a macro to write a bar
%% 1: the type of the bar : 0 for virgula, 1 for minima 2 for minor, 3 for major, 4 for finalis and 5 for the last finalis
%% 2: is % for now we don't use it
%%%%%% 0 if it is in a syllable containing only this bar
%%%%%% 1 if it is in a syllable containing other notes
%% 3: macros that may happen before the skip after the bar (typically GreVEpisemus)
\def\gre@writebar#1#2#3{%
  % first, for the bar to be really centered, if the last glyph has a punctum
  % mora, we kern of the corresponding space. We do it only in the case
  % of a bar in the middle of other notes.
  \ifgre@lastispunctum%
    \ifnum#2=1\relax %
      \setbox\gre@box@temp@width=\hbox{\gregoriofont\gre@fontchar@punctummora}%
      \gre@skip@temp@four = -\wd\gre@box@temp@width %
      \kern\gre@skip@temp@four%
      \gre@skip@temp@four = -\gre@skip@spacebeforesigns%
      \kern\gre@skip@temp@four %
    \fi %
  \fi %
  \gre@newglyphcommon %
  \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
  \GreNoBreak %
  \ifcase#1 % 0 : virgula
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPVirgula}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPVirgula}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 1 : minima
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioMinima}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioMinima}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundsmallbar%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 2 : minor
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioMinor}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioMinor}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 3 : maior
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundmaior%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioMaior}%
    \gre@fontchar@divisiomaior %
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundmaior%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 4 : finalis
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gre@fontchar@divisiofinalis}%
    #3\relax %
    \gre@fontchar@divisiofinalis%
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 5 : finalis
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacebeforefinalfinalis%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gre@fontchar@divisiofinalis}%
    #3\relax %
    \gre@fontchar@divisiofinalis%
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundfinalis%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 6 : dominican bar 1
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
    % we need to adjust the height of the bar a little so that it is perfectly aligned with the bottom (or the top for some bars) of the staff line, which is not the case by default if \gre@stafflinefactor is not 10.
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 7 : dominican bar 2
    \gre@calculate@glyphraisevalue{\gre@pitch@e}{0}%
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 8 : dominican bar 3
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 9 : dominican bar 4
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 10 : dominican bar 5
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
    \advance\gre@dimen@glyphraisevalue by -\gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominican}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominican}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \or % 11 : dominican bar 6
    \gre@calculate@glyphraisevalue{\gre@pitch@i}{0}%
    \advance\gre@dimen@glyphraisevalue by \gre@dimen@stafflinediff %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
      \GreNoBreak %
    \fi %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioDominicanAlt}%
    #3\relax %
    \ifnum#2=1\relax %
      \gre@skip@temp@four = \gre@skip@spacearoundminor%
      \grehskip\gre@skip@temp@four %
    \fi %
  \fi %
  \gre@debugmsg{spacing}{Width of bar just printed: \the\wd\gre@box@temp@width}%
  \global\gre@dimen@lastglyphwidth=\wd\gre@box@temp@width %
  \directlua{gregoriotex.adjust_line_height(\gre@insidediscretionary)}%
  \relax%
}%

\def\gre@fontchar@divisiomaior{%
  \ifnum\gre@stafflinefactor=17\relax %
    %\gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
    \raise\gre@dimen@glyphraisevalue\hbox{\gregoriofont\GreCPDivisioMaior}%
  \else %
    \setbox\gre@box@temp@width=\hbox{\gregoriofont\GreCPDivisioMaior}%
    % we calculate the raise of the bar
    \gre@dimen@temp@five=\gre@dimen@additionalbottomspace %
    \advance\gre@dimen@temp@five by \gre@dimen@spacebeneathtext %
    \advance\gre@dimen@temp@five by \gre@dimen@spacelinestext %
    \advance\gre@dimen@temp@five by \gre@dimen@currenttranslationheight %
    % we calculate the height of the bar
    \raise\gre@dimen@temp@five\hbox{\vrule height \gre@dimen@staffheight width \wd\gre@box@temp@width}%
  \fi %
  \relax %
}%

\def\gre@fontchar@divisiofinalis{%
  \gre@calculate@glyphraisevalue{\gre@pitch@g}{0}% bar glyphs are made to be at this height
  \gre@fontchar@divisiomaior %
  \gre@dimen@temp@four = 12000 sp%
  \multiply\gre@dimen@temp@four by \the\gre@factor%
  \kern\gre@dimen@temp@four%
  \GreNoBreak %
  \gre@fontchar@divisiomaior %
}%

% Flag to tell if we have to keep the localrightbox until the end
\newif\ifgre@keeprightbox%

%macro to end a line with a divisio finalis
\def\GreFinalDivisioFinalis#1{%
  \grelocalrightbox{}%
  %\grelocalleftbox{}
  \GreNoBreak %
  \gre@skip@temp@four = \gre@skip@spacebeforefinalfinalis%
  \grehskip\gre@skip@temp@four %
  \GreNoBreak %
  \GreBarSyllable{}{}{}{1}{}{}{0}{\GreLastOfLine}{%
    \GreNoBreak %
    \GreDivisioFinalis{}%
    #1%
  }%
  \relax%
}%

%macro to end a line with a divisio maior
\def\GreFinalDivisioMaior#1{%
  \grelocalrightbox{}%
  \grelocalleftbox{}%
    \GreBarSyllable{}{}{}{1}{}{}{0}{}{%
    \GreNoBreak %
    \GreDivisioMaior{}%
    #1%
  }%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for filling holes of empty notes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% flag to indicate that lines behind a punctum cavum should be hidden
\newif\ifgre@hidepclines
% default state is to not hide them
\gre@hidepclinesfalse

% macro for manipulating above flag
\def\gresetlinesbehindpunctumcavum#1{%
  \IfStrEq{#1}{visible}%
    {\gre@hidepclinesfalse}%
    {\IfStrEq{#1}{invisible}%
      {\gre@hidepclinestrue}%
      {\gre@error{Unrecognized option for \protect\gresetlinesbehindpunctumcavum}}%
    }%
}%

\def\GreHidePCLines{%
  \gre@deprecated{\protect\GreHidePCLines}{\protect\gresetlinesbehindpunctumcavum{invisible}}%
  \gre@hidepclinestrue%
}%

\def\GreDontHidePCLines{%
  \gre@deprecated{\protect\GreDontHidePCLines}{\protect\gresetlinesbehindpunctumcavum{visible}}%
  \gre@hidepclinesfalse%
}%

% flag to indicate that lines behind an alteration should be hidden
\newif\ifgre@hidealtlines
% default state is to not hide them
\gre@hidealtlinesfalse

% macro for manipulating above flag
\def\gresetlinesbehindalteration#1{%
  \IfStrEq{#1}{visible}%
    {\gre@hidealtlinesfalse}%
    {\IfStrEq{#1}{invisible}%
      {\gre@hidealtlinestrue}%
      {\gre@error{Unrecognized option for \protect\gresetlinesbehindalteration}}%
    }%
}%

\def\GreHideAltLines{%
  \gre@deprecated{\protect\GreHideAltLines}{\protect\gresetlinesbehindalteration{invisible}}%
  \gre@hidealtlinestrue%
}%

\def\GreDontHideAltLines{%
  \gre@deprecated{\protect\GreDontHideAltLines}{\protect\gresetlinesbehindalteration{visible}}%
  \gre@hidealtlinesfalse%
}%


% the argument is the character with which we fill the hole, and we suppose that
% isonaline and glyphraisevalue are correctly set.
\def\gre@fillhole#1{%
  \setbox\gre@box@temp@width=\hbox{#1}%
  \hbox to 0pt{%
    {%
    \color{grebackgroundcolor}%
    \raise \gre@dimen@glyphraisevalue %
    \copy\gre@box@temp@width %
    }%
    %\pdfliteral{}% this is a ugly hack for old versions of LuaTeX to work
    \hss %
  }%
  \GreNoBreak %
\relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for typesetting alterations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% the top level macro:
% #1 is the height
% #2 is the char of the alteration
% #3 is the char of the alteration hole
% #4 is 1 in the case of a flat for a key change, 0 otherwise
\def\gre@alteration#1#2#3#4{%
  % to see why we reset \gre@lastoflinecount, see comments of \GreGlyph.
  \ifnum#4=0\relax %
    \gre@newglyphcommon %
  \fi %
  \gre@calculate@glyphraisevalue{#1}{0}%
  \ifgre@hidealtlines %
    \gre@fillhole{#3}%
  \fi %
  \setbox\gre@box@temp@width=\hbox{#2}%
  %\gre@dimen@temp@three=\wd\gre@box@temp@width 
  %\kern\gre@dimen@temp@three 
  %#3\relax 
  %\kern-\gre@dimen@temp@three 
  \raise \gre@dimen@glyphraisevalue%
  \copy\gre@box@temp@width%
  \ifnum#4=0\relax %
    % we try to avoid line breaking after a flat or a natural
    \GreNoBreak %
    \gre@skip@temp@four = \gre@skip@alterationspace%
    \ifgre@firstglyph%
      \global\advance\gre@dimen@notesaligncenter by \wd\gre@box@temp@width %
      \global\advance\gre@dimen@notesaligncenter by \dimexpr\gre@skip@temp@four\relax %
      \kern\gre@skip@temp@four %
    \else %
      \grehskip\gre@skip@temp@four %
    \fi %
    \GreNoBreak %
  \fi %
  %#4\relax 
  %\GreNoBreak 
  \relax %
}%
  %
% This macro typesets a flat on the height provided by #1. #2 is not used yet, but it
% will determine if the flat has zero width or not. #3 and #4 should be the same as GreGlyph's #5 and #6, but it's not really done nor useful...

\def\GreFlat#1#2{%
  \gre@alteration{#1}{\gre@fontchar@flat}{\gre@fontchar@flathole}{#2}%
  \relax%
}%

% Same as the one before, but for naturals.

\def\GreNatural#1#2{%
  \gre@alteration{#1}{\gre@fontchar@natural}{\gre@fontchar@naturalhole}{#2}%
  \relax%
}%

% Same as the one before, but for sharps.

\def\GreSharp#1#2{%
  \gre@alteration{#1}{\gre@fontchar@sharp}{\gre@fontchar@sharphole}{#2}%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for typesetting punctum cavum
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\gre@fontchar@punctumcavum{\gregoriofont\GreCPPunctumCavum}%
\def\gre@fontchar@lineapunctumcavum{\gregoriofont\GreCPLineaPunctumCavum}%
\def\gre@fontchar@punctumcavumhole{\gregoriofont\GreCPPunctumCavumHole}%
\def\gre@fontchar@lineapunctumcavumhole{\gregoriofont\GreCPLineaPunctumCavumHole}%

\def\gresetpunctumcavum#1{%
  \IfStrEq{#1}{alternate}%
    {%
      \grechangeglyph{PunctumCavum}{greciliae}{.caeciliae}%
      \grechangeglyph{LineaPunctumCavum}{greciliae}{.caeciliae}%
      \grechangeglyph{PunctumCavumHole}{greciliae}{.caeciliae}%
      \grechangeglyph{LineaPunctumCavumHole}{greciliae}{.caeciliae}%
    }%
    {\IfStrEq{#1}{normal}%
      {%
        \greresetglyph{PunctumCavum}%
        \greresetglyph{LineaPunctumCavum}%
        \greresetglyph{PunctumCavumHole}%
        \greresetglyph{LineaPunctumCavumHole}%
      }%
      {\gre@error{Unrecognized option for \protect\gresetpunctumcavum}}%
    }%
}%	


\def\UseAlternatePunctumCavum{%
  \gre@deprecated{\protect\UseAlternatePunctumCavum}{\protect\gresetpunctumcavum{alternate}}%
  \gresetpunctumcavum{alternate}%
}%

\def\UseNormalPunctumCavum{%
  \gre@deprecated{\protect\UseNormalPunctumCavum}{\protect\gresetpunctumcavum{normal}}%
  \gresetpunctumcavum{normal}%
}%

\def\gre@char@cavum#1#2#3#4#5#6#7#8{%
  \setbox\gre@box@temp@width=\hbox{#7}%
  \global\gre@dimen@lastglyphwidth=\wd\gre@box@temp@width %
  \gre@skip@temp@four = \gre@dimen@lastglyphwidth%
  \kern\gre@skip@temp@four %
  #4\relax %
  \kern-\gre@skip@temp@four %
  \gre@calculate@glyphraisevalue{#1}{0}%
  \ifgre@hidepclines%
    \gre@fillhole{#8}%
  \fi %
  \GreGlyph{#7}{#1}{#2}{#3}{}{#5}{#6}%
  %\relax %
}%

\def\GrePunctumCavum#1#2#3#4#5#6{%
  \gre@char@cavum{#1}{#2}{#3}{#4}{#5}{#6}%
  {\gre@fontchar@punctumcavum}{\gre@fontchar@punctumcavumhole}%
}%

\def\GreLineaPunctumCavum#1#2#3#4#5#6{%
  \gre@char@cavum{#1}{#2}{#3}{#4}{#5}{#6}%
  {\gre@fontchar@lineapunctumcavum}{\gre@fontchar@lineapunctumcavumhole}%
}%

\def\GrePunctumCavumInclinatum#1#2#3#4#5#6{%
  \gre@char@cavum{#1}{#2}{#3}{#4}{#5}{#6}%
  {\gregoriofont\GreCPPunctumCavumInclinatum}{\gregoriofont\GreCPPunctumCavumInclinatumHole}%
}%

\def\GrePunctumCavumInclinatumAuctus#1#2#3#4#5#6{%
  \gre@char@cavum{#1}{#2}{#3}{#4}{#5}{#6}%
  {\gregoriofont\GreCPPunctumCavumInclinatumAuctus}{\gregoriofont\GreCPPunctumCavumInclinatumAuctusHole}%
}%
