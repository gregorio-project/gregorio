%GregorioTeX file.
%Copyright (C) 2007-2013 Elie Roux <elie.roux@telecom-bretagne.eu>
%
%This program is free software: you can redistribute it and/or modify
%it under the terms of the GNU General Public License as published by
%the Free Software Foundation, either version 3 of the License, or
%(at your option) any later version.
%
%This program is distributed in the hope that it will be useful,
%but WITHOUT ANY WARRANTY; without even the implied warranty of
%MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%GNU General Public License for more details.
%
%You should have received a copy of the GNU General Public License
%along with this program.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

%%%%%%%%%%%%%%%%%%%
%% engine checking
%%%%%%%%%%%%%%%%%%%

\expandafter\ifx\csname RequirePackage\endcsname\relax%
  \input ifluatex.sty%
  \input luatexbase.sty%
  \input luaotfload.sty%
  \input graphicx.sty % for \resizebox
  \input xstring.sty%
  \def\greerror#1{\errmessage{GregorioTeX error: #1}}%
  \def\gre@warning#1{\message{GregorioTeX warning: #1}}%
\else%
  \RequirePackage{ifluatex}%
  \RequirePackage{graphicx}% for \resizebox
  \RequirePackage{luatexbase}%
  \RequirePackage{luaotfload}%
  \RequirePackage{xstring}%
  \def\greerror#1{\PackageError{GregorioTeX}{#1}{}}%
  \def\gre@warning#1{\PackageWarning{GregorioTeX}{#1}}%
\fi%

\ifluatex\else%
  \greerror{Error: this document must be compiled with LuaTeX (lualatex)}%
\fi%

% Since TeXLive 2009, the extra primitives of LuaTeX have a luatex prefix, and are not
% available without prefix. We mostly rely on \directlua that is still available
% without prefix, but we also rely on the Omega primitives, that have a luatex 
% prefix in TeXLive 2009.

\let\grelocalleftbox\luatexlocalleftbox%
\let\grelocalrightbox\luatexlocalrightbox%
% an attribute we put on the text nodes.
% if it is 1, it means that there may be a dash here if this syllable is at the end of a line
% if it is 2, it means that it's never useful to typeset a dash
% if it is 0, it just means that we are in a score...
\newluatexattribute\gregorioattr%
\def\greunsetattribute{\unsetluatexattribute{\gregorioattr}}%

% an attribute used for translation centering
\newluatexattribute\gregoriocenterattr%

\RequireLuaModule{gregoriotex}%

% The general version of GregorioTeX (we mean by that the "API", the way
% Gregorio will write things)
\xdef\gregoriotexversion{\directlua{tex.write(gregoriotex.get_greapiversion())}}%

% the version of the internal files (all must have the same)
\xdef\greinternalversion{\directlua{tex.write(gregoriotex.get_greapiversion())}} % date format
\directlua{gregoriotex.check_version(\number\greinternalversion)}%

% first some macros to allow checks for version:
% #1 is the name of the file
% #2 is the version
\def\gredeclarefileversion#1#2{%
  \ifnum\number#2=\number\greinternalversion\else %
    \greerror{uncoherent file versions: gregoriotex.tex is in version \number\greinternalversion \space\space while #1 is in version \number#2}%
  \fi %
}%

% macro called by scores
% #1 is the version of GregorioTeX the score is made for.
\def\gregoriotexapiversion#1{%
  \ifnum\number#1=\number\gregoriotexversion\else %
    \greerror{GregorioTeX is in version \number\gregoriotexversion \space\space while a score you included requires version \number#1. Please recompile your scores}%
  \fi %
}%

%%%%%%%%%%%%%%%%%%%%%%%%
%% aux file definitions
%%%%%%%%%%%%%%%%%%%%%%%%

% for now, we only use an aux file with LuaTeX

\ifluatex%
  \newwrite\Greaux%
\fi%

\def\grewriteaux#1{%
  \write\Greaux{#1}%
  \relax %
}%

\def\opengreaux{%
  \openout\Greaux \jobname .gaux\relax%
}%

\def\closegreaux{%
  \closeout\Greaux %
}%


%%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%%

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
% at the beginning it is set to 0, but if it is still 0 when begingregorianscore is called, it is set to the default value : 17 (the value that makes it look like a standard graduale)
\newcount\grefactor%
\grefactor=17%

%%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%%

\input gregoriotex-spaces.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for additionnal vertical spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%macro to call if you want to go to the next line simply
\def\grenewline{%
  \grenewlinecommon{0}{0}{0}{0}{0}%
  \relax%
}%

% macro called to go to the next line but when there are additional vertical spaces to add
%% 1: can be 0, 1 or 2 or 3. 1 is when there is a note above the 4th line, 2 when there is a note on the 5th line, and 3 when there is a note above the 5th line
%% 2: idem, but with the bottom line (-1th). It can be 4, in the case of a bottom note with a vertical episemus.
%% 3: 1 if there is a translation somewhere
% #4 is if 1 if we have space above the staff
\def\grenewlinewithspace#1#2#3#4{%
  \grenewlinecommon{#1}{#2}{#3}{0}{#4}%
  \relax%
}%


% basically same macros as above, but these one do a \hfill, the lines are not justified
%macro to call if you want to go to the next line simply
\def\grenewparline{%
  \grenewlinecommon{0}{0}{0}{1}{0}%
  \relax%
}%

\def\grenewparlinewithspace#1#2#3#4{%
  \grenewlinecommon{#1}{#2}{#3}{1}{#4}%
}%

% a macro describing a kern to make before ending the line, which we sometimes want (see \syllable)
\xdef\grekernbeforeeol{0pt\relax}%

% the macro we call each time we force a changing of line, it automatically sets \greknownline, and adjusts left spaces
\def\grenewlinecommon#1#2#3#4#5{%
  \ifnum\greblockcusto=1\relax\ifnum\greinsidediscretionary=0\relax %
     \grelocalrightbox{}%
  \fi\fi %
  % sometimes we need to add a space before ending the line:
  \gre@temp = \grekernbeforeeol\relax%
  \kern\gre@temp %
  \ifnum\greboxing=0\relax %
    \ifnum\grebiginitial=1\relax %
      \ifcase\greknownline %
      % 0: should not happend...
      \or % 1
        \greadjustsecondline %
      \or %2
        \greadjustthirdline %
      \fi %
    \fi %
    \global\advance\greknownline by 1\relax %
    \gre@calculate@additionalspaces{#1}{#2}%
    \ifnum#3 = 1\relax %
      \greaddtranslationspace %
    \else %
      \greremovetranslationspace %
    \fi %
    \ifnum#5 = 1\relax %
      \greaddspaceabove %
    \else %
      \greremovespaceabove %
    \fi %
    \global\grelastoflinecount=2\relax %
    \ifnum\greinsidediscretionary=0\relax %
      \greupdateleftbox %
    \fi %
    \ifnum#4=1\relax %
      \hfill %
    \fi %
    \grepenalty{-10001}%
  \fi %
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% macro that sets \gre@tempwidth to the width of its argument

\newbox\GreTempwidth%

\def\grewidthof#1{%
  \setbox\GreTempwidth=\hbox{#1}%
  \global\gre@tempwidth=\wd\GreTempwidth%
  \relax%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\GreInitial%


% grebiginitial means that the inital takes two lines
\newcount\grebiginitial%

% greknownline is the line we think we are in
\newcount\greknownline%

% macro to call before the call of \initial
\def\gresetbiginitial{%
  \global\grebiginitial=1\relax %
  \relax %
}%

% macro to cancel before the call of \initial
\def\grenormalinitial{%
  \global\grebiginitial=0\relax %
  \relax %
}%

% macro to call before the first syllable, but after setinitialclef
\def\greadjustsecondline{%
  \gre@additionalleftspace=\gre@initialwidth %
  \greupdateleftbox %
  \relax %
}%

% macro to call during the second line
\def\greadjustthirdline{%
  \gre@additionalleftspace= 0 pt%
  \greupdateleftbox %
  \relax %
}%

\def\greupdateleftbox{%
  \greupdatelinewidth %
  \greupdatelinesclef %
}%

\def\greupdatelinewidth{%
  \ifdim\gre@additionalleftspace=0pt%
  \else %
    \gre@tempdim=\gre@stafflinewidth %
    \global\advance\gre@stafflinewidth by -\gre@additionalleftspace %
    \gregeneratelines %
    \global\gre@stafflinewidth=\gre@tempdim %
  \fi %
}%

\def\greinitial#1{%
  % see comments on this function to see what it does
  \gre@calculate@aboveinitialraise %
  % we print the initial always at the same place, and the we print the GreAboveinitialfirstbox  centered
  % first we print the initial
  \gre@tempdim=-\gre@textlower %
  % if it is a big initial we print it on the second line 
  \ifnum\grebiginitial=0\relax %
    \setbox\GreInitial=\hbox{\greinitialformat{#1}}%
    \ifdim\gre@manualinitialwidth=0 pt\relax%
      \global\gre@initialwidth=\wd\GreInitial %
    \else%
      \greinitialformat{\global\gre@initialwidth=\gre@manualinitialwidth}%
    \fi%
    \ifdim\wd\GreAboveinitialfirstbox>\gre@initialwidth\relax%
      \global\gre@initialwidth=\wd\GreAboveinitialfirstbox%
    \fi%
    \ifdim\wd\GreAboveinitialsecondbox>\gre@initialwidth\relax%
      \global\gre@initialwidth=\wd\GreAboveinitialsecondbox%
    \fi%
    \setbox\GreInitial=\hbox to \gre@initialwidth {\hss\raise -\gre@tempdim\hbox{\greinitialformat{#1}}\hss}%
  \else %
    \advance\gre@tempdim by \gre@additionalbottomspace %
    \advance\gre@tempdim by \gre@spacebeneathtext %
    \advance\gre@tempdim by \gre@spacelinestext %
    \advance\gre@tempdim by 4\gre@interstafflinespace %
    \advance\gre@tempdim by 4\gre@stafflineheight %
    \advance\gre@tempdim by \gre@currenttranslationheight %
    \setbox\GreInitial=\hbox{\grebiginitialformat{#1}}%
    \ifdim\gre@manualinitialwidth=0 pt\relax%
      \global\gre@initialwidth=\wd\GreInitial %
    \else%
      \grebiginitialformat{\global\gre@initialwidth=\gre@manualinitialwidth}%
    \fi%
    \ifdim\wd\GreAboveinitialfirstbox>\gre@initialwidth\relax%
      \global\gre@initialwidth=\wd\GreAboveinitialfirstbox%
    \fi%
    \ifdim\wd\GreAboveinitialsecondbox>\gre@initialwidth\relax%
      \global\gre@initialwidth=\wd\GreAboveinitialsecondbox%
    \fi%
    \setbox\GreInitial=\hbox{\vbox to 0pt{\hbox to \gre@initialwidth {\hss\raise -\gre@tempdim\hbox{\grebiginitialformat{#1}}\hss}\vss}}%
  \fi %
  \ifnum\grebiginitial=0\relax%
    \greinitialformat{\global\gre@temp = \gre@beforeinitialshift}%
  \else%
    \grebiginitialformat{\global\gre@temp = \gre@beforeinitialshift}%
  \fi%
  \hskip\gre@temp %
  \global\advance\gre@initialwidth by \gre@temp %
  \copy\GreInitial%
  \ifnum\grebiginitial=0\relax%
    \greinitialformat{\global\gre@temp = \gre@afterinitialshift}%
  \else%
    \grebiginitialformat{\global\gre@temp = \gre@afterinitialshift}%
  \fi%
  \hskip\gre@temp %
  \global\advance\gre@initialwidth by \gre@temp%
  % then we center the first box above the initial, if there is one
  \ifdim\wd\GreAboveinitialfirstbox=0 pt\relax %
  \else %
    \gre@tempdim=\gre@initialwidth %
    \advance\gre@tempdim by -\wd\GreAboveinitialfirstbox  %
    \divide\gre@tempdim by 2 %
    \gre@temp = -\gre@initialwidth%
    \hskip\gre@temp %
    \kern\gre@tempdim %
    \raise\gre@aboveinitialfirstraise\copy\GreAboveinitialfirstbox  %
    \kern\gre@tempdim %
    \setbox\GreAboveinitialfirstbox=\hbox{}%
  \fi %
  % then we center the second box above the initial, if there is one
  \ifdim\wd\GreAboveinitialsecondbox=0 pt\relax %
  \else %
    \newskip\gre@tempdim%
    \gre@tempdim=\gre@initialwidth %
    \advance\gre@tempdim by -\wd\GreAboveinitialsecondbox %
    \divide\gre@tempdim by 2 %
    \gre@temp = -\gre@initialwidth%
    \hskip\gre@temp %
    \kern\gre@tempdim %
    \raise\gre@aboveinitialsecondraise\copy\GreAboveinitialsecondbox %
    \kern\gre@tempdim %
    \setbox\GreAboveinitialsecondbox=\hbox{}%
  \fi %
  \relax %
}%

\def\grenoinitial{%
  \setbox\GreInitial=\hbox{}%
  \global\gre@initialwidth=0pt %
  \global\grelastoflinecount=2\relax %
  \relax %
}%

% We set two boxes for the two lines above the initial

\newbox\GreAboveinitialfirstbox%
\newbox\GreAboveinitialsecondbox%
% the height difference between the bottom of the first annotation line and the top of the second annotation line (above the initial) is controlled by the \gre@aboveinitialseparation space, in gregoriotex-spaces.tex

\def\gresetfirstlineaboveinitial#1#2{%
  % we align the top of the box with the top of the line
  % here the variables are a bit strange... we can calculate the final value of greaboveinitialfirstraise only after the beginning of the score, after the call to this macro. So we just set greaboveinitialfirstraise to the negative value the #2 will add, and then, after the beginning of the score, we'll add gresetaboveinitialraise that will... set greaboveinitialfirstraise.
  \setbox\GreAboveinitialfirstbox=\hbox{#2}%
  \global\gre@aboveinitialfirstraise=-\ht\GreAboveinitialfirstbox %
  \global\setbox\GreAboveinitialfirstbox=\hbox{#1}%
  \relax %
}%

\def\gresetfirstannotation#1{%
  \gresetfirstlineaboveinitial{#1}{#1}%
  \relax %
}%

\let\setfirstannotation\gresetfirstannotation%

\def\gresetsecondannotation#1{%
  \setbox\GreAboveinitialsecondbox=\hbox{#1}%
  \global\gre@aboveinitialsecondraise=-\ht\GreAboveinitialsecondbox %
  \global\advance\gre@aboveinitialsecondraise by -\gre@aboveinitialseparation %
  \relax %
}%

\let\setsecondannotation\gresetsecondannotation%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the score reference (unused)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grescorereference#1{}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\writemode#1{%
  \gresetfirstlineaboveinitial{\sc{\bf{#1}}}{\sc{\bf{#1}}}%
  \relax %
}%

\def\gregorianmode#1{%
  \ifhbox \GreAboveinitialfirstbox%
    \relax%
  \else%
    \ifcase#1%
    \or%
      \writemode{I}%
    \or%
      \writemode{II}%
    \or%
      \writemode{III}%
    \or%
      \writemode{IV}%
    \or%
      \writemode{V}%
    \or%
      \writemode{VI}%
    \or%
      \writemode{VII}%
    \or%
      \writemode{VIII}%
    \fi%
  \fi%
  \relax%
}%

\def\scorereference#1{%
  \relax%
}%

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\grebeginnotes{%
  \gredrawfirstlines %
  %%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
  \grelocalleftbox{%
    \copy\GreLines %
  }%
  \relax %
}%

\def\commentary#1{%
  \vbox{\hfill\hbox{#1}}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macro for putting text above lines for annotations and the like
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% format for text above the lines
\def\greabovelinestextstyle#1{%
#1\relax %
}%

% set space above the text lines - almost the same as for the translation
\def\greaddspaceabove{%
	\greabovelinestextstyle{%
		\global\gre@currentabovelinestextheight=\gre@abovelinestextheight %
		\gregeneratelines %
	}%
	\relax %
}%

% we don't need space above any more
\def\greremovespaceabove{%
  \global\gre@currentabovelinestextheight=0 sp%
  \gregeneratelines %
  \relax %
}%

% the code is a bit strange here: we always execute \gre@spaceabovelines at the beginning of a glyph. This will:
%  - typeset the text above the lines if relevant, and making sure we execute it only once
%  - not do anything else

\xdef\grecurrenttextabovelines{}%

\def\gresettextabovelines#1{%
  \gdef\grecurrenttextabovelines{%
    \gretypesettextabovelines{#1}%
    \gdef\grecurrenttextabovelines{}%
    \relax %
  }%
}%

% typesets the text above the line
\def\gretypesettextabovelines#1{%
  \greabovelinestextstyle{\gre@tempdim=\gre@abovelinestextraise} %
  \advance\gre@tempdim by 4\gre@stafflineheight %
  \advance\gre@tempdim by 4\gre@interstafflinespace %
  \advance\gre@tempdim by \gre@spacebeneathtext %
  \advance\gre@tempdim by \gre@currenttranslationheight %
  \advance\gre@tempdim by \gre@spacelinestext %
  \advance\gre@tempdim by \gre@additionalbottomspace %
  \leavevmode\raise\gre@tempdim\hbox to 0pt{\greabovelinestextstyle{#1}\hss}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% first a macro to prevent the typesetting of the lines (useful for some people)
\xdef\greremovelinescount{0}%

\def\greremovelines{%
  \xdef\greremovelinescount{1}%
  \relax %
}%

\def\gredonotremovelines{%
  \xdef\greremovelinescount{0}%
  \relax %
}%

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\gredrawfirstlines{%
  \advance\gre@stafflinewidth by -\gre@initialwidth%
%  \advance\gre@stafflinewidth by -\gre@minimalspaceatlinebeginning
  %\gre@initialwidth=0pt
  \hbox to 0pt{%
    \vbox{%
      \grenormalstafflinesformat %
      \vskip\gre@currentabovelinestextheight %
      \vskip\gre@additionaltopspace %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \vskip\gre@spacelinestext %
      \vskip\gre@spacebeneathtext %
      \vskip\gre@currenttranslationheight %
      \vskip\gre@additionalbottomspace %
    }%
    \hss%
  }%
  \gre@stafflinewidth=\gre@linewidth%
  \relax%
}%

%% box containing the stafflines for other lines than the first
\newbox\GreLines%

% macro that must be called at each change of linewidth and grefactor
\def\gregeneratelines{%
  \setbox\GreLines=\hbox to 0pt{%
    \vbox{%
      \grenormalstafflinesformat %
      \vskip\gre@spaceabovelines %
      \vskip\gre@currentabovelinestextheight %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \gre@temp = \gre@interstafflinespace%
      \kern\gre@temp %
      \ifnum\greremovelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \vskip\gre@spacelinestext %
      \vskip\gre@additionalbottomspace %
      \vskip\gre@spacebeneathtext %
      \vskip\gre@currenttranslationheight %
    }%
    \hss%
  }%
  \relax %
}%

% macro called when the initial is big, and so when the second line is at the same level as the first
\def\gresmallsecondline{%
  \gre@tempdim=\gre@stafflinewidth %
  \global\advance\gre@stafflinewidth by -\gre@initialwidth %
  \gregeneratelines %
  \global\gre@stafflinewidth=\gre@tempdim %
  \relax %
}%

% macro called when we are after the second line of a big initial, to have normal lines back
\def\grenormallines{%
  \global\gre@stafflinewidth=\gre@linewidth %
  \gregeneratelines %
  \relax %
}%

\input gregoriotex-chars.tex%

\input gregoriotex-signs.tex%

\input gregoriotex-syllable.tex%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the translations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\xdef\gretranslationcenteringscheme{0}%

\def\setgretranslationcenteringscheme#1{%
  \xdef\gretranslationcenteringscheme{\number #1}%
}%

\xdef\grenlbintranslation{0}%

\def\gresetnlbintranslation#1{%
  \xdef\grenlbintranslation{\number #1}%
}%

\def\grewritetranslation#1{%
  \ifnum\gretranslationcenteringscheme=0\relax %
    \raise\gre@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gretranslationformat{#1}\hss}}}%
  \else %
    \gre@tempdim=\wd\GreSyllabletext %
    \setbox\GreTempwidth=\hbox{#1}%
    \advance\gre@tempdim by -\wd\GreTempwidth %
    \divide\gre@tempdim by 2\relax %
    \kern\gre@tempdim %
    \raise\gre@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gretranslationformat{#1}\hss}}}%
    \kern-\gre@tempdim %
  \fi %
}%

\def\grewritetranslationwithcenterbeginning#1{%
  \ifnum\grenlbintranslation=1\relax %
    \grebeginnlbarea{0}{1}%
  \fi %
  \gregoriocenterattr=1\relax %
  \raise\gre@spacebeneathtext\hbox to 0pt{\kern 0pt\vbox to 0pt{\vss\hbox to 0pt{\gretranslationformat{#1}\hss}}\kern 0pt}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}%

\xdef\gremustdotranslationcenterend{0}%

\def\gretranslationcenterend{%
  \xdef\gremustdotranslationcenterend{1}%
  \relax %
}%

\def\gredotranslationcenterend{%
  \ifnum\grenlbintranslation=1\relax %
    \greendnlbarea{0}{1}%
  \fi %
  \gregoriocenterattr=2\relax %
  \raise\gre@spacebeneathtext\hbox to 0pt{}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the chironomic signs lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% here is a quite special macro called at beggining of lines, that inserts a line of chironomic signs
\def\greinsertchiroline{%
  % the first line is a special case
  \ifnum\greknownline=1\relax %
    % some bugs appear if we don't box it
    \hbox{\directlua{grechiro.printLine()}}%
    \par %
    % TODO: this line bugs with my version of LuaTeX
    %\grenobreak 
    \gre@temp = \gre@belowsignsspace%
    \kern\gre@temp %
    %\grenobreak 
    \noindent %
  \else %
    % not very beaufiful, I don't like to make a new par inside a score, but....
    \grelocalleftbox{}%
    \grelocalrightbox{}%
    \par %
    \gre@temp = \gre@abovesignsspace%
    \kern\gre@temp %
    \noindent\hbox{\directlua{grechiro.printLine()}}%
    \greupdateleftbox %
    \par %
    \grenobreak%
    \gre@temp = \gre@belowsignsspace%
    \kern\gre@temp %
    \grenobreak %
    \noindent %
  \fi %
  \relax %
}%

%macro to call just after begingregorioscore, if there are some chironomic signs
\def\greactivatechironomy{%
  % we print the absolute position of the beginning of the score, and the width of a line, to get the absolute positions of the begginning and end of lines
  \pdfsavepos %
  \grewriteaux{begin:\number\pdflastxpos}%
  \grewriteaux{width:\number\gre@stafflinewidth}%
  \RequireLuaModule{gregoriotex-ictus}%
  \directlua{grechiro.atBeginScore()}%
\fi %
}%

% count that is 1 or 0 if we need to print the small vertical bars in the chironomic line
\newcount\printchirovbars%
\printchirovbars=1%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% gregorioattr (see its definition in gregorio-syllable) is 0 when we are in a score, and unset when we are not

%macro called at the beginning of a score
\def\begingregorioscore{%
  % not sure it's perfect to put that here, but it's the only way I found to make it work....
	\setgregoriofont{\gregoriofontname}%
	\ifnum\greusestylefont=1\relax %
		\gresetstylefont %
	\fi %
	\grecancelpenalties %
	\gredofinetuning %
	\gregorioattr=0\relax %
	\xdef\greexhyphencharsave{\the\exhyphenchar}%
	\exhyphenchar=-1\relax %
	\gregeneratelines %
	\noindent%
	\directlua{gregoriotex.atScoreBeggining()}%
	%TODO do something like LaTeX's AtBeginDocument
	\ifdefined\optgabcAtScoreBeginning %
		\optgabcAtScoreBeginning %
	\fi %
	\global\greknownline=1\relax %
	\relax%
}%

%macro called at the end of a score
\def\endgregorioscore{%
  \global\grelastoflinecount=0\relax %
  \global\greblockcusto=0\relax %
  \ifnum\grenlbstate=0\else %
    \greendnlbarea{2}%
  \fi %
  \grelocalleftbox{}%
  \ifnum\keeprightbox=0\relax %
    \grelocalrightbox{}%
  \fi %
  \hfil %
  \par %
  \ifnum\keeprightbox=1\relax %
    \global\keeprightbox=0\relax %
  \fi%
  \greunsetattribute %
  % with some versions of LuaTeX, the \localrightbox and \localleftbox must be set empty in an environment with the good attributes set
  \grelocalleftbox{}%
  \grelocalrightbox{}%
  \setbox\GreAboveinitialfirstbox=\hbox{}%
  \gre@calculate@additionalspaces{0}{0}%
  \global\gre@currentabovelinestextheight=0 sp%
  \greremovetranslationspace %
  \grenormalinitial %
  \grerestorepenalties %
  \greendfinetuning %
  \exhyphenchar=\greexhyphencharsave %
  \directlua{gregoriotex.atScoreEnd()}%
  \relax%
}%

% macro to call when there is just a little thing that will go to the last line,
% when it is not necessary
% It doesn't seem to be used, so it's a good candidate for deprecation!
\def\grenolastline{%
  \ifdim\gre@enddifference > 0 pt %
    \ifdim\gre@nextbegindifference > 0 pt %
      \gre@temp = \gre@interwordspacenotes%
      \hskip\gre@temp %
    \else % (next begin difference >0pt)
      \gre@temp = \gre@interwordspacenotestext%
      \hskip\gre@temp %
    \fi %
  \else%(enddifference < Opt)
    \ifdim\gre@nextbegindifference < 0 pt %
      \gre@temp = \gre@interwordspacetext%
      \hskip\gre@temp %
    \else %(next begin difference < 0 pt)
      \gre@temp = \gre@interwordspacetextnotes%
      \hskip\gre@temp %
    \fi %
  \fi %
  \global\greendofscore=1 %
  \grelocalrightbox{}%
  \grelocalleftbox{}%
  \penalty{\grenolastlinepenalty }%
  \relax%
}%

% macro called at each end of word
\def\greendofword#1{%
  \grepenalty{\greendofwordpenalty }%
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@temp = \gre@interwordspacenotes%
        \grehskip\gre@temp %
      \else % (next begin difference >0pt)
        \gre@temp = \gre@interwordspacenotestext%
        \grehskip\gre@temp %
      \fi %
    \else %(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@temp = \gre@interwordspacetext%
        \grehskip\gre@temp %
      \else %(next begin difference < 0 pt)
        \gre@temp = \gre@interwordspacetextnotes%
        \grehskip\gre@temp %
      \fi %
    \fi %
  \fi %
  %\global\gre@enddifference=0pt 
  \relax%
}%

% macro called at the end of a word or syllable when the next thing is a bar
\def\greendbeforebar#1{%
  \grenobreak %
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@temp = \gre@notebarspace%
        \grehskip\gre@temp %
      \else % (next begin difference >0pt)
        \gre@temp = \gre@textbartextspace%
        \grehskip\gre@temp %
      \fi %
    \else%(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@temp = \gre@textbartextspace%
        \grehskip\gre@temp %
      \else %(next begin difference < 0 pt)
        \gre@temp = \gre@interwordspacetextnotes%
        \grehskip\gre@temp %
      \fi %
    \fi %
  \fi %
  \grenobreak %
  %\global\gre@enddifference=0pt 
  \relax %
}%

% macro called at the end of a bar. Almost the same, but not for the penalties
\def\greendafterbar#1{%
  \grepenalty{\greendafterbarpenalty }\relax %
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@temp = \gre@notebarspace%
        \grehskip\gre@temp %
      \else % (next begin difference >0pt)
        \gre@temp = \gre@textbartextspace%
        \grehskip\gre@temp %
      \fi %
    \else%(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@temp = \gre@textbartextspace%
        \grehskip\gre@temp %
      \else %(next begin difference < 0 pt)
        \gre@temp = \gre@interwordspacetextnotes%
        \grehskip\gre@temp %
      \fi %
    \fi %
  \fi %
  %\grepenalty{\greendafterbarpenalty }\relax 
  %\global\gre@enddifference=0pt 
  \relax %
}%

\newcount\grelastoflinecount%

% TODO: case where we're at the beginning *and* end of a line... quite rare case though...
% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf if written in plainTeX)
% 0 if nothing
% 1 if the syllable is the last of the line
% 2 after it has finished the syllable, so when it is two it means that the syllable is the first of a line
\def\grelastofline{%
  \global\grelastoflinecount=1\relax%
  \relax%
}%

% same as above, but for the score. For now it is the same behaviour.
\def\grelastofscore{%
%  \grelocalleftbox{}% For an unknown reason, if I uncomment this line, the
%  blank line removing algorithm (in lua) will let some blank space after the
%  last line... (see bug #20953)
  \greblockcustos %
  \global\grelastoflinecount=1\relax%
  \relax%
}%

% a macro to disable (or reenable) the left shift for first syllables of scores
\edef\gredisableeolshifts{0}%

\def\GreDisableEOLShifts{%
  \xdef\gredisableeolshifts{1}%
}%

\def\GreEnableEOLShifts{%
  \xdef\gredisableeolshifts{0}%
}%

% a count that is 1 if we block the custo, and 0 if we don't. We just block custos at the end of a score, to prevent a bug.
\newcount\greblockcusto%

% macro to suppress the custos
\def\greblockcustos{%
  \global\greblockcusto=1\relax %
  \grelocalrightbox{}%
  \relax %
}%

% macro called at each end of syllable which is not an end of word
\def\greendofsyllable{%
  \grepenalty{\greendofsyllablepenalty }%
  \relax%
}%

% macro to end elements, #1 is the type of space, it can be : 
%% 0: default space 
%% 1: larger space
%% 2: glyph space
%% 3: zero-width space
% #2 is if the space is unbreakable (1) or not (0)

\def\greendofelement#1#2{%
  \ifnum #2=0\relax %
    \grepenalty{\greendofelementpenalty}%
  \else %
    \grenobreak %
  \fi %
  \ifcase#1%
    \gre@temp = \gre@interelementspace%
    \grehskip\gre@temp %
  \or% case 1
    \gre@temp = \gre@largerspace%
    \grehskip\gre@temp %
  \or% case 2
    \gre@temp = \gre@glyphspace%
    \grehskip\gre@temp %
  \fi%
  \ifnum #2=1\relax %
    \grenobreak %
  \fi %
\relax%
}%

% macro to end a glyph without ending the element, argument is the type of space, it can be : 
%% 0: default space 
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 7: space between a punctum inclinatum and a punctum inclinatum deminutus
%% 8: space between two puncta inclinata deminuti
%% 4: space between bivirga or trivirga
%% 5: space between bistropha or tristropha
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
%% 10: space between puncta inclinata (also debilis for now), larger ambitus (range=3rd).
%% 11: space between puncta inclinata (also debilis for now), larger ambitus (range=4th or more)
\def\greendofglyph#1{%
  \grenobreak %
  \ifcase#1%
    \gre@temp = \gre@interglyphspace%
    \grehskip\gre@temp %
  \or% case 1
    \gre@temp = \gre@zerowidthspace%
    \grehskip\gre@temp %
  \or% case 2
    \gre@temp = \gre@alterationspace%
    \grehskip\gre@temp %
  \or% case 3
    \gre@temp = \gre@punctuminclinatumshift%
    \grehskip\gre@temp %
  \or% case 4
    \gre@temp = \gre@bitrivirspace%
    \grehskip\gre@temp %
  \or% case 5
    \gre@temp = \gre@bitristrospace%
    \grehskip\gre@temp %
  \or% case 6
    \gre@temp = \gre@spaceaftersigns%
    \grehskip\gre@temp %
  \or% case 7
    \gre@temp = \gre@punctuminclinatumanddebilisshift%
    \grehskip\gre@temp %
  \or% case 8
    \gre@temp = \gre@punctuminclinatumdebilisshift%
    \grehskip\gre@temp %
  \or% case 9
    \gre@temp = \gre@beforepunctainclinatashift%
    \grehskip\gre@temp %
  \or% case 10
    \gre@temp = \gre@punctuminclinatumbigshift%
    \grehskip\gre@temp %
  \or% case 11
    \gre@temp = \gre@punctuminclinatummaxshift%
    \grehskip\gre@temp %
  \fi%
  \grenobreak %
  \relax%
}%

% The different states of line break areas:
% 0: not currently in a no line break area
% 1: no line break area due tu translation centering
% 2: no line break area due to <nlba> tag
\xdef\grenlbstate{0}%

% first argument is if if the nlba is starting in neumes or not
% second argument is if it is called from translation centering or not
\def\grebeginnlbarea#1#2{%
  \xdef\grenlbinitialstate{\grenlbstate}%
  \ifnum#2=0\relax %
    \xdef\grenlbstate{2}%
  \else %
      \ifcase\grenlbstate %
        \xdef\grenlbstate{1}%
      \or %
        \xdef\grenlbstate{1}%
      \or %
        \xdef\grenlbstate{2}%
      \fi %
  \fi %
  \ifnum\grenlbinitialstate=0\relax %
      \xdef\grenobreakpenaltysave{\grenobreakpenalty }%
      \xdef\grenobreakpenalty{10001}%
      \xdef\grenolastlinepenaltysave{\grenolastlinepenalty }%
      \xdef\grenolastlinepenalty{10001}%
      \xdef\greendofwordpenaltysave{\greendofwordpenalty }%
      \xdef\greendofwordpenalty{10001}%
      \xdef\greendofsyllablepenaltysave{\greendofsyllablepenalty }%
      \xdef\greendofsyllablepenalty{10001}%
      \xdef\greendafterbarpenaltysave{\greendafterbarpenalty }%
      \xdef\greendafterbarpenalty{10001}%
      \xdef\greendafterbaraltpenaltysave{\greendafterbaraltpenalty }%
      \xdef\greendafterbaraltpenalty{10001}%
      \xdef\greendofelementpenaltysave{\greendofelementpenalty }%
      \xdef\greendofelementpenalty{10001}%
      \xdef\grehyphenpenaltysave{\grehyphenpenalty }%
      \xdef\grehyphenpenalty{10001}%
  \fi %
}%

\def\greendnlbarea#1#2{%
  \xdef\grenlbinitialstate{\grenlbstate}%
  \ifnum#2=0\relax %
    \xdef\grenlbstate{0}%
  \else %
      \ifcase\grenlbstate %
        \xdef\grenlbstate{0}%
      \or %
        \xdef\grenlbstate{0}%
      \or %
        \xdef\grenlbstate{2}%
      \fi %
  \fi %
  % if grenlbstate is not 0, then nothing should happend
  \ifnum\grenlbstate=0\relax %
    \ifnum\grenlbinitialstate=0\else %
      \xdef\grenobreakpenalty{\grenobreakpenaltysave }%
      \xdef\grenolastlinepenalty{\grenolastlinepenaltysave}%
      \xdef\greendofwordpenalty{\greendofwordpenaltysave}%
      \xdef\greendofsyllablepenalty{\greendofsyllablepenaltysave}%
      \xdef\greendafterbarpenalty{\greendafterbarpenaltysave}%
      \xdef\greendafterbaraltpenalty{\greendafterbaraltpenaltysave}%
      \xdef\greendofelementpenalty{\greendofelementpenaltysave}%
      \xdef\grehyphenpenalty{\grehyphenpenaltysave}%
      \ifcase #1\relax %
        \grepenalty{\greendofelementpenalty}%
      \or %
        \grepenalty{\greendofsyllablepenalty}%
      \or %
    % end of score, no penalty needs to be added
      \fi %
    \fi %
  \fi %
}%

\input gregoriotex-symbols.tex%

%%%%%%%%%
%% fonts
%%%%%%%%%

\def\gretilde{%
  \ensuremath{\sim}%
  \relax %
}%

\def\greitalic#1{%
  {\it #1}%
%  \relax 
}%

\def\gresmallcaps#1{%
  {\sc #1}%
  \relax %
}%

\def\grebold#1{%
  {\bf #1}%
  \relax %
}%

\let\greboldfont\grebold%

\def\grett#1{%
  {\tt #1}%
  \relax %
}%

\def\greul#1{%
  {#1}%
  \relax %
}%

\def\grecolored#1{%
  {#1}%
  \relax %
}%



% the default gregorio font
\xdef\gregoriofontname{greciliae}%

\def\setgregoriofont#1{%
  \xdef\gregoriofontname{#1}%
  \gretempdimcount = \the\grefactor %
  \multiply\gretempdimcount by 100000 %
  \global\font\gregoriofont="name:#1" at \the\gretempdimcount sp%
  \relax%
}%

\xdef\greusestylefont{0}%

% gregoriostylefont is the font used for additional glyphs
\def\gresetstylefont{%
  \gretempdimcount = \the\grefactor %
  \multiply\gretempdimcount by 100000\relax %
  \global\font\gregoriostylefont="name:greextra" at \the\gretempdimcount sp%
  \relax%
}%

\def\gretranslationformat#1{%
  \greitalic{#1}%
  \relax %
}%

\def\grenormalstafflinesformat{%
  \relax %
}%

\def\greadditionalstafflinesformat{%
  \relax %
}%

\def\GreSetStaffLinesFormat#1{%
  \global\def\greadditionalstafflinesformat{#1\relax }%
  \global\def\grenormalstafflinesformat{#1\relax }%
  \relax %
}%

\def\greinitialformat#1{%
  \font\grefontofinitial=pncr at 40pt%
  {\grefontofinitial #1}%
  \relax %
}%

\def\grebiginitialformat#1{%
  \font\grefontofgrebiginitial=pncr at 80pt%
  {\grefontofgrebiginitial #1}%
  \relax %
}%

\def\setgrefactor#1{%
	\ifnum#1<0\relax%
		\greerror{\protect\grefactor\space must be a positive integer.}%
	\else%
		\gre@changedimenfactor{\grefactor}{#1}%
		\global\grefactor=#1\relax %
		\gre@computespaces %
		\gregeneratelines %
		\setgregoriofont{\gregoriofontname}%
		\ifnum\greusestylefont=1\relax %
			\gresetstylefont %
		\fi %
	\fi%
	\relax %
}%

%%%%%%%%%%%%%%%%%%%
%% score including
%%%%%%%%%%%%%%%%%%%

% BOOL to track whether to force the recompiling of gabc files or not.
\newif\if@gabcforcecompile%

% User macro to force gregriotex to recompile gabc files. Useful for when there
% are changes to gregoriotex but the GREGORIOTEX API VERSION is not changed.
\def\forcegabccompile{%
  \@gabcforcecompiletrue%
}%

% User macro to let gregoriotex auto recompile gabc files as necessary.
% Intended to be used in the main tex file to revert the previous macro.
\def\normalgabccompile{%
  \@gabcforcecompilefalse%
}%

% The primary macro that includes a score. The lua function check that:
%  -- The gtex file exists.
%  -- The gtex file is of the correct gregoriotexapi_version.
%  -- The gtex file is 'newer' than it's corresponding gabc file.
% If either test fails, the gabc file is (re)compiled.
%
% If the \recompilegabc macro is in effect, pass true to the lua function.
% This forces gregoriotex to recompile the gabc file.

\def\gre@includescore#1{%
  \if@gabcforcecompile%
    \directlua{gregoriotex.include_score([[#1]], true)}%
  \else%
    \directlua{gregoriotex.include_score([[#1]], nil)}%
  \fi%
  \relax%
}%

\ifdefined\includetexscore%
	\gre@warning{\protect\includetexscore\space is deprecated. \MessageBreak Use \protect\includescore\space instead.}%
\else%
	\def\includetexscore#1{%
		\gre@includescore{#1}%
	}%
\fi%
\def\greincludetexscore#1{%
	\gre@warning{\protect\greincludedtexscore\space is deprecated.\MessageBreak Use \protect\includescore\space instead.}%
	\gre@includescore{#1}%
}%

\ifdefined\includegabcscore%
	\gre@warning{\protect\includegabcscore\space is deprecated.\MessageBreak Use \protect\includescore\space instead.}%
\else%
	\def\includegabcscore#1{%
		\gre@includescore{#1}%
	}%
\fi%
\def\greincludegabcscore#1{%
	\gre@warning{\protect\greincludedgabcscore\space is deprecated.\MessageBreak Use \protect\includescore\space instead.}%
	\gre@includescore{#1}%
}%

% A macro that passes the score directly to TeX without performing the API version check or if the gabc was modified since the creation of the gtex file.
\def\gre@includescorewithoption[#1]#2{%
  \input #2%
  \relax%
}%

% The main macro used by the user to input scores into the document.

\def\includescore{\@ifnextchar[{\gre@includescorewithoption}%
    {\gre@includescore}%
}%

% If called without the optional argument: '\includescore{Antiphon}'
% the filename will be passed to the lua function 'include_score'
% which will check: whether the gtex file exists, if the API version
% of the gtex file, or if the gabc file is newer than the gtex
% file. If one of these tests fails, the gabc file will be
% (re)compiled.
% The argument may or may not include a file extension. These are all valid:
% '\includescore{Antiphon}' or '\includescore{Antiphon.gabc}' or
% '\includescore{Antiphon.gtex}'

% If called with the optional argument: '\includescore[f]{Antiphon.gtex}'
% the gtex file will be forced into the document and will not be
% checked by the lua function 'include_score'. This does not bypass
% the API version test done by '\gregoriotexapiversion'.

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% some hyphen definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a zero-width hyphen, useful for fine tuning line endings. To input in gabc verb for example.
\def\grezerhyph{%
  \hbox to 0pt{%
  %-
  \char\the\hyphenchar\font %
  \hss %
  }%
}%

% a normal hyphen
\def\grenormalhyph{%
  %-
  \char\the\hyphenchar\font %
}%

% the definition that will be always used for end of lines hyphens in gregorio, except if one of the two before is explicitely used
\let\grehyph\grenormalhyph %

% two macros to change the definition of the hyphen:
\def\GreUseNormalHyphen{%
  \global\let\grehyph\grenormalhyph %
}%

\def\GreUseZeroHyphen{%
  \global\let\grehyph\grezerhyph %
}%
