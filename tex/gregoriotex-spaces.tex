%GregorioTeX file.
%
% Copyright (C) 2007-2015 The Gregorio Project (see CONTRIBUTORS.md)
%
% This file is part of Gregorio.
%
% Gregorio is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% Gregorio is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Gregorio.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions of spaces

\gre@declarefileversion{gregoriotex-spaces.tex}{4.0.0-beta}% GREGORIO_VERSION

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for tuning penalties
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% The following macros enable users to tune penalties used in Gregorio

% penalty to force a break on a new line
\xdef\grenewlinepenalty{-10001}%
\def\greforcebreak{\grepenalty{\grenewlinepenalty}}%

% penalty to prevent a line break
\xdef\grenobreakpenalty{10001}%
\def\grenobreak{\grepenalty{\grenobreakpenalty}}%

% called in \grenolastline (seems deprecated...)
\xdef\grenolastlinepenalty{100}%

% penalty at the end of a syllable which is the end of a word
\xdef\greendofwordpenalty{-100}%

% penalty at the end of a syllable which is not the end of a word
\xdef\greendofsyllablepenalty{-50}%

% penalty at the end of a syllable which is just a bar, with something printed
% under it
\xdef\greendafterbarpenalty{-200}%

% penalty right after a bar with nothing printed
\xdef\greendafterbaraltpenalty{-200}%

% penalty at the end of a breakable neumatic element (typically at a space
% between elements)
\xdef\greendofelementpenalty{-50}%

% hyphenpenalty will be used in discretionaries, in Gregorio this is used for
% a bar with clef change for example. It also set \exhyphenpenalty. It should
% be close to \greendafterbarpenalty
\xdef\grehyphenpenalty{-200}%

% broken penalty is the vertical penalty inserted after a break on a clef change
% I'm not sure it should be set, but it might be useful...
\xdef\grebrokenpenalty{0}%

%% The following macros cancel some useless penalties, and reinstances them
%% at the end of a score

\def\grecancelpenalties{%
  \xdef\grehyphenpenaltysave{\the\hyphenpenalty }%
  \xdef\greexhyphenpenaltysave{\the\exhyphenpenalty }%
  \xdef\gredoublehyphendemeritssave{\the\doublehyphendemerits }%
  \xdef\grefinalhyphendemeritssave{\the\finalhyphendemerits }%
  \xdef\grebrokenpenaltysave{\the\brokenpenalty }%
  \hyphenpenalty=\grehyphenpenalty\relax %
  \exhyphenpenalty=\grehyphenpenalty\relax %
  \doublehyphendemerits=0\relax %
  \finalhyphendemerits=0\relax %
  \brokenpenalty=\grebrokenpenalty\relax %
}%

\def\grerestorepenalties{%
  \hyphenpenalty=\grehyphenpenaltysave %
  \exhyphenpenalty=\greexhyphenpenaltysave %
  \doublehyphendemerits=\gredoublehyphendemeritssave %
  \finalhyphendemerits=\grefinalhyphendemeritssave %
  \brokenpenalty=\grebrokenpenaltysave %
}%

%% These macro enable the tuning of linepenalty, tolerance, pretolerance
%% and emergencystretch

% the macros to be modified by the users, 
\def\grelooseness{\looseness}%
\def\gretolerance{\tolerance}%
% Workaround for bug 842 (http://tracker.luatex.org/view.php?id=842)
% see http://tug.org/pipermail/luatex/2013-July/004516.html
\ifnum\the\luatexversion < 80\relax %
  \global\def\grepretolerance{-1}%
\else %
  \global\def\grepretolerance{\pretolerance}%
\fi %
\def\greemergencystretch{\emergencystretch}%
\def\grewidowpenalty{\widowpenalty}%
\def\greclubpenalty{\clubpenalty}%

% macro called at ea
\def\gredofinetuning{%
  \xdef\greloosenesssave{\the\looseness}%
  \xdef\gretolerancesave{\the\tolerance}%
  \xdef\grepretolerancesave{\the\pretolerance}%
  \xdef\greemergencystretchsave{\the\emergencystretch}%
  \xdef\grewidowpenaltysave{\the\widowpenalty}%
  \xdef\greclubpenaltysave{\the\clubpenalty}%
  \looseness=\grelooseness %
  \tolerance=\gretolerance %
  \pretolerance=\grepretolerance %
  \emergencystretch=\greemergencystretch %
  \widowpenalty=\grewidowpenalty %
  \clubpenalty=\greclubpenalty %
}%

\def\greendfinetuning{%
  \looseness=\greloosenesssave %
  \tolerance=\gretolerancesave %
  \pretolerance=\grepretolerancesave %
  \emergencystretch=\greemergencystretchsave %
  \widowpenalty=\grewidowpenaltysave %
  \clubpenalty=\greclubpenaltysave %
}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Independent default distances are defined in gsp-default.tex.  The distances defined here are calculated from those distances.

%%%%%%%%%%%%%%%%%
%% Global distances
%%%%%%%%%%%%%%%%%

% textlower is the height of the separation between the bottom line (which is invisible : for the notes which are very low) and the bottom of the text
\newdimen\gre@dimen@textlower%
\def\gre@calculate@textlower{%
  \gre@dimen@textlower=\gre@dimen@spacebeneathtext%
  %\advance\gre@dimen@textlower by \translationheight
}%

% stafflinewidth is the width of a line of staff, this can vary, for example at the first line
\newdimen\gre@dimen@stafflinewidth%
\def\gre@calculate@stafflinewidth{%
  \gre@dimen@stafflinewidth=\gre@dimen@linewidth %
}%


% linewidth is the width of a line of a score (including the initial)
\newdimen\gre@dimen@linewidth%
\def\gre@calculate@linewidth{%
  \gre@dimen@linewidth=\hsize %
}%

% Messing with the staff line thickness directly is messy, so we provide the following interface to make life easier on the user:
% stafflineheight is the height of a staff line
% = 1500 * stafflinefactor
\newdimen\gre@dimen@stafflineheight%
\def\gre@calculate@stafflineheight{%
  \global\gre@dimen@stafflineheight=1500 sp%
  \global\multiply\gre@dimen@stafflineheight by \gre@stafflinefactor\relax %
}%

% interstafflinespace is the space between two lines of staff
% = (30000 - (stafflineheight/grefactor - 1500)) * grefactor = 31500 * grefactor - stafflineheight
\newdimen\gre@dimen@interstafflinespace%
\def\gre@calculate@interstafflinespace{%
  \global\gre@dimen@interstafflinespace=31500sp%
  \global\multiply\gre@dimen@interstafflinespace by \grefactor%
  \global\advance\gre@dimen@interstafflinespace by -\gre@dimen@stafflineheight %
}%

% a distance to help place glyphs when the lines are not their default thickness
% = (stafflineheight/grefactor - 1500sp)/2 * grefactor
\newdimen\gre@dimen@stafflinediff%
\def\gre@calculate@stafflinediff{%
  \global\gre@dimen@stafflinediff = \gre@dimen@stafflineheight %
  \global\divide\gre@dimen@stafflinediff by \grefactor\relax%
  \global\advance\gre@dimen@stafflinediff by -1500sp%
  \global\divide\gre@dimen@stafflinediff by 2\relax %
  \global\multiply\gre@dimen@stafflinediff by \the\grefactor %
}%

% the default factor
% the stafflinefactor follows the same scale as the grefactor, i.e. a stafflinefactor corresponds to the default staff line thickness for grefactor 17, stafflinefactor 34 corresponds to the default staff line thickness for grefactor 34, etc.
\xdef\gre@stafflinefactor{17}%
% flag for whether the stafflinefactor should scale with changes of the grefactor
\xdef\gre@scale@stafflinefactor{1}%

% a macro for setting the thickness of the staff lines.  This changes the stafflinefactor and then adjusts the spaces that are affected by the thicker staff lines.
\def\grechangestafflinethickness#1{%
  \xdef\gre@stafflinefactor{#1}%
  \relax %
}%

\def\setstafflinethickness{%
  \gre@deprecated{\protect\setstafflinethickness}{\protect\grechangestafflinethickness}%
  \grechangestafflinethickness%
}%

\def\gresetstafflinefactor#1{%
  \gre@obsolete{\protect\gresetstafflinefactor}{\protect\grechangestafflinethickness}%
}%

%constantglyphraise is the space between the 0 of the gragorian fonts and the effective 0 of the TeX score
\newdimen\gre@dimen@constantglyphraise %
% to calculate that, we take the bottom of the third line : it is at 200 in the fonts, and it must be at grespacelinestext + grespacebeneathtext + 2*greinterstafflinespace + 2*grestafflineheight + translationheight
\def\gre@calculate@constantglyphraise{%
  \global\gre@dimen@constantglyphraise = -22000 sp%
  \global\multiply\gre@dimen@constantglyphraise by \the\grefactor %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@additionalbottomspace %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@spacebeneathtext %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@spacelinestext %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@interstafflinespace %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@interstafflinespace %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@stafflineheight %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@stafflineheight %
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@currenttranslationheight %
  % an adjustment in the case of big lines
  \global\advance\gre@dimen@constantglyphraise by \gre@dimen@stafflinediff %
  \relax %
}%

%% Here is the function to compute some more vertical spaces from the basic values
\newdimen\gre@dimen@staffheight%
\def\gre@calculate@staffheight{%
  \global\gre@dimen@staffheight = 4\gre@dimen@stafflineheight %
  \global\advance\gre@dimen@staffheight by 3\gre@dimen@interstafflinespace %
  %\global\multiply{\gre@dimen@spacebeneathtext} by \grefactor % uncomment it if you want
  % something else than 0
  \relax %
}%

% A routine that simply aggregates the above global space calculating routines so we can easily update all when needed.
%% Note: It used to be that some distance calculating functions called others.  Since this can create problems with circularity if one is not careful, this is no longer the case.  Now all distance calculating functions simply calculate their respective distance.  This means that dependent distances are not necessarily recalculated when an individual distance is recalculated.  This function updates all global calculated distances and in the order needed for the dependencies.
%% Dependencies:
%% textlower: spacebeneathtext
%% linewidth: hsize
%% stafflinewidth: linewidth
%% stafflineheight: stafflinefactor & grefactor
%% interstafflinespace: stafflineheight & grefactor
%% stafflinediff: stafflineheight & grefactor
%% staffheight: stafflineheight & interstafflinespace
%% constantglyphraise: grefactor, additionalbottomspace, spacebeneathtext, spacelinestext, interstafflinespace, stafflineheight, currenttranslationheight, stafflinediff
\def\gre@computespaces{%
  \gre@calculate@textlower%
  \gre@calculate@linewidth%
  \gre@calculate@stafflinewidth%
  \gre@calculate@stafflineheight%
  \gre@calculate@interstafflinespace%
  \gre@calculate@stafflinediff%
  \gre@calculate@staffheight%
  \gre@calculate@constantglyphraise%
}%

\newskip\gre@skip@syllablefinalskip

%% @desc Macro computing the skip at the end of the syllable
%% @arg#1 0 if end of syllable, 1 if end of word
%% @arg#2 0 if next syllable is normal, 1 if it's a bar
%%
%% @uses \gre@dimen@enddifference
%% @uses \gre@dimen@nextbegindifference
%%
%% Pseudo-code: 
%%  min_text_dist = same_word ? 0 : space_inter_words
%%  if (no_txt_under_prev) :
%%     tmp = cur_end_diff > 0 ? 0 : -cur_end_diff
%%     min_text_dist = max(min_text_dist, tmp)
%%  min_notes_dist = space_between_notes
%%  if (barres sur cur ou barres sur next):
%%     min_notes_dist = space_between_bars
%%  % space between end of syllable and current point for previous note
%%  cur_dist_notes = cur_dist_text = 0
%%  if (cur_end_diff < 0):
%%     cur_dist_text += -cur_end_diff
%%  else:
%%     cur_dist_notes += cur_end_diff
%%  if (next_begin_diff < 0):
%%     cur_dist_notes += -next_begin_diff
%%  else:
%%     cur_dist_text += next_begin_diff
%%  min_shift_text = min_dist_text - cur_dist_text
%%  min_shift_notes = min_dist_notes - cur_dist_notes
%%  shift = max(min_shift_text, min_shift_notes)
\def\gre@compute@syllablefinalskip#1#2{%
  \let\gre@minTextDistance\gre@skip@temp@one %
  \let\gre@minNotesDistance\gre@skip@temp@two %
  \let\gre@curTextDistance\gre@dimen@temp@three %
  \let\gre@curNotesDistance\gre@dimen@temp@four %
  \let\gre@minShiftText\gre@skip@temp@three %
  \let\gre@minShiftNotes\gre@skip@temp@four %
%%  min_text_dist = prev_cur_word ? 0 : space_inter_words
  \ifnum#1=1\relax %
    \ifgre@in@euouae %
      \gre@minTextDistance=\gre@skip@interwordspacetext@euouae %
    \else %
      \gre@minTextDistance=\gre@skip@interwordspacetext %
    \fi %
  \else %
    \gre@minTextDistance=0pt%
  \fi %
  \gre@debugmsg{syllablespacing}{ minTextDistance = \the\gre@minTextDistance}%
%%  if (no_txt_under_prev) :
%%     tmp = -cur_end_diff < 0 ? 0 : -cur_end_diff
%%     min_text_dist = max(min_text_dist, tmp)
  \ifgre@notextprev %
    \gre@skip@temp@two=-\gre@dimen@enddifference %
    \ifdim\gre@skip@temp@two < 0pt%
      \gre@skip@temp@two = 0pt%
    \fi %
    \ifdim\gre@skip@temp@two > \gre@minTextDistance %
      \gre@minTextDistance = \gre@skip@temp@two %
    \fi %
  \fi %
  \gre@debugmsg{syllablespacing}{ minTextDistance = \the\gre@minTextDistance}%
  % setting minNotesDistance (quite simple)
  \ifnum#2=1\relax %
    \gre@minNotesDistance=\gre@skip@notebarspace %
  \else %
    \ifnum#1=1\relax %
      \ifgre@in@euouae %
        \gre@minNotesDistance=\gre@skip@interwordspacenotes@euouae %
      \else %
        \gre@minNotesDistance=\gre@skip@interwordspacenotes %
      \fi %
    \else %
      \gre@minNotesDistance=\gre@skip@intersyllablespacenotes %
    \fi %
  \fi %
  \gre@debugmsg{syllablespacing}{ minNotesDistance = \the\gre@minNotesDistance}%
  % determining current distance between notes and
  % next notes, and current distance between text and next text
  \gre@curTextDistance=0pt%
  \gre@curNotesDistance=0pt%
%%  cur_dist_notes = cur_dist_text = 0
%%  if (cur_end_diff < 0):
%%     cur_dist_notes += -cur_end_diff
%%  else:
%%     cur_dist_text += cur_end_diff
%%  if (next_begin_diff < 0):
%%     cur_dist_notes += -next_begin_diff
%%  else:
%%     cur_dist_text += next_begin_diff
  \gre@debugmsg{syllablespacing}{ enddifference = \the\gre@dimen@enddifference}%
  \gre@debugmsg{syllablespacing}{ nextbegindifference = \the\gre@skip@nextbegindifference}%
  \ifdim\gre@dimen@enddifference < 0 pt%
    \gre@curNotesDistance = -\gre@dimen@enddifference %
  \else %
    \gre@curTextDistance = \gre@dimen@enddifference %
  \fi %
  \ifdim\gre@skip@nextbegindifference < 0 pt%
    \advance\gre@curNotesDistance by -\gre@skip@nextbegindifference %
  \else %
    \advance\gre@curTextDistance by \gre@skip@nextbegindifference %
  \fi %
  \gre@debugmsg{syllablespacing}{ curNotesDistance = \the\gre@curNotesDistance}%
  \gre@debugmsg{syllablespacing}{ curTextDistance = \the\gre@curTextDistance}%
%%  min_shift_text = min_dist_text - cur_dist_text
%%  min_shift_notes = min_dist_notes - cur_dist_notes
%%  shift = max(min_shift_text, min_shift_notes)
  \gre@minShiftText = \gre@minTextDistance %
  \advance\gre@minShiftText by - \gre@curTextDistance %
  \gre@minShiftNotes = \gre@minNotesDistance %
  \advance\gre@minShiftNotes by - \gre@curNotesDistance %
  \gre@debugmsg{syllablespacing}{ minShiftNotes = \the\gre@minShiftNotes}%
  \gre@debugmsg{syllablespacing}{ minShiftText = \the\gre@minShiftText}%
  \ifdim\gre@minShiftNotes < \gre@minShiftText %
    \global\gre@skip@syllablefinalskip = \gre@minShiftText %
    \gre@debugmsg{syllablespacing}{ syllablefinalskip = \the\gre@minShiftText}%
  \else %
    \global\gre@skip@syllablefinalskip = \gre@minShiftNotes %
    \gre@debugmsg{syllablespacing}{ syllablefinalskip = \the\gre@minShiftNotes}%
  \fi %
  \relax %
}

% dimen keeping the shift computed with next function
\newdimen\gre@dimen@bolshift

%% @desc Macro used in \GreSyllable. Sets \gre@skip@bolshift to the left kern that
%%       should appear at the beginning of a line in case of a forced linebreak.
%%       The goal of this left kern is to have all lines aligned on notes. See
%%       TODO for details.
%%
%% @arg#1 \gre@dimen@begindifference of the first syllable of the line
%% @arg#2 not sure about it... to be removed?
\def\gre@compute@bolshift#1#2{%
  % as the \gre@dimen@bolshift is computed from skips, we compute it in a
  % skip temp registry, and then "cast" it into a dimen
  \gre@skip@temp@three=\gre@skip@spaceafterlineclef %
  \advance\gre@skip@temp@three by #1%
  % a little trick... we don't want to kern more than clefwidth minus minimalspaceatlinebeginning
  \advance\gre@dimen@clefwidth by -\gre@dimen@minimalspaceatlinebeginning %
  \ifdim\gre@skip@temp@three <-\gre@dimen@clefwidth %
    \gre@skip@temp@three=-\gre@dimen@clefwidth %
  \fi %
  %% TODO: is following line really safe?
  \advance\gre@dimen@clefwidth by \gre@dimen@minimalspaceatlinebeginning %
  \advance\gre@skip@temp@three by -\gre@skip@spaceafterlineclef %
  \ifdim\gre@skip@temp@three < #1\relax %
    \gre@skip@temp@three=\the #1\relax %
  \fi %
  \ifnum#2=1\fi % keep it due to a luatex bug, fixed in TL2015, TODO: remove later
  \gre@debugmsg{bolshift}{ temp@three = \the\gre@skip@temp@three}%
  \ifdim\gre@skip@temp@three > 0pt\relax %
    \global\gre@dimen@bolshift=0pt\relax %
  \else %
    \global\gre@dimen@bolshift=\gre@skip@temp@three %
  \fi %
  \gre@debugmsg{bolshift}{ bolshift = \the\gre@dimen@bolshift}%
  \relax %
}

% dimen keeping the shift computed with next function
\newskip\gre@skip@eolshift

%% @desc Macro used in \GreSyllable. Sets \gre@skip@eolshift to the left kern that
%%       should appear before an end of line. The improvement is tiny: when
%%       text go further than notes in the last syllable of a line, the idea
%%       is to allow text to go a bit further right, under the custo.
%%       \gre@skip@eolshift should be called at the end of the last syllable of the
%%       line, just before the linebreak penalty, so that LaTeX believes the
%%       line is a bit shorter, and expands it more.
%%
%% @arg#1 The \gre@dimen@enddifference of the corresponding syllable
\def\gre@compute@eolshift#1{%
  \global\gre@skip@eolshift=0pt%
  \ifdim#1 <0pt%
    \global\gre@skip@eolshift=-#1 %
    % we don't do it if it's the last syllable of a score or if the user
    % disabled custos
    \ifgre@eolshiftsenabled %
      \ifgre@blockeolcustos\else%
        \setbox\gre@box@temp@width=\hbox{\grecustochar{\gre@pitch@g}}%
        \global\advance\gre@skip@eolshift by -\wd\gre@box@temp@width %
        \global\advance\gre@skip@eolshift by -\gre@skip@spacebeforecusto %
      \fi %
      \global\advance\gre@skip@eolshift by \gre@dimen@minimalspaceatlinebeginning %
    \fi %
    \ifdim\gre@skip@eolshift <-#1 %
      \global\gre@skip@eolshift=-#1%
    \fi %
  \fi %
}

%%%%%%%%%%%%%%%%%%%
%% Local Distances (computed as needed)
%%%%%%%%%%%%%%%%%%%

% glyphraisevalue is the value of which we must raise one glyph (that will vary with every glyph)
\newdimen\gre@dimen@glyphraisevalue %

% addedraisevalue is for the vertical episema and the puncta
\newdimen\gre@dimen@addedraisevalue%

% a very useful macro : it determines the good height of a glyph : the argument is the "number" where the glyph should be : 4 for the first line, 6 for the second, etc.
% the second argument is for the cases of signs: for example if the note is on a line, the punctummora will be above, and the auctus duplex beneath. the possible values are:
%% 0: no modification
%% 1: puts the value on the interline just above if it is on a line
%% 2: puts the value on the interline just beneath if it is on a line
%% 3: case of the vertical episemus, which is not placed at the same place if the corresponding note is on a line or not
%% 4: case of the punctum mora, for the same reason
%% 5: case of the horizontal episemus under a note, that must be placed a bit lower if the note is on a line
%% 6: case of the signs above (accentus, etc.)
%% 8: case of the punctum mora of the first note of a podatus or the 2nd note of a porrectus, etc.
%% 9: case of the horizontal episemus, that must be placed a bit lower if the note is on a line
%% 10: low choral sign not below the note
%% 11: high choral sign
%% 12: low choral sign below the note
%% 13: brace above the bars
%% 14: punctum mora in a space with a note on the line below it
\def\gre@calculate@glyphraisevalue#1#2{%
  \global\greisonaline=\number 0%
  \ifcase#1%
  % the first two cases are special cases for episemae on the lowest note
  \or\gre@count@temp@three=\number 0%
  \or\gre@count@temp@three=\number 1%
  \or\gre@count@temp@three=\number 2%
  \or\gre@count@temp@three=\number 3%
    \ifnum#2=3\relax %
    \else %
      \global\greisonaline=1 % if it is a vertical episemus, we don't care if it is on a line or not... which may cause some problems...
    \fi %
  \or\gre@count@temp@three=\number 4%
  \or\gre@count@temp@three=\number 5%
    \global\greisonaline=1 %
  \or\gre@count@temp@three=\number 6%
  \or\gre@count@temp@three=\number 7%
    \global\greisonaline=1 %
  \or\gre@count@temp@three=\number 8%
  \or\gre@count@temp@three=\number 9%
    \global\greisonaline=1 %
  \or\gre@count@temp@three=\number 10%
  \or\gre@count@temp@three=\number 11%
    \global\greisonaline=1 %
  \or\gre@count@temp@three=\number 12%
  \or\gre@count@temp@three=\number 13%
    \global\greisonaline=1 %
  \or\gre@count@temp@three=\number 14%
  % the following are only useful for horizontal episemus and rare signs
  \or\gre@count@temp@three=\number 15%
  \or\gre@count@temp@three=\number 16%
  \or\gre@count@temp@three=\number 17%
  \fi%
  % if there is not line... we don't consider notes are on lines
  \ifgre@showlines\else %
    \global\greisonaline=0 %
  \fi %
  % if the note is on a line, we change its height if necessary
  \ifcase\greisonaline\or% isonaline = 1
    \ifcase#2 %
    \or% 1
      \global\advance\gre@count@temp@three by 1%
    \or% 2
      \global\advance\gre@count@temp@three by -1%
    \or% 3
      \global\advance\gre@count@temp@three by -1%
    \or% 4
      \global\advance\gre@count@temp@three by 1%
    \or% 5
      \global\advance\gre@count@temp@three by -1%
    \or\or\or% 8
      \global\advance\gre@count@temp@three by -1%
    \or% 9
      \global\advance\gre@count@temp@three by 1%
    \or% 10
      \global\advance\gre@count@temp@three by 1%
    \or% 11
      \global\advance\gre@count@temp@three by 1%
    \or% 12
      \global\advance\gre@count@temp@three by -1%
    \fi%
  \fi%
  \global\advance\gre@count@temp@three by -8 %
  \global\gre@dimen@glyphraisevalue = 15750 sp %
  \global\multiply\gre@dimen@glyphraisevalue by \the\grefactor %
  \global\multiply\gre@dimen@glyphraisevalue by \the\gre@count@temp@three %
  \gre@dimen@addedraisevalue= 0 sp%
  \ifcase#2 % 
  \or\or\or%3: if it is a vertical episemus on a line, we shift it a bit higher, so that it's more beautiful
    \ifnum\greisonaline=1%
    \gre@dimen@addedraisevalue=7250 sp%
    \multiply\gre@dimen@addedraisevalue by \the\grefactor %
    \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \else % if it is not on a line, we shift it a bit lower
    \gre@dimen@addedraisevalue=-1380 sp%
    \multiply\gre@dimen@addedraisevalue by \the\grefactor %
    \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \fi %
  \or% 4: if it is a punctum mora on a line, we shift it a bit lower, for the same reason
    \ifnum\greisonaline=1%
      \gre@dimen@addedraisevalue=-6900 sp%
      \multiply\gre@dimen@addedraisevalue by \the\grefactor %
      \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \else % 
      \gre@dimen@addedraisevalue=-2200 sp%
      \multiply\gre@dimen@addedraisevalue by \the\grefactor %
      \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \fi%
  \or% 5: if it is a horizontal episemus under a note which is on a line, we shift it lower
    \ifnum\greisonaline=0%
      \gre@dimen@addedraisevalue=-4980 sp%
      \multiply\gre@dimen@addedraisevalue by \the\grefactor %
      \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \else % if it is under a note between two lines, we shift it higher
      \gre@dimen@addedraisevalue=4000 sp%
      \multiply\gre@dimen@addedraisevalue by \the\grefactor %
      \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \fi %
  \or% 6: if it is a sign, we put it at an arbitrary height
    \gre@dimen@addedraisevalue=20000 sp%
    \multiply\gre@dimen@addedraisevalue by \the\grefactor %
    \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
  \or\or% 8: if it is a punctum mora on a line, we shift it a bit lower, for the same reason
    \ifnum\greisonaline=1%
      \gre@dimen@addedraisevalue=5000 sp%
      \multiply\gre@dimen@addedraisevalue by \the\grefactor %
      \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
    \fi %
  \or% 9: if it is an horizontal episemus not on a line, we put it a bit lower
    \ifnum\greisonaline=1%
      \gre@dimen@addedraisevalue=-5500 sp%
    \else %
      \gre@dimen@addedraisevalue=3000 sp%
    \fi %
    \multiply\gre@dimen@addedraisevalue by \the\grefactor %
    \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
  \or% 10: low choral sign that is not lower than the note
    \global\advance\gre@dimen@glyphraisevalue by -\gre@dimen@choralsigndownshift %
  \or% 11: high choral sign
    \ifnum\greisonaline=1%
      \global\advance\gre@dimen@glyphraisevalue by \gre@dimen@choralsignupshift %
    \else %
      \global\advance\gre@dimen@glyphraisevalue by -\gre@dimen@choralsigndownshift %
    \fi %
  \or% 12: low choral sign that is lower than the note
    \ifnum\greisonaline=1%
      \global\advance\gre@dimen@glyphraisevalue by \gre@dimen@choralsignupshift %
    \else %
      \global\advance\gre@dimen@glyphraisevalue by -\gre@dimen@choralsigndownshift %
    \fi %
  \or% 13: if it is the brace above the bars, we shift it to a user-defined value
      \global\advance\gre@dimen@glyphraisevalue by -\gre@dimen@braceshift %
  \or% 14: raise the punctum mora in a space a bit higher than case 4
    \gre@dimen@addedraisevalue=200 sp%
    \multiply\gre@dimen@addedraisevalue by \the\grefactor %
    \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@addedraisevalue %
  \fi%
  \global\advance\gre@dimen@glyphraisevalue by \the\gre@dimen@constantglyphraise %
}%

% two dimensions for the additionalspaces
\newdimen\gre@dimen@additionalbottomspace%
\newdimen\gre@dimen@additionaltopspace%

% #1 is the high height
% #2 is the low height
% #3 is 1 if there is a translation somewhere
% #4 is if 1 if we have space above the staff
\def\gre@calculate@additionalspaces#1#2#3#4{%
  \gre@debugmsg{lineheight}{gre@calculate@additional@spaces called with #1 #2 #3 #4}%
  \gre@count@temp@one=#1\relax %
  \advance\gre@count@temp@one by -\gre@pitch@adjust@top\relax %
  \ifnum\gre@count@temp@one>0\relax %
    \global\gre@dimen@additionaltopspace=15000 sp%
    \global\multiply\gre@dimen@additionaltopspace by \the\gre@count@temp@one %
    \global\multiply\gre@dimen@additionaltopspace by \the\grefactor %
  \else %
    \global\gre@dimen@additionaltopspace=0 sp%
  \fi %
  \gre@count@temp@one=#2\relax %
  \advance\gre@count@temp@one by -\gre@pitch@adjust@bottom\relax %
  \multiply\gre@count@temp@one by -1\relax %
  \ifnum\gre@count@temp@one>0\relax %
    \global\gre@dimen@additionalbottomspace=15000 sp%
    \global\multiply\gre@dimen@additionalbottomspace by \the\gre@count@temp@one %
    \global\multiply\gre@dimen@additionalbottomspace by \the\grefactor %
  \else %
    \global\gre@dimen@additionalbottomspace=0 sp%
  \fi %
  \ifnum#3 = 1\relax %
    \gre@addtranslationspace %
  \else %
    \gre@removetranslationspace %
  \fi %
  \ifnum#4 = 1\relax %
    \greaddspaceabove %
  \else %
    \greremovespaceabove %
  \fi %
  \gregeneratelines %
  \gre@calculate@constantglyphraise %
  \relax %
}%

%% macro that typesets the text of the syllable, and sets textaligncenter to the middle of the middle letters, it is needed because we align the note (often the middle of the note) with the middle of the middle letters
%% third argument is 0 if it's the current syllable, 1 if it's the alignment of the following one
%% warning: gretextaligncenter is the width from the beginning of the letters to the middle of the middle letters
%% warning: value is approximative when a ligature appears

\newdimen\gre@dimen@textaligncenter%

\def\gre@calculate@textaligncenter#1#2#3{%
  \ifnum#3=0\relax%
    \grewidthof{\grefixedtextformat{#1#2}}%
  \else %
    \grewidthof{\grefixednexttextformat{#1#2}}%
  \fi %
  \global\gre@dimen@textaligncenter=\the\gre@dimen@temp@three %
  \ifnum#3=0\relax%
    \grewidthof{\grefixedtextformat{#2}}%
  \else %
    \grewidthof{\grefixednexttextformat{#2}}%
  \fi %
  \divide\gre@dimen@temp@three by 2 %
  \global\advance\gre@dimen@textaligncenter by -\the\gre@dimen@temp@three%
  \relax%
}%

% a dimen that will contain the difference between the end of the text and the end of the notes for the previous syllable (if we are in the same word) : positive if notes go further than text. We will use it for space adjustment between syllables of the same word
\newdimen\gre@dimen@enddifference%

% a dimen that will contain the enddifference of the previous glyph
\newdimen\gre@dimen@previousenddifference%

% macro to set enddifference (defined above) to \wd\gre@box@syllablenotes - (\wd\gre@box@syllabletext - textaligncenter) - notesaligncenter
% enddifference will be positive if text go further than the notes, and negative in the other case
% arguments are :
% #1: \wd\gre@box@syllablenotes : the total width of the notes
% #2: \wd\gre@box@syllabletext : the total width of the text
% #3: textaligncenter (defined above)
% #4: notesaligncenter (defined above too)
% #5: if we have to set previousenddifference or not
\def\gre@calculate@enddifference#1#2#3#4#5{%
  \ifcase#5\or %
    \global\gre@dimen@previousenddifference=\the\gre@dimen@enddifference %
  \fi %
  \global\gre@dimen@enddifference=#1%
  \global\advance\gre@dimen@enddifference by -#2%
  \global\advance\gre@dimen@enddifference by #3%
  \global\advance\gre@dimen@enddifference by -#4%
  \relax%
}%

% temporary value for space for the translation, beneath the text
\newdimen\gre@dimen@currenttranslationheight%

% macro to tell gregorio to set space for the translation
\def\gre@addtranslationspace{%
  \gre@style@translation%
  \gretranslationformat{%
    \global\gre@dimen@currenttranslationheight=\gre@dimen@translationheight %
    \global\gre@dimen@textlower=\gre@dimen@spacebeneathtext %
    \global\advance\gre@dimen@textlower by \gre@dimen@translationheight %
    \gregeneratelines %
    \gre@calculate@constantglyphraise %
  }%
  \endgre@style@translation%
  \relax %
}%

\def\gre@removetranslationspace{%
  \global\gre@dimen@currenttranslationheight=0 sp%
  \global\gre@dimen@textlower=\gre@dimen@spacebeneathtext %
  \gregeneratelines %
  \gre@calculate@constantglyphraise %
  \relax %
}%

%nextbegindifference is the begindifference of the next syllable
\newskip\gre@skip@nextbegindifference%

% macro to set nextbegindifference
%% 1 : the first letters of the next syllable
%% 2 : the middle letters of the next syllable
%% 3 : the end letters of the next syllable
%% 4 : the type of notes alignment
\def\gre@calculate@nextbegindifference#1#2#3#4{%
  %to prevent the pollution of the normal values, we stock them into a temp value
  \gre@dimen@temp@two=\gre@dimen@textaligncenter %
  \gre@calculate@textaligncenter{#1}{#2}{1}%
  \global\gre@skip@nextbegindifference=-\gre@dimen@textaligncenter %
  \global\gre@dimen@textaligncenter=\gre@dimen@temp@two %
  \gre@dimen@temp@two=\gre@dimen@notesaligncenter %
  \grefindnextnotesaligncenter{#4}% idem
  \global\advance\gre@skip@nextbegindifference by \the\gre@dimen@notesaligncenter %
  \global\gre@dimen@notesaligncenter=\gre@dimen@temp@two %
  \relax %
}%

%The distance from the baseline of the line to the baseline of the annotations
\newdimen\gre@dimen@annotationtrueraise%
% When text is placed in the annotation boxes these dimensions are initialized with values based on the contents and the user parameters
%This function sets the true raises of the two lines above the inital (it has to be called just as the boxes are placed in order to make sure that the values are all correct)
\def\gre@calculate@annotationtrueraise{%
  \gre@debugmsg{annotation}{Calculating the raise.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@staffheight %
  \gre@debugmsg{annnotation}{Added staff height.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@spacebeneathtext %
  \gre@debugmsg{annnotation}{Added space beneath text.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@currenttranslationheight %
  \gre@debugmsg{annnotation}{Added translation height.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@spacelinestext %
  \gre@debugmsg{annnotation}{Added spacelinestext.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@additionalbottomspace %
  \gre@debugmsg{annnotation}{Added additional bottom space.}%
  \global\advance\gre@dimen@annotationtrueraise by \gre@dimen@annotationraise %
  \gre@debugmsg{annnotation}{Added user raise.}%
  \relax %
}%



%%%%%%%%%%%%%%%%%%%
%% other spaces calculated elsewhere
%%%%%%%%%%%%%%%%%%%

% These distances don't have independent functions which calculate their value, generally because their calculation is distributed over multiple events.

% begindifference is the difference between the begginning of the text and the beginning of the notes. Warning : it can be negative.
\newdimen\gre@dimen@begindifference%

% the width of the clef
\newdimen\gre@dimen@clefwidth%

% the width of the last glyph
\newdimen\gre@dimen@lastglyphwidth%

% notes align center is the point of alignment for the notes
\newdimen\gre@dimen@notesaligncenter%

%this dimention is the additional space that we have to add to the localleftbox sometimes. For now it is used only for the initials on two lines
\newdimen\gre@dimen@additionalleftspace%

% the calculated width of the initial (may be actual width of letter or be forced wider under certain conditions)
\newdimen\gre@dimen@initialwidth%
\gre@dimen@initialwidth= 0 pt%

\newdimen\gre@dimen@currentabovelinestextheight%
\gre@dimen@currentabovelinestextheight = 0pt%

%% TODO: perhaps create a pair of functions which “reserve” and “release” the temporary registers in order to keep track of which ones are in use when.  There would also need to be a list of the registers currently in use.  The reserve function would then check the list to make sure the requested register isn’t already in use, throwing an error if it is and adding its name to the list if it isn’t.  It might also provide for an alias (via \let).  The release function would simply remove the register from the list of those in use.
% Register allocation is an inherently global process in TeX.  Below are the registers used within calculations on a temporary basis.
\newdimen\gre@dimen@temp@one%
\newdimen\gre@dimen@temp@two%
\newdimen\gre@dimen@temp@three%
\newdimen\gre@dimen@temp@four%
\newdimen\gre@dimen@temp@five%

\newskip\gre@skip@temp@one%
\newskip\gre@skip@temp@two %
\newskip\gre@skip@temp@three%
\newskip\gre@skip@temp@four%

\newcount\gre@count@temp@one%
\newcount\gre@count@temp@two%
\newcount\gre@count@temp@three%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dimension changing macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% This macro creates one dim (#1), setting its value to #2 and sets whether it should scale when the \grefactor changes (#3, 1 if yes, 0 if no).  While it does check that #1 can accept the kind of distance given in #2, it does not propagate the changes through the calculated distances.
%% Note: the distances created by this function are stored as strings, not skip or dimension registers.  This allows the user to specify a distance in em or ex units even though the font parameters may not be the same at the time the distance is specified and the time the distance is used.
\newif\ifchecklength%
\def\grecreatedim#1#2#3{%
  \checklengthfalse%
  %check if #2 is a rubber length (contains plus and/or minus)
  \IfSubStr{#2}{plus}{\checklengthtrue}{\relax}%
  \IfSubStr{#2}{minus}{\checklengthtrue}{\relax}%
  %if #1 is one of the distances which cannot be rubber.
  \gre@rubberpermit{#1}%
  % do we try to assign a rubber to one where it's not permitted?
  \ifrubber%
    \def\gre@prefix{skip}%
  \else%
    \ifchecklength%
      \greerror{#1 cannot be a rubber length.}%
    \else%
      \def\gre@prefix{dimen}%
    \fi%
  \fi%
  \expandafter\xdef\csname gre@scale@#1\endcsname{#3}%
  \expandafter\xdef\csname gre@\gre@prefix @#1\endcsname{#2}%
  \relax %
}%

\def\gresetdim{%
  \gre@deprecated{\protect\gresetdim}{\protect\grecreatedim}%
  \grecreatedim%
}%

% a macro for changing a dimension.  Unlike \grecreatedim, this function won’t create a new distance, just change an existing one.
\def\grechangedim#1#2#3{%
  \gre@rubberpermit{#1}%
  % figure out our prefix
  \ifrubber%
    \gre@debugmsg{spacing}{Changing a skip.}%
    \def\gre@prefix{skip}%
  \else%
    \gre@debugmsg{spacing}{Changing a dimen.}%
    \def\gre@prefix{dimen}%
  \fi%
  \ifcsname gre@\gre@prefix @#1\endcsname%
    \gre@debugmsg{spacing}{It does exist.}%
    \grecreatedim{#1}{#2}{#3}%
  \else%
    \greerror{#1 is not a recognized distance.}%
  \fi%
}%

%a macro to use if all you want to do is turn on or off the scaling for a particular distance
\def\grescaledim#1#2{%
  \IfStrEq{#2}{yes}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{1}}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{0}}%
  \IfStrEq{#2}{true}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{1}}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{0}}%
  \IfStrEq{#2}{on}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{1}}%
    {\expandafter\gdef\csname gre@scale@#1\endcsname{0}}%
}

\def\grenoscaledim#1{%
  \gre@deprecated{\protect\grenoscaledim}{\protect\grescaledim{...}{no}}%
  \expandafter\gdef\csname gre@scale@#1\endcsname{0}%
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% space configuration loading
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\GreLoadSpaceConf#1{%
  \gre@deprecated{\protect\GreLoadSpaceConf}{\protect\greloadspaceconf}%
  \greloadspaceconf{#1}%
}%

\def\greloadspaceconf#1{%
  \input gsp-#1.tex\relax %
  \ifnum\the\grefactor=\greconffactor\else %If the space configuration file is designed for a \grefactor other than the current one, then we need to rescale the distances.
    \gre@changedimenfactor{\greconffactor}{\grefactor} %
  \fi%
  \relax %
}%


% For everything to work fine the default configuration has to loaded after the gregoriotex package is completely loaded (so that all functions are well defined).  As a result you'll find that as the last line in gregoriotex-main.tex


%%%%%%%%%%%%%%
%% Rescaling dimensions (for when \grefactor changes)
%%%%%%%%%%%%%%

% This function checks to see if the length is one of the ones which cannot be a rubber length
\newif\ifrubber%
\def\gre@rubberpermit#1{%
  \rubbertrue%
  % is length one that cannot be rubber?
  \IfStrEq{#1}{additionallineswidth}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{additionalcustoslineswidth}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{zerowidthspace}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{maximumspacewithoutdash}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{afterinitialshift}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{beforeinitialshift}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{minimalspaceatlinebeginning}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{manualinitialwidth}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{annotationseparation}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{annotationraise}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{noclefspace}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{clivisalignmentmin}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{abovesignsspace}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{belowsignsspace}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{choralsigndownshift}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{choralsignupshift}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{translationheight}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{spacelinestext}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{spacebeneathtext}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{abovelinestextraise}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{abovelinestextheight}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{braceshift}{\rubberfalse}{\relax}%
  \IfStrEq{#1}{curlybraceaccentusshift}{\rubberfalse}{\relax}%
}%

%% an aux function adapting the value #1 from the factor #2 to the factor #3
%% Note: This function is assumed to touch only dimensions which are meant to scale with the \grefactor (i.e. if it acts on distance x, \gre@scale@x is 1)
\def\gre@changeonedimenfactor#1#2#3{%
  \gre@rubberpermit{#1}%
  \ifrubber% if we have a rubber allowed length we create a temporary skip
    \let\gre@scaledist\gre@skip@temp@one%
  \else% otherwise we create a temporary dimen
    \let\gre@scaledist\gre@dimen@temp@one%
  \fi%
  % Math
  \gre@rubberpermit{#1}%
  \ifrubber%
    \edef\gre@convert{\csname gre@skip@#1\endcsname}%
  \else%
    \edef\gre@convert{\csname gre@dimen@#1\endcsname}%
  \fi%
  \gre@scaledist=\gre@convert%
  \multiply \gre@scaledist by \number #3%
  \divide \gre@scaledist by \number #2%
  \gre@consistentunits{\gre@convert}{\gre@scaledist}%
  \grecreatedim{#1}{\gre@stringdist}{1}%
  \relax %
}%


% These functions are used for stripping out the units and decimal portion of a distance to make it more amenable to being used in the conversion function below
{\catcode`p=12 \catcode`t=12 \gdef\gre@makein#1.#2pt{#1}}%
{\catcode`p=12 \catcode`t=12 \gdef\gre@makenum#1pt{#1}}%

% This function converts a distance to the units indicated in #1 and returns it as a string.
\newdimen\gre@unit%
\newdimen\gre@base%
\newdimen\gre@maxlen%
\newcount\gre@unitfactor%
\newcount\gre@basefactor%
\def\gre@convertto#1#2{%
  \gre@debugmsg{general}{convertto (#1) (#2)}
  \gre@debugmsg{ifdim}{ #2 = 0pt}
  \ifdim#2=0pt\relax%
    \edef\gre@converted{0 #1}%
  \else%
    \gre@unit = 1 #1%
    \gre@base = #2%
    % Code to increase precision
    \gre@maxlen = 16383.99999pt%
    \gre@unitfactor = \number\gre@maxlen%
    \divide\gre@unitfactor by \number\gre@unit\relax%
    \ifnum\gre@unitfactor < 0\relax%
      \gre@unitfactor = -\gre@unitfactor%
    \fi%
    \gre@debugmsg{spacing}{unit: \the\gre@unit ; factor: \the\gre@unitfactor}
    \gre@basefactor = \number\gre@maxlen%
    \divide\gre@basefactor by \number\gre@base\relax%
    \ifnum\gre@basefactor < 0\relax%
      \gre@basefactor = -\gre@basefactor%
    \fi%
    \gre@debugmsg{spacing}{base: \the\gre@base ; factor: \the\gre@basefactor}
    \ifnum\gre@basefactor<\gre@unitfactor%
      \multiply\gre@unit by \gre@basefactor%
      \multiply\gre@base by \gre@basefactor%
    \else%
      \multiply\gre@unit by \gre@unitfactor%
      \multiply\gre@base by \gre@unitfactor%
    \fi%
    \gre@count@temp@one = \expandafter\gre@makein\the\gre@unit%
    \divide\gre@base by \gre@count@temp@one%
    \edef\gre@converted{%
      \expandafter\gre@makenum\the\gre@base #1%
    }%
  \fi%
}%

% This function takes a distance (#2) and formats it as a string so that its units conform to the pattern set by a string representation of a distance (#1)
\newif\ifstretch%
\newif\ifshrink%
\def\gre@consistentunits#1#2{%
  \stretchfalse%
  \shrinkfalse%
  \IfSubStr{#1}{plus}{\stretchtrue}{\relax}%
  \IfSubStr{#1}{minus}{\shrinktrue}{\relax}%
  \ifstretch%
    \ifshrink%
      %rubber with both stretch and shrink
      \StrBefore{#1}{plus}[\gre@baseunit]%
      \StrBetween{#1}{plus}{minus}[\gre@stretchunit]%
      \StrBehind{#1}{minus}[\gre@shrinkunit]%
    \else%
      %rubber with stretch only
      \StrBefore{#1}{plus}[\gre@baseunit]%
      \StrBehind{#1}{plus}[\gre@stretchunit]%
      \def\gre@shrinkunit{\relax}%
    \fi%
  \else%
    \ifshrink%
      %rubber with shrink only
      \StrBefore{#1}{minus}[\gre@baseunit]%
      \def\gre@stretchunit{\relax}%
      \StrBehind{#1}{minus}[\gre@shrinkunit]%
    \else%
      %non-rubber
      \def\gre@baseunit{#1}%
      \def\gre@stretchunit{\relax}%
      \def\gre@shrinkunit{\relax}%
    \fi%
  \fi%
  \StrDel{\gre@baseunit}{ }[\gre@baseunit]%
  \StrRight{\gre@baseunit}{2}[\gre@baseunit]%
  \StrDel{\gre@stretchunit}{ }[\gre@stretchunit]%
  \StrRight{\gre@stretchunit}{2}[\gre@stretchunit]%
  \StrDel{\gre@shrinkunit}{ }[\gre@shrinkunit]%
  \StrRight{\gre@shrinkunit}{2}[\gre@shrinkunit]%
  \gre@convertto{\gre@baseunit}{\dimexpr#2\relax}%
  \edef\gre@stringdist{\gre@converted}%
  \if\relax\gre@stretchunit\else%
    \gre@convertto{\gre@stretchunit}{\gluestretch#2}%
    \edef\gre@stringdist{\gre@stringdist plus \gre@converted}%
  \fi%
  \if\relax\gre@shrinkunit\else%
    \gre@convertto{\gre@shrinkunit}{\glueshrink#2}%
    \edef\gre@stringdist{\gre@stringdist minus \gre@converted}%
  \fi%
}%


%% this function changes all the values of the spaces (vertical and horizontal) from one factor to another
%% simply by dividing them by the old factor, and multiplying them by the new one.
% #1 is the old grefactor, #2 is the new one
\def\gre@changedimenfactor#1#2{%
  \ifnum\gre@scale@additionallineswidth=1\relax%
    \gre@changeonedimenfactor{additionallineswidth}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@additionalcustoslineswidth=1\relax%
    \gre@changeonedimenfactor{additionalcustoslineswidth}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@zerowidthspace=1\relax%
    \gre@changeonedimenfactor{zerowidthspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interglyphspace=1\relax%
    \gre@changeonedimenfactor{interglyphspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@alterationspace=1\relax%
    \gre@changeonedimenfactor{alterationspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@clefflatspace=1\relax%
    \gre@changeonedimenfactor{clefflatspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@beforelowchoralsignspace=1\relax%
    \gre@changeonedimenfactor{beforelowchoralsignspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@beforealterationspace=1\relax%
    \gre@changeonedimenfactor{beforealterationspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interelementspace=1\relax%
    \gre@changeonedimenfactor{interelementspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@largerspace=1\relax%
    \gre@changeonedimenfactor{largerspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@nabcinterelementspace=1\relax%
    \gre@changeonedimenfactor{nabcinterelementspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@nabclargerspace=1\relax%
    \gre@changeonedimenfactor{nabclargerspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@glyphspace=1\relax%
    \gre@changeonedimenfactor{glyphspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacebeforecusto=1\relax%
    \gre@changeonedimenfactor{spacebeforecusto}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacebeforesigns=1\relax%
    \gre@changeonedimenfactor{spacebeforesigns}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spaceaftersigns=1\relax%
    \gre@changeonedimenfactor{spaceaftersigns}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spaceafterlineclef=1\relax%
    \gre@changeonedimenfactor{spaceafterlineclef}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interwordspacenotes=1\relax%
    \gre@changeonedimenfactor{interwordspacenotes}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@intersyllablespacenotes=1\relax%
    \gre@changeonedimenfactor{intersyllablespacenotes}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interwordspacetext=1\relax%
    \gre@changeonedimenfactor{interwordspacetext}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interwordspacenotes@euouae=1\relax%
    \gre@changeonedimenfactor{interwordspacenotes@euouae}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@interwordspacetext@euouae=1\relax%
    \gre@changeonedimenfactor{interwordspacetext@euouae}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@bitrivirspace=1\relax%
    \gre@changeonedimenfactor{bitrivirspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@bitristrospace=1\relax%
    \gre@changeonedimenfactor{bitristrospace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@punctuminclinatumshift=1\relax%
    \gre@changeonedimenfactor{punctuminclinatumshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@beforepunctainclinatashift=1\relax%
    \gre@changeonedimenfactor{beforepunctainclinatashift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@punctuminclinatumanddebilisshift=1\relax%
    \gre@changeonedimenfactor{punctuminclinatumanddebilisshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@punctuminclinatumdebilisshift=1\relax%
    \gre@changeonedimenfactor{punctuminclinatumdebilisshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@punctuminclinatumbigshift=1\relax%
    \gre@changeonedimenfactor{punctuminclinatumbigshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@punctuminclinatummaxshift=1\relax%
    \gre@changeonedimenfactor{punctuminclinatummaxshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacearoundsmallbar=1\relax%
    \gre@changeonedimenfactor{spacearoundsmallbar}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacearoundminor=1\relax%
    \gre@changeonedimenfactor{spacearoundminor}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacearoundmaior=1\relax%
    \gre@changeonedimenfactor{spacearoundmaior}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacearoundfinalis=1\relax%
    \gre@changeonedimenfactor{spacearoundfinalis}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacebeforefinalfinalis=1\relax%
    \gre@changeonedimenfactor{spacebeforefinalfinalis}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacearoundclefbars=1\relax%
    \gre@changeonedimenfactor{spacearoundclefbars}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@textbartextspace=1\relax%
    \gre@changeonedimenfactor{textbartextspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@notebarspace=1\relax%
    \gre@changeonedimenfactor{notebarspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@maximumspacewithoutdash=1\relax%
    \gre@changeonedimenfactor{maximumspacewithoutdash}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@afterclefnospace=1\relax%
    \gre@changeonedimenfactor{afterclefnospace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@afterinitialshift=1\relax%
    \gre@changeonedimenfactor{afterinitialshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@beforeinitialshift=1\relax%
    \gre@changeonedimenfactor{beforeinitialshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@minimalspaceatlinebeginning=1\relax%
    \gre@changeonedimenfactor{minimalspaceatlinebeginning}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@manualinitialwidth=1\relax%
    \gre@changeonedimenfactor{manualinitialwidth}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@annotationseparation=1\relax%
    \gre@changeonedimenfactor{annotationseparation}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@annotationraise=1\relax%
    \gre@changeonedimenfactor{annotationraise}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@noclefspace=1\relax%
    \gre@changeonedimenfactor{noclefspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@clefchangespace=1\relax%
    \gre@changeonedimenfactor{clefchangespace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@clivisalignmentmin=1\relax%
    \gre@changeonedimenfactor{clivisalignmentmin}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@abovesignsspace=1\relax%
    \gre@changeonedimenfactor{abovesignsspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@belowsignsspace=1\relax%
    \gre@changeonedimenfactor{belowsignsspace}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@choralsigndownshift=1\relax%
    \gre@changeonedimenfactor{choralsigndownshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@choralsignupshift=1\relax%
    \gre@changeonedimenfactor{choralsignupshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@translationheight=1\relax%
    \gre@changeonedimenfactor{translationheight}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spaceabovelines=1\relax%
    \gre@changeonedimenfactor{spaceabovelines}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacelinestext=1\relax%
    \gre@changeonedimenfactor{spacelinestext}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@spacebeneathtext=1\relax%
    \gre@changeonedimenfactor{spacebeneathtext}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@abovelinestextraise=1\relax%
    \gre@changeonedimenfactor{abovelinestextraise}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@abovelinestextheight=1\relax%
    \gre@changeonedimenfactor{abovelinestextheight}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@braceshift=1\relax%
    \gre@changeonedimenfactor{braceshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@curlybraceaccentusshift=1\relax%
    \gre@changeonedimenfactor{curlybraceaccentusshift}{#1}{#2}%
  \fi%
  \ifnum\gre@scale@stafflinefactor=1\relax%
    \gre@count@temp@two = \gre@stafflinefactor%
    \multiply\gre@count@temp@two by #2\relax%
    \divide\gre@count@temp@two by #1\relax%
    \xdef\gre@stafflinefactor{\the\gre@count@temp@two}%
  \fi%
  \relax %
}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Some Macros for changing the spacing around the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Seeing as these are the distances that people will want to change the most often,
%we give them their own set of macros to make that easier.

% To change the spacing between annotations.
%First argument is distance, second is whether it should scale when \grefactor changes.
\def\setaboveinitialseparation#1#2{%
  \gre@deprecated{\protect\setaboveinitialseparation}{\protect\grechangedim\{annotationseparation\}}%
  \grechangedim{annotationseparation}{#1}{#2}%
  \relax %
}%

\def\GreSetAboveInitialSeparation#1{%
  \gre@obsolete{\protect\GreSetAboveInitialSeparation}{\protect\grechangedim\{annotationseparation\}}%
}%

%To change the space after the initial
%First argument is distance, second is whether it should scale when \grefactor changes.
\ifdefined\setspaceafterinitial%
  \greerror{\protect\setspaceafterinitial\space is already defined.  Check for package conflicts.}%
\else%
  \def\setspaceafterinitial#1#2{%
    \grechangedim{afterinitialshift}{#1}{#2}%
    \relax %
  }%
\fi%

\def\GreSetSpaceAfterInitial#1{%
  \gre@deprecated{\protect\GreSetSpaceAfterInitial}{\protect\setspaceafteriniital}%
  \setspaceafterinitial#1{1}%
}%

%To change the space before the initial
%First argument is distance, second is whether it should scale when \grefactor changes.
\ifdefined\setspacebeforeinitial%
  \greerror{\protect\setspacebeforeinitial\space is already defined.  Check for package conflicts.}%
\else%
  \def\setspacebeforeinitial#1#2{%
    \grechangedim{beforeinitialshift}{#1}{#2}%
    \relax %
  }%
\fi%

\def\GreSetSpaceBeforeInitial#1{%
  \gre@deprecated{\protect\GreSetSpaceBeforeInitial}{\protect\setspacebeforeiniital}%
  \setspacebeforeinitial#1{1}%
}%


%To change all the distances associated with the initial.
%First three arguments are distances, last is whether they should scale when \grefactor changes.
\ifdefined\setinitialspacing%
  \greerror{\protect\setinitialspacing\space is already defined.  Check for package conflicts.}%
\else%
  \def\setinitialspacing#1#2#3#4{%
    \grechangedim{beforeinitialshift}{#1}{#4}%
    \grechangedim{manualinitialwidth}{#2}{#4}%
    \grechangedim{afterinitialshift}{#3}{#4}%
    \relax%
  }%
\fi%
